# 热更新问题修复

## 问题描述
在运行 `wails dev` 时，应用进入无休止的热更新循环，导致开发体验极差。

## 问题原因
1. **数据库文件触发热更新**：`ollama-client.db` 和 `duola.dat` 文件在应用运行时被频繁写入
2. **文件监听配置不完善**：Wails 的文件监听器监听到这些运行时文件的变化，触发热更新
3. **无用文件干扰**：存在空的 `main.js` 文件可能与 `main.ts` 冲突
4. **Docker 环境特殊性**：Docker 容器中的文件系统监听需要特殊配置

## 解决方案

### 1. 数据库文件路径调整
- 将数据库文件从项目根目录移动到 `data/` 目录
- 修改 `app.go` 中的数据库文件路径配置

### 2. 完善忽略配置
更新 `wails.json` 中的忽略规则：
```json
"dev": {
  "ignores": [
    "*.db",
    "*.db*", 
    "*.log",
    "duola.dat",
    "data/**",
    "logs/**",
    "tmp/**",
    "temp/**",
    "node_modules/**",
    "frontend/node_modules/**",
    "frontend/dist/**",
    "frontend/build/**",
    "frontend/src/main.js",
    "**/.git/**"
  ]
}
```

### 3. 前端配置优化
更新 `vite.config.ts` 中的监听忽略规则（Docker 环境优化）：
```typescript
server: {
  watch: {
    usePolling: true,  // Docker 环境必需
    interval: 1000,    // 轮询间隔
    ignored: [
      '**/wailsjs/**', 
      '**/*.db*', 
      '**/*.log',
      '**/data/**',
      '**/logs/**',
      '**/tmp/**',
      '**/temp/**',
      '**/node_modules/**',
      '**/dist/**',
      '**/build/**',
      '**/.git/**',
      '**/package-lock.json',
      '**/yarn.lock',
      '**/package.json.md5'
    ]
  }
}
```

### 4. 版本控制优化
更新 `.gitignore` 文件，确保运行时文件不被版本控制。

## 修复效果
- 消除了无休止的热更新循环
- 提升了开发体验
- 保持了数据持久化功能
- 优化了项目结构

## Docker 环境运行
项目使用 Docker 容器运行开发环境：

```bash
docker run --rm \
  -v `pwd`:/project \
  -w /project/tools-ollama \
  -p 34115:34115 \
  -p 40000:40000 \
  -e DISPLAY=$DISPLAY \
  -e WEBKIT_DISABLE_COMPOSITING_MODE=1 \
  -e CHOKIDAR_USEPOLLING=1 \
  -v /tmp/.X11-unix:/tmp/.X11-unix:ro \
  -v /tmp/logs:/tmp/logs \
  wails-dev-env:1.0.7 \
  wails dev -debounce 2000 -reloaddirs ../duolasdk
```

关键环境变量：
- `CHOKIDAR_USEPOLLING=1`：启用文件轮询模式，适用于 Docker 环境
- `WEBKIT_DISABLE_COMPOSITING_MODE=1`：禁用 WebKit 合成模式，提高稳定性
- `-debounce 2000`：设置 2 秒防抖动时间

## 注意事项
1. 首次运行时会自动创建 `data/` 目录
2. 现有数据库文件需要手动移动到新位置
3. 确保 `data/` 目录有适当的读写权限
4. Docker 环境下必须使用文件轮询模式

## 相关文件
- `app.go` - 数据库路径配置
- `wails.json` - Wails 开发配置
- `frontend/vite.config.ts` - 前端构建配置
- `.gitignore` - 版本控制忽略规则