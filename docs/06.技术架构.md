# 技术架构

## 架构概述

Ollama 模型管理工具采用前后端分离的架构设计，使用 Wails 框架将 Go 后端与 Vue.js 前端整合为一个桌面应用程序。该架构充分利用了 Go 语言的高性能和 Vue.js 的响应式界面优势。

## 技术栈

### 后端技术
- **语言**：Go
- **框架**：Wails v2
- **HTTP 客户端**：duolasdk/core.HttpCli
- **数据存储**：duolasdk.AppStore (基于 SQLite)
- **事件系统**：Wails 运行时事件

### 前端技术
- **框架**：Vue.js 3 (Composition API)
- **UI 库**：Element Plus
- **状态管理**：Vue 响应式系统
- **构建工具**：Vite
- **语言**：TypeScript

### 通信协议
- **内部通信**：Wails 提供的 Go 与 JavaScript 绑定
- **外部通信**：HTTP/HTTPS 与 Ollama API 通信

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面 (Vue.js + Element Plus)          │
├─────────────────────────────────────────────────────────────┤
│                    Wails 框架绑定层                          │
├─────────────────────────────────────────────────────────────┤
│                      Go 后端逻辑                            │
├─────────────────────────────────────────────────────────────┤
│                   duolasdk 核心库                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   HTTP      │  │   Store     │  │      Logger         │  │
│  │   Client    │  │   (SQLite)  │  │                     │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                    Ollama 服务 API                          │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. App 结构体

App 是整个应用程序的核心结构体，负责协调各个组件的工作。

**主要职责**：
- 管理应用上下文
- 提供对外 API 接口
- 协调 ModelManager 和 ConfigManager
- 管理 HTTP 客户端和数据存储

### 2. ModelManager 结构体

ModelManager 负责模型相关的业务逻辑。

**主要职责**：
- 管理模型运行状态
- 处理模型操作请求（运行、停止、测试等）
- 管理模型参数配置
- 处理模型搜索逻辑

### 3. OllamaConfigManager 结构体

OllamaConfigManager 负责服务器配置管理。

**主要职责**：
- 管理本地和远程服务器配置
- 处理配置的增删改查
- 验证服务器连接状态
- 管理活动服务器设置

## 数据流设计

### 前端到后端调用流程

1. 用户在前端界面执行操作
2. Vue 组件调用通过 Wails 生成的 Go 绑定函数
3. Wails 框架将调用转发到 Go 后端对应函数
4. Go 后端函数处理业务逻辑
5. 处理结果通过 Wails 框架返回给前端
6. Vue 组件更新界面状态

### 后端到 Ollama 服务请求流程

1. Go 后端函数构建 HTTP 请求
2. 使用 duolasdk/core.HttpCli 发送请求到 Ollama 服务
3. 接收并解析 Ollama 服务响应
4. 处理响应数据并返回给前端

## 存储设计

### 存储结构

1. **模型列表缓存**
   - 键名：models_cache
   - 内容：模型列表 JSON 数据
   - 用途：提高模型列表加载速度

2. **本地服务器配置**
   - 键名：ollama_config:local
   - 内容：本地服务器 URL
   - 用途：保存本地 Ollama 服务地址

3. **远程服务器配置**
   - 键名：ollama_config:remote_servers
   - 内容：远程服务器配置数组 JSON
   - 用途：管理远程 Ollama 服务配置

4. **模型参数配置**
   - 键名：model_options_{modelName}
   - 内容：模型参数 JSON 数据
   - 用途：保存各模型的运行参数

### 存储访问模式

- 使用 duolasdk.AppStore 进行键值存储
- 基于 SQLite 实现持久化存储
- 支持字符串和 JSON 数据存储
- 提供基本的 CRUD 操作

## 状态管理

### 内存状态

1. **运行中的模型**
   - 使用全局变量 runningModels 存储
   - 记录模型名称、参数、启动时间等信息
   - 应用重启后状态丢失

2. **应用上下文**
   - 通过 Wails 提供的上下文管理
   - 用于事件发送和接收

### 持久化状态

1. **服务器配置**
   - 本地和远程服务器配置持久化存储
   - 应用重启后可恢复

2. **模型参数**
   - 模型运行参数持久化存储
   - 支持参数的保存和加载

## 事件系统

### 支持的事件

1. **model:started**
   - 模型启动时触发
   - 携带模型名称和启动时间

2. **model:stopped**
   - 模型停止时触发
   - 携带模型名称和停止时间

### 事件处理

- 使用 Wails 运行时事件系统
- 前端可监听后端触发的事件
- 实现实时状态更新

## 错误处理

### 错误分类

1. **网络错误**
   - Ollama 服务不可达
   - HTTP 请求超时
   - 网络连接中断

2. **业务错误**
   - 模型不存在
   - 模型已在运行
   - 参数不合法

3. **系统错误**
   - 存储访问失败
   - 内存不足
   - 文件权限问题

### 错误传递

- 后端函数返回 error 类型错误
- 通过 Wails 框架传递给前端
- 前端统一处理并显示错误信息

## 安全设计

### API 密钥处理

- 前端界面不直接显示密钥明文
- 存储时考虑加密处理（未来优化）
- 支持密钥的更新和删除

### 服务器验证

- 添加远程服务器时验证可达性
- 定期检查服务器状态
- 防止恶意服务器配置

### 数据安全

- 本地数据存储在用户目录下
- 避免敏感信息泄露
- 支持数据备份和恢复

## 性能优化

### 缓存策略

- 模型列表结果缓存
- 减少重复的 HTTP 请求
- 提高界面响应速度

### 异步处理

- 耗时操作异步执行
- 避免阻塞界面主线程
- 提供加载状态反馈

### 资源管理

- 合理管理 HTTP 客户端连接
- 及时释放不需要的资源
- 避免内存泄漏