# Ollama API è°ƒè¯•å™¨æ¨¡å— - API æ¥å£

## 1. Architectureï¼ˆæ¶æ„è®¾è®¡ï¼‰

### 1.1 APIæ¶æ„æ¦‚è¿°
Ollama API è°ƒè¯•å™¨é‡‡ç”¨ Wails v2 æ¡†æ¶çš„å‰åç«¯ç»‘å®šæœºåˆ¶ï¼Œé€šè¿‡Goæ–¹æ³•ç›´æ¥æš´éœ²ç»™å‰ç«¯è°ƒç”¨ã€‚åç«¯ç›´æ¥ä½¿ç”¨Goæ ‡å‡†åº“net/httpè¿›è¡ŒHTTPè¯·æ±‚ï¼Œç¡®ä¿å¯¹è¯·æ±‚çš„å®Œå…¨æ§åˆ¶ã€‚

### 1.2 é€šä¿¡æ¶æ„
```
å‰ç«¯ Vue ç»„ä»¶
    â†• (Wails æ–¹æ³•è°ƒç”¨)
Wails ç»‘å®šå±‚
    â†• (Go æ–¹æ³•)
ä¸šåŠ¡æœåŠ¡å±‚
    â†• (net/http)
Ollama API æœåŠ¡
```

### 1.3 APIè®¾è®¡åŸåˆ™
- **ç›´æ¥è°ƒç”¨**: ç»•è¿‡ä¸­é—´å°è£…ï¼Œç›´æ¥ä½¿ç”¨net/http
- **ç±»å‹å®‰å…¨**: TypeScript/Goå¼ºç±»å‹å®šä¹‰
- **é”™è¯¯ç»Ÿä¸€**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- **å®Œå…¨å¯æ§**: å‰ç«¯æ‰€è§å³åç«¯æ‰€å‘

## 2. Analysisï¼ˆéœ€æ±‚åˆ†æï¼‰

### 2.1 APIåŠŸèƒ½åˆ†æ
| åŠŸèƒ½æ¨¡å— | APIæ•°é‡ | å¤æ‚åº¦ | ä¼˜å…ˆçº§ |
|---------|---------|--------|--------|
| HTTPè¯·æ±‚å‘é€ | 1 | é«˜ | P0 |
| æœåŠ¡å™¨é…ç½®è·å– | 1 | ä½ | P0 |
| è¯·æ±‚å–æ¶ˆ | 1 | ä¸­ | P1 |
| è¯·æ±‚å†å² | 3 | ä¸­ | P2 |

### 2.2 è°ƒç”¨é¢‘ç‡åˆ†æ
- **é«˜é¢‘è°ƒç”¨**: SendHttpRequest (æ¯æ¬¡æµ‹è¯•éƒ½è°ƒç”¨)
- **ä½é¢‘è°ƒç”¨**: GetOllamaServers (åˆå§‹åŒ–æ—¶è°ƒç”¨)
- **ä¸­é¢‘è°ƒç”¨**: è¯·æ±‚å–æ¶ˆã€å†å²ç®¡ç† (ç”¨æˆ·ä¸»åŠ¨è§¦å‘)

### 2.3 æ€§èƒ½è¦æ±‚
- **å“åº”æ—¶é—´**: æ™®é€šAPI <100msï¼ŒHTTPè¯·æ±‚å–å†³äºç›®æ ‡æœåŠ¡
- **å¹¶å‘æ”¯æŒ**: æ”¯æŒå¤šä¸ªå¹¶å‘è¯·æ±‚
- **è¶…æ—¶å¤„ç†**: 30ç§’è¶…æ—¶ä¿æŠ¤

## 3. Architectureï¼ˆAPIæ¶æ„ï¼‰

### 3.1 æ ¸å¿ƒAPIæ¥å£

#### 3.1.1 SendHttpRequest
*   **åŠŸèƒ½**: æ¥æ”¶å‰ç«¯æ„å»ºçš„ `ApiRequest` å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨ Go æ ‡å‡†åº“ `net/http` å‘é€ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œå¹¶è¿”å›ä¸€ä¸ª `ApiResponse` å¯¹è±¡ã€‚
*   **æ–¹æ³•ç­¾å**:
    ```go
    func (a *App) SendHttpRequest(request types.ApiRequest) (types.ApiResponse, error)
    ```
*   **å‚æ•°**:
    *   `request`: `types.ApiRequest`ï¼ŒåŒ…å«å‰ç«¯ç”¨æˆ·æ„å»ºçš„æ‰€æœ‰è¯·æ±‚ä¿¡æ¯ã€‚
*   **è¿”å›**:
    *   `types.ApiResponse`ï¼ŒåŒ…å«å“åº”çŠ¶æ€ç ã€å“åº”å¤´ã€å“åº”ä½“ã€è¯·æ±‚è€—æ—¶å’Œå¯èƒ½çš„é”™è¯¯ä¿¡æ¯ã€‚
*   **å®ç°ç»†èŠ‚**:
    1.  **è·å– Base URL**: æ ¹æ® `request.SelectedServerID` ä» `configMgr` è°ƒç”¨ `GetServerByID` è·å–å¯¹åº”çš„ `OllamaServerConfig`ï¼Œä»è€Œå¾—åˆ° Base URLã€‚
    2.  **æ„å»ºå®Œæ•´ URL**: ä½¿ç”¨ `url.JoinPath` å’Œ `url.Parse` å°† Base URLã€API è·¯å¾„å’Œç”¨æˆ·å®šä¹‰çš„æŸ¥è¯¢å‚æ•°æ‹¼æ¥æˆæœ€ç»ˆçš„è¯·æ±‚ URLã€‚
    3.  **å‡†å¤‡è¯·æ±‚ä½“**: æ ¹æ® `request.Body.Type` (raw, formData, none)ï¼Œä½¿ç”¨ `strings.NewReader` åˆ›å»ºä¸€ä¸ª `io.Reader` ä½œä¸ºè¯·æ±‚ä½“ã€‚åŒæ—¶ï¼Œæ ¹æ®ç±»å‹ç¡®å®š `Content-Type`ã€‚
    4.  **åˆ›å»ºæ ‡å‡†è¯·æ±‚**: è°ƒç”¨ `http.NewRequestWithContext` åˆ›å»ºä¸€ä¸ª `*http.Request` å¯¹è±¡ã€‚
    5.  **è®¾ç½®è¯·æ±‚å¤´**: æ‰‹åŠ¨éå† `request.Headers`ï¼Œå¹¶å°†æ‰€æœ‰å¯ç”¨çš„è¯·æ±‚å¤´ï¼ˆåŒ…æ‹¬ä¸Šä¸€æ­¥ç¡®å®šçš„ `Content-Type`ï¼‰é€ä¸€è®¾ç½®åˆ° `req.Header` ä¸­ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯å¯¹è¯·æ±‚å¤´çš„å®Œå…¨æ§åˆ¶ã€‚
    6.  **å‘é€è¯·æ±‚**: åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„ `*http.Client`ï¼Œå¹¶è°ƒç”¨å…¶ `Do` æ–¹æ³•å‘é€è¯·æ±‚ã€‚
    7.  **å¤„ç†å“åº”**: è¯»å– `*http.Response` çš„çŠ¶æ€ç ã€å“åº”å¤´å’Œå“åº”ä½“ï¼Œè®¡ç®—æ€»è€—æ—¶ï¼Œå¹¶å°†æ‰€æœ‰ä¿¡æ¯ç»„è£…æˆ `types.ApiResponse` è¿”å›ã€‚

#### 3.1.2 GetOllamaServers
*   **åŠŸèƒ½**: è·å–æ‰€æœ‰å·²é…ç½®çš„ Ollama æœåŠ¡åˆ—è¡¨ã€‚
*   **æ–¹æ³•ç­¾å**:
    ```go
    func (a *App) GetOllamaServers() ([]types.OllamaServerConfig, error)
    ```
*   **å®ç°ç»†èŠ‚**: ç›´æ¥è°ƒç”¨ `configMgr.GetServers()`ã€‚

### 3.2 æ ¸å¿ƒä¾èµ–ç³»ç»Ÿ

#### 3.2.1 å¤–éƒ¨ä¾èµ–
*   **configMgr.GetServerByID(serverID string)**: æ ¹æ®IDè·å–å•ä¸ªæœåŠ¡å™¨é…ç½® (æ¥è‡ª ollama_config.go)
*   **Go æ ‡å‡†åº“ net/http**: ç”¨äºåˆ›å»ºã€å‘é€å’Œå¤„ç† HTTP è¯·æ±‚/å“åº”
*   **Go æ ‡å‡†åº“ net/url**: ç”¨äºæ‹¼æ¥å’Œè§£æ URL åŠæŸ¥è¯¢å‚æ•°
*   **Go æ ‡å‡†åº“ io**: ç”¨äºè¯»å–å“åº”ä½“
*   **Go æ ‡å‡†åº“ strings**: ç”¨äºåˆ›å»ºè¯·æ±‚ä½“ io.Reader

#### 3.2.2 å†…éƒ¨å·¥å…·å‡½æ•°
```go
// URLæ„å»ºå·¥å…·
func BuildURLWithQuery(baseURL, path string, queryParams map[string]string) (string, error)

// HTTPå®¢æˆ·ç«¯åˆ›å»º
func CreateHTTPClientWithTimeout(timeout time.Duration) *http.Client

// å“åº”ä½“è¯»å–
func ReadResponseBody(resp *http.Response) (string, error)

// è¯·æ±‚ä½“å¤„ç†
func ProcessRequestBody(body types.RequestBody) (io.Reader, string, error)
```

### 3.3 æ•°æ®ä¼ è¾“å¯¹è±¡

#### 3.3.1 è¯·æ±‚å¯¹è±¡
```go
// APIè¯·æ±‚ç»“æ„
type ApiRequest struct {
    Method           string          `json:"method" validate:"required,oneof=GET POST PUT DELETE HEAD PATCH OPTIONS"`
    SelectedServerID string          `json:"selectedServerId" validate:"required"`
    Path             string          `json:"path" validate:"required"`
    QueryParams      []QueryParam    `json:"queryParams"`
    Headers          []RequestHeader `json:"headers"`
    Body             RequestBody     `json:"body"`
}

// æŸ¥è¯¢å‚æ•°
type QueryParam struct {
    Key     string `json:"key"`
    Value   string `json:"value"`
    Enabled bool   `json:"enabled"`
}

// è¯·æ±‚å¤´
type RequestHeader struct {
    Key     string `json:"key"`
    Value   string `json:"value"`
    Enabled bool   `json:"enabled"`
}

// è¯·æ±‚ä½“
type RequestBody struct {
    Type           RequestBodyType      `json:"type"`
    RawContent     string               `json:"rawContent,omitempty"`
    RawContentType RawBodyContentType   `json:"rawContentType,omitempty"`
    FormData       []FormDataItem       `json:"formData,omitempty"`
}
```

#### 3.3.2 å“åº”å¯¹è±¡
```go
// APIå“åº”ç»“æ„
type ApiResponse struct {
    StatusCode        int             `json:"statusCode"`
    StatusText        string          `json:"statusText"`
    Headers           []RequestHeader `json:"headers"`
    Body              string          `json:"body"`
    RequestDurationMs int64           `json:"requestDurationMs"`
    Error             string          `json:"error,omitempty"`
}

// æœåŠ¡å™¨é…ç½®
type OllamaServerConfig struct {
    ID       string `json:"id"`
    Name     string `json:"name"`
    BaseURL  string `json:"baseUrl"`
    IsActive bool   `json:"isActive"`
}
```

## 4. Applicationï¼ˆåº”ç”¨å®ç°ï¼‰

### 4.1 å‰ç«¯APIè°ƒç”¨

#### 4.1.1 TypeScriptæ¥å£å®šä¹‰
```typescript
// Wailsç»‘å®šæ¥å£
declare global {
  interface Window {
    go: {
      main: {
        App: {
          // HTTPè¯·æ±‚å‘é€
          SendHttpRequest(request: ApiRequest): Promise<ApiResponse>;
          
          // æœåŠ¡å™¨é…ç½®è·å–
          GetOllamaServers(): Promise<OllamaServerConfig[]>;
        };
      };
    };
  }
}
```

#### 4.1.2 APIè°ƒç”¨å°è£…
```typescript
// APIè°ƒç”¨æœåŠ¡
class OllamaApiDebuggerService {
  // å‘é€HTTPè¯·æ±‚
  async sendRequest(request: ApiRequest): Promise<ApiResponse> {
    try {
      const response = await window.go.main.App.SendHttpRequest(request);
      return response;
    } catch (error) {
      throw new ApiError('è¯·æ±‚å‘é€å¤±è´¥', error);
    }
  }
  
  // è·å–æœåŠ¡å™¨åˆ—è¡¨
  async getServers(): Promise<OllamaServerConfig[]> {
    try {
      return await window.go.main.App.GetOllamaServers();
    } catch (error) {
      throw new ApiError('è·å–æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥', error);
    }
  }
}

// é”™è¯¯å¤„ç†ç±»
class ApiError extends Error {
  constructor(message: string, public cause?: any) {
    super(message);
    this.name = 'ApiError';
  }
}
```

### 4.2 åç«¯APIå®ç°

#### 4.2.1 æ ¸å¿ƒå®ç°é€»è¾‘
```go
// SendHttpRequest çš„å®Œæ•´å®ç°æµç¨‹
func (d *OllamaApiDebugger) SendHttpRequest(request types.ApiRequest) (types.ApiResponse, error) {
    var apiResponse types.ApiResponse
    startTime := time.Now()
    
    // 1. å‚æ•°éªŒè¯
    if err := d.validateRequest(request); err != nil {
        apiResponse.Error = err.Error()
        return apiResponse, nil
    }
    
    // 2. è·å–æœåŠ¡å™¨é…ç½®
    serverConfig, err := d.configMgr.GetServerByID(request.SelectedServerID)
    if err != nil {
        apiResponse.Error = fmt.Sprintf("æ— æ³•è·å–æœåŠ¡å™¨é…ç½®: %v", err)
        return apiResponse, nil
    }
    
    // 3. æ„å»ºHTTPè¯·æ±‚
    httpReq, err := d.buildHttpRequest(request, serverConfig)
    if err != nil {
        apiResponse.Error = fmt.Sprintf("æ„å»ºè¯·æ±‚å¤±è´¥: %v", err)
        return apiResponse, nil
    }
    
    // 4. å‘é€è¯·æ±‚
    client := CreateHTTPClientWithTimeout(30 * time.Second)
    resp, err := client.Do(httpReq)
    if err != nil {
        apiResponse.Error = fmt.Sprintf("è¯·æ±‚å‘é€å¤±è´¥: %v", err)
        return apiResponse, nil
    }
    defer resp.Body.Close()
    
    // 5. å¤„ç†å“åº”
    return d.processResponse(resp, time.Since(startTime))
}
```

#### 4.2.2 è¾…åŠ©æ–¹æ³•å®ç°
```go
// è¯·æ±‚éªŒè¯
func (d *OllamaApiDebugger) validateRequest(request types.ApiRequest) error {
    if request.SelectedServerID == "" {
        return errors.New("è¯·é€‰æ‹©OllamaæœåŠ¡å™¨")
    }
    if request.Method == "" {
        return errors.New("HTTPæ–¹æ³•ä¸èƒ½ä¸ºç©º")
    }
    if request.Path == "" {
        return errors.New("APIè·¯å¾„ä¸èƒ½ä¸ºç©º")
    }
    return nil
}

// æ„å»ºHTTPè¯·æ±‚
func (d *OllamaApiDebugger) buildHttpRequest(request types.ApiRequest, serverConfig types.OllamaServerConfig) (*http.Request, error) {
    // URLæ„å»º
    queryParams := make(map[string]string)
    for _, param := range request.QueryParams {
        if param.Enabled {
            queryParams[param.Key] = param.Value
        }
    }
    
    finalURL, err := BuildURLWithQuery(serverConfig.BaseURL, request.Path, queryParams)
    if err != nil {
        return nil, err
    }
    
    // è¯·æ±‚ä½“å¤„ç†
    bodyReader, contentType, err := ProcessRequestBody(request.Body)
    if err != nil {
        return nil, err
    }
    
    // åˆ›å»ºè¯·æ±‚
    req, err := http.NewRequestWithContext(d.ctx, strings.ToUpper(request.Method), finalURL, bodyReader)
    if err != nil {
        return nil, err
    }
    
    // è®¾ç½®è¯·æ±‚å¤´
    if contentType != "" {
        req.Header.Set("Content-Type", contentType)
    }
    
    for _, header := range request.Headers {
        if header.Enabled {
            req.Header.Set(header.Key, header.Value)
        }
    }
    
    return req, nil
}
```

### 4.3 é”™è¯¯å¤„ç†æœºåˆ¶

#### 4.3.1 é”™è¯¯ç±»å‹å®šä¹‰
```go
// é”™è¯¯ç±»å‹å¸¸é‡
const (
    ErrInvalidRequest   = "INVALID_REQUEST"
    ErrServerNotFound   = "SERVER_NOT_FOUND"
    ErrNetworkError     = "NETWORK_ERROR"
    ErrTimeout          = "TIMEOUT_ERROR"
    ErrInvalidResponse  = "INVALID_RESPONSE"
)

// é”™è¯¯ä¿¡æ¯æ˜ å°„
var ErrorMessages = map[string]string{
    ErrInvalidRequest:  "è¯·æ±‚å‚æ•°é”™è¯¯",
    ErrServerNotFound:  "æœåŠ¡å™¨ä¸å­˜åœ¨",
    ErrNetworkError:    "ç½‘ç»œè¿æ¥é”™è¯¯",
    ErrTimeout:         "è¯·æ±‚è¶…æ—¶",
    ErrInvalidResponse: "å“åº”æ•°æ®é”™è¯¯",
}
```

#### 4.3.2 ç»Ÿä¸€é”™è¯¯å¤„ç†
```go
// é”™è¯¯å¤„ç†å‡½æ•°
func (d *OllamaApiDebugger) handleError(err error) string {
    switch {
    case strings.Contains(err.Error(), "timeout"):
        return ErrorMessages[ErrTimeout]
    case strings.Contains(err.Error(), "connection refused"):
        return ErrorMessages[ErrNetworkError]
    case strings.Contains(err.Error(), "no such host"):
        return ErrorMessages[ErrNetworkError]
    default:
        return err.Error()
    }
}
```

## 5. Assuranceï¼ˆè´¨é‡ä¿è¯ï¼‰

### 5.1 APIæµ‹è¯•ç­–ç•¥

#### å•å…ƒæµ‹è¯•
- **æ–¹æ³•æµ‹è¯•**: æ¯ä¸ªAPIæ–¹æ³•çš„ç‹¬ç«‹æµ‹è¯•
- **å‚æ•°éªŒè¯**: è¾¹ç•Œå€¼å’Œå¼‚å¸¸æƒ…å†µæµ‹è¯•
- **é”™è¯¯å¤„ç†**: å„ç§é”™è¯¯æƒ…å†µçš„å¤„ç†æµ‹è¯•

#### é›†æˆæµ‹è¯•
- **ç«¯åˆ°ç«¯æµ‹è¯•**: å®Œæ•´çš„è¯·æ±‚å“åº”æµç¨‹æµ‹è¯•
- **çœŸå®APIæµ‹è¯•**: å¯¹çœŸå®OllamaæœåŠ¡çš„æµ‹è¯•
- **æ€§èƒ½æµ‹è¯•**: å¹¶å‘è¯·æ±‚å’Œå‹åŠ›æµ‹è¯•

### 5.2 APIæ–‡æ¡£ç”Ÿæˆ
- **è‡ªåŠ¨ç”Ÿæˆ**: åŸºäºä»£ç æ³¨é‡Šç”Ÿæˆæ–‡æ¡£
- **äº¤äº’å¼æ–‡æ¡£**: æ”¯æŒåœ¨çº¿æµ‹è¯•çš„APIæ–‡æ¡£
- **ç¤ºä¾‹ä»£ç **: å®Œæ•´çš„è°ƒç”¨ç¤ºä¾‹

### 5.3 ç›‘æ§å’Œæ—¥å¿—
- **è°ƒç”¨ç»Ÿè®¡**: APIè°ƒç”¨æ¬¡æ•°å’Œè€—æ—¶ç»Ÿè®¡
- **é”™è¯¯ç›‘æ§**: é”™è¯¯ç‡å’Œé”™è¯¯ç±»å‹ç»Ÿè®¡
- **æ€§èƒ½ç›‘æ§**: å“åº”æ—¶é—´å’Œèµ„æºä½¿ç”¨ç›‘æ§

## 6. Actionï¼ˆè¡ŒåŠ¨è®¡åˆ’ï¼‰

### 6.1 APIå¼€å‘è®¡åˆ’

#### é˜¶æ®µ1: æ ¸å¿ƒAPI (1å‘¨)
- âœ… SendHttpRequest å®ç°
- âœ… GetOllamaServers å®ç°
- âœ… åŸºç¡€é”™è¯¯å¤„ç†
- âœ… æ•°æ®ç»“æ„å®šä¹‰

#### é˜¶æ®µ2: å¢å¼ºåŠŸèƒ½ (1å‘¨)
- ğŸ”„ **è¯·æ±‚å–æ¶ˆ**: æ”¯æŒé•¿æ—¶é—´è¯·æ±‚çš„å–æ¶ˆ
- ğŸ”„ **è¯·æ±‚éªŒè¯**: æ›´ä¸¥æ ¼çš„å‚æ•°éªŒè¯
- ğŸ”„ **é”™è¯¯å¤„ç†**: æ›´ç»†è‡´çš„é”™è¯¯åˆ†ç±»
- ğŸ”„ **æ—¥å¿—è®°å½•**: å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿ

#### é˜¶æ®µ3: è´¨é‡ä¿è¯ (1å‘¨)
- ğŸ“… **å•å…ƒæµ‹è¯•**: å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹
- ğŸ“… **é›†æˆæµ‹è¯•**: ç«¯åˆ°ç«¯æµ‹è¯•
- ğŸ“… **æ€§èƒ½æµ‹è¯•**: å¹¶å‘å’Œå‹åŠ›æµ‹è¯•
- ğŸ“… **æ–‡æ¡£å®Œå–„**: APIæ–‡æ¡£å’Œç¤ºä¾‹

### 6.2 æ‰©å±•è®¡åˆ’

#### è¿‘æœŸæ‰©å±• (1-2ä¸ªæœˆ)
- ğŸ“… **è¯·æ±‚å†å²API**: ä¿å­˜å’Œç®¡ç†è¯·æ±‚å†å²
- ğŸ“… **æ”¶è—API**: æ”¶è—å¸¸ç”¨è¯·æ±‚çš„API
- ğŸ“… **æ‰¹é‡æ“ä½œAPI**: æ‰¹é‡å‘é€è¯·æ±‚
- ğŸ“… **å¯¼å…¥å¯¼å‡ºAPI**: é…ç½®å’Œæ•°æ®çš„å¯¼å…¥å¯¼å‡º

#### ä¸­æœŸæ‰©å±• (3-6ä¸ªæœˆ)
- ğŸ“… **æµ‹è¯•å¥—ä»¶API**: æµ‹è¯•ç”¨ä¾‹é›†åˆç®¡ç†
- ğŸ“… **æ€§èƒ½ç›‘æ§API**: è¯·æ±‚æ€§èƒ½æ•°æ®æ”¶é›†
- ğŸ“… **åä½œåŠŸèƒ½API**: å¤šç”¨æˆ·åä½œæ”¯æŒ
- ğŸ“… **æ’ä»¶ç³»ç»ŸAPI**: å¯æ‰©å±•çš„æ’ä»¶æ¥å£

### 6.3 APIç‰ˆæœ¬ç®¡ç†
- **ç‰ˆæœ¬ç­–ç•¥**: è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶
- **å…¼å®¹æ€§**: å‘åå…¼å®¹ä¿è¯
- **åºŸå¼ƒç­–ç•¥**: æ¸è¿›å¼åºŸå¼ƒæœºåˆ¶
- **è¿ç§»æŒ‡å—**: ç‰ˆæœ¬å‡çº§æŒ‡å¯¼