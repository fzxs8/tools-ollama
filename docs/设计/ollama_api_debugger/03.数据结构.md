# Ollama API è°ƒè¯•å™¨æ¨¡å— - æ•°æ®ç»“æ„

## 1. Architectureï¼ˆæ¶æ„è®¾è®¡ï¼‰

### 1.1 æ•°æ®æ¶æ„æ¦‚è¿°
Ollama API è°ƒè¯•å™¨é‡‡ç”¨ç®€åŒ–çš„æ•°æ®æ¶æ„ï¼Œä¸»è¦ä¾èµ–å‰ç«¯çŠ¶æ€ç®¡ç†å’Œåç«¯ç›´æ¥HTTPè°ƒç”¨ï¼Œæ— éœ€å¤æ‚çš„æ•°æ®æŒä¹…åŒ–å­˜å‚¨ã€‚

### 1.2 æ•°æ®æµæ¶æ„
```
å‰ç«¯çŠ¶æ€å±‚ (Vue Reactive)
    â†•
Wails ç»‘å®šå±‚ (Go Methods)
    â†•
HTTP å®¢æˆ·ç«¯å±‚ (net/http)
    â†•
Ollama API æœåŠ¡
```

### 1.3 æ•°æ®å­˜å‚¨ç­–ç•¥
- **å†…å­˜çŠ¶æ€**: Vue Reactive ç®¡ç†å‰ç«¯çŠ¶æ€
- **ä¼šè¯å­˜å‚¨**: æš‚æ— éœ€æ±‚ï¼Œæ‰€æœ‰æ•°æ®éƒ½æ˜¯ä¸´æ—¶æ€§çš„
- **é…ç½®é›†æˆ**: ä¾èµ– OllamaConfigManager è·å–æœåŠ¡å™¨é…ç½®
- **ç¼“å­˜æœºåˆ¶**: æš‚æ— éœ€æ±‚ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½æ˜¯å®æ—¶çš„

## 2. Analysisï¼ˆéœ€æ±‚åˆ†æï¼‰

### 2.1 æ•°æ®å®ä½“åˆ†æ
| å®ä½“ | ç”¨é€” | å­˜å‚¨æ–¹å¼ | è®¿é—®é¢‘ç‡ |
|------|------|----------|----------|
| ApiRequest | HTTPè¯·æ±‚æ•°æ® | å†…å­˜çŠ¶æ€ | é«˜ |
| ApiResponse | HTTPå“åº”æ•°æ® | å†…å­˜çŠ¶æ€ | é«˜ |
| ApiTemplate | APIæ¨¡æ¿æ•°æ® | ç¡¬ç¼–ç  | ä¸­ |
| ServerConfig | æœåŠ¡å™¨é…ç½® | å¤–éƒ¨ç®¡ç† | ä½ |

### 2.2 æ•°æ®å…³ç³»åˆ†æ
```
ApiTemplate (1:1) â†’ ApiRequest
ApiRequest (1:1) â†’ ApiResponse
ServerConfig (1:N) â†’ ApiRequest
```

### 2.3 æ•°æ®è®¿é—®æ¨¡å¼
- **ä¸€æ¬¡æ€§è®¿é—®**: æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ— éœ€æŒä¹…åŒ–
- **å®æ—¶æ€§è¦æ±‚**: è¯·æ±‚å’Œå“åº”éƒ½éœ€è¦å®æ—¶å¤„ç†
- **ç®€å•æ“ä½œ**: ä¸»è¦æ˜¯åˆ›å»ºå’Œè¯»å–æ“ä½œï¼Œæ— å¤æ‚æŸ¥è¯¢

## 3. Architectureï¼ˆæ•°æ®æ¶æ„ï¼‰

### 3.1 å‰ç«¯æ•°æ®ç»“æ„

#### 3.1.1 æ ¸å¿ƒçŠ¶æ€æ¥å£
å‰ç«¯è¯·æ±‚æ•°æ®ç»“æ„ (ç”¨äº UI ç»‘å®šå’Œä¼ é€’ç»™åç«¯)

```typescript
// types.ts (Conceptual)

interface KeyValue {
  key: string;
  value: string;
}

interface KeyValueEnablable extends KeyValue {
  enabled: boolean;
}

enum RequestBodyType {
  None = 'none',
  Raw = 'raw',
  FormData = 'formData',
}

enum RawBodyContentType {
  Json = 'application/json',
  Text = 'text/plain',
  Html = 'text/html',
  Xml = 'application/xml',
}

interface RequestBody {
  type: RequestBodyType;
  rawContent?: string;
  rawContentType?: RawBodyContentType;
  formData?: KeyValue[];
}

interface ApiRequest {
  method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'HEAD' | 'PATCH' | 'OPTIONS';
  selectedServerId: string;
  path: string;
  queryParams: KeyValueEnablable[];
  headers: KeyValueEnablable[];
  body: RequestBody;
}
```

#### 3.1.2 åº”ç”¨çŠ¶æ€ç®¡ç†
```typescript
// ä¸»åº”ç”¨çŠ¶æ€
interface DebuggerState {
  // å½“å‰è¯·æ±‚çŠ¶æ€
  currentRequest: ApiRequest;
  
  // å“åº”çŠ¶æ€
  currentResponse: ApiResponse | null;
  
  // UI çŠ¶æ€
  ui: {
    isLoading: boolean;
    error: string | null;
    activeTab: 'params' | 'headers' | 'body';
    activeResponseTab: 'body' | 'headers';
    activeApiName: string;
  };
  
  // é…ç½®çŠ¶æ€
  config: {
    servers: OllamaServerConfig[];
    apiTemplates: ApiTemplate[];
  };
}
```

#### 3.1.3 API æ¨¡æ¿ç»“æ„
```typescript
// API æ¨¡æ¿å®šä¹‰
interface ApiTemplate {
  key: string;                    // API æ ‡è¯†ç¬¦
  method: HttpMethod;             // HTTP æ–¹æ³•
  path: string;                   // API è·¯å¾„
  body: RequestBody;              // è¯·æ±‚ä½“æ¨¡æ¿
  queryParams: KeyValueEnablable[]; // æŸ¥è¯¢å‚æ•°æ¨¡æ¿
  headers: KeyValueEnablable[];   // è¯·æ±‚å¤´æ¨¡æ¿
}

// å®Œæ•´çš„ API æ¨¡æ¿åˆ—è¡¨
const API_TEMPLATES: ApiTemplate[] = [
  {
    key: 'generateCompletion',
    method: 'POST',
    path: '/api/generate',
    body: {
      type: RequestBodyType.Raw,
      rawContentType: RawBodyContentType.Json,
      rawContent: JSON.stringify({
        model: 'llama3.2',
        keep_alive: 0
      }, null, 2)
    },
    queryParams: [],
    headers: [{
      key: 'Content-Type',
      value: 'application/json',
      enabled: true
    }]
  },
  // ... å…¶ä»–10ä¸ªAPIæ¨¡æ¿
];
```

### 3.2 åç«¯æ•°æ®ç»“æ„

#### 3.2.1 Go æ•°æ®æ¨¡å‹
åç«¯è¯·æ±‚å¤„ç† (Go)

ä¸ºç¡®ä¿å¯¹è¯·æ±‚å‚æ•°ï¼ˆç‰¹åˆ«æ˜¯è¯·æ±‚å¤´ï¼‰çš„å®Œå…¨æ§åˆ¶ï¼Œåç«¯å®ç°å·²**æ”¾å¼ƒ**ä½¿ç”¨ `duolasdk/core/net.go` ä¸­çš„ `HttpCli` å°è£…ã€‚

**å½“å‰å®ç°**: `ollama_api_debugger.go` ä¸­çš„ `SendHttpRequest` å‡½æ•°ç›´æ¥ä½¿ç”¨ Go æ ‡å‡†åº“ `net/http` æ¥å®Œæˆè¯·æ±‚çš„æ„å»ºå’Œå‘é€ã€‚

*   **URLæ„å»º**: ä½¿ç”¨ `url.JoinPath` å’Œ `url.Parse` æ‹¼æ¥ BaseURL, Path å’ŒæŸ¥è¯¢å‚æ•°ã€‚
*   **è¯·æ±‚ä½“æ„å»º**: ä½¿ç”¨ `strings.NewReader` å°†å‰ç«¯ä¼ æ¥çš„ `rawContent` æˆ–ç¼–ç åçš„ `formData` è½¬æ¢ä¸º `io.Reader`ã€‚
*   **è¯·æ±‚å¤´æ„å»º**: æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ª `http.Header` å¯¹è±¡ï¼Œå¹¶é€ä¸€è®¾ç½®ä»å‰ç«¯ä¼ æ¥çš„æ‰€æœ‰å¯ç”¨çš„è¯·æ±‚å¤´ï¼ŒåŒ…æ‹¬æ ¹æ®è¯·æ±‚ä½“ç±»å‹åŠ¨æ€è®¾ç½®çš„ `Content-Type`ã€‚
*   **è¯·æ±‚å‘é€**: ä½¿ç”¨ `http.NewRequestWithContext` åˆ›å»ºä¸€ä¸ª `*http.Request` å¯¹è±¡ï¼Œå¹¶ç”±æ ‡å‡†çš„ `http.Client` çš„ `Do` æ–¹æ³•å‘é€ã€‚

è¿™ç§æ–¹å¼ç»•è¿‡äº†æ‰€æœ‰ä¸­é—´å°è£…ï¼Œä¿è¯äº†å‰ç«¯æ‰€è§å³åç«¯æ‰€å‘ã€‚

#### 3.2.2 HTTP è¯·æ±‚å¤„ç†
```go
// HTTP è¯·æ±‚æ„å»ºå™¨
type HttpRequestBuilder struct {
    baseURL     string
    path        string
    method      string
    queryParams map[string]string
    headers     map[string]string
    body        io.Reader
}

// æ„å»ºå®Œæ•´çš„ HTTP è¯·æ±‚
func (b *HttpRequestBuilder) Build(ctx context.Context) (*http.Request, error) {
    // 1. æ„å»º URL
    finalURL, err := BuildURLWithQuery(b.baseURL, b.path, b.queryParams)
    if err != nil {
        return nil, err
    }
    
    // 2. åˆ›å»ºè¯·æ±‚
    req, err := http.NewRequestWithContext(ctx, b.method, finalURL, b.body)
    if err != nil {
        return nil, err
    }
    
    // 3. è®¾ç½®è¯·æ±‚å¤´
    for key, value := range b.headers {
        req.Header.Set(key, value)
    }
    
    return req, nil
}
```

### 3.3 æ•°æ®éªŒè¯

#### 3.3.1 å‰ç«¯éªŒè¯
```typescript
// è¯·æ±‚æ•°æ®éªŒè¯
function validateApiRequest(request: ApiRequest): ValidationResult {
  const errors: string[] = [];
  
  // éªŒè¯æœåŠ¡å™¨é€‰æ‹©
  if (!request.selectedServerId) {
    errors.push('è¯·é€‰æ‹©OllamaæœåŠ¡å™¨');
  }
  
  // éªŒè¯APIè·¯å¾„
  if (!request.path || !request.path.startsWith('/')) {
    errors.push('APIè·¯å¾„å¿…é¡»ä»¥/å¼€å¤´');
  }
  
  // éªŒè¯JSONæ ¼å¼
  if (request.body.type === RequestBodyType.Raw && 
      request.body.rawContentType === RawBodyContentType.Json) {
    try {
      JSON.parse(request.body.rawContent);
    } catch (e) {
      errors.push('JSONæ ¼å¼é”™è¯¯');
    }
  }
  
  return {
    valid: errors.length === 0,
    errors
  };
}
```

#### 3.3.2 åç«¯éªŒè¯
```go
// è¯·æ±‚å‚æ•°éªŒè¯
func ValidateApiRequest(request types.ApiRequest) error {
    if request.SelectedServerID == "" {
        return errors.New("æœªé€‰æ‹©æœåŠ¡å™¨")
    }
    
    if request.Method == "" {
        return errors.New("HTTPæ–¹æ³•ä¸èƒ½ä¸ºç©º")
    }
    
    if request.Path == "" {
        return errors.New("APIè·¯å¾„ä¸èƒ½ä¸ºç©º")
    }
    
    return nil
}
```

## 4. Applicationï¼ˆåº”ç”¨å®ç°ï¼‰

### 4.1 æ•°æ®è½¬æ¢å±‚

#### 4.1.1 è¯·æ±‚æ•°æ®è½¬æ¢
```go
// å°†å‰ç«¯è¯·æ±‚è½¬æ¢ä¸ºHTTPè¯·æ±‚
func ConvertToHttpRequest(apiReq types.ApiRequest, serverConfig types.OllamaServerConfig) (*HttpRequestBuilder, error) {
    builder := &HttpRequestBuilder{
        baseURL: serverConfig.BaseURL,
        path:    apiReq.Path,
        method:  strings.ToUpper(apiReq.Method),
    }
    
    // è½¬æ¢æŸ¥è¯¢å‚æ•°
    queryParams := make(map[string]string)
    for _, param := range apiReq.QueryParams {
        if param.Enabled {
            queryParams[param.Key] = param.Value
        }
    }
    builder.queryParams = queryParams
    
    // è½¬æ¢è¯·æ±‚å¤´
    headers := make(map[string]string)
    for _, header := range apiReq.Headers {
        if header.Enabled {
            headers[header.Key] = header.Value
        }
    }
    
    // è½¬æ¢è¯·æ±‚ä½“
    bodyReader, contentType, err := ConvertRequestBody(apiReq.Body)
    if err != nil {
        return nil, err
    }
    
    if contentType != "" {
        headers["Content-Type"] = contentType
    }
    
    builder.headers = headers
    builder.body = bodyReader
    
    return builder, nil
}
```

#### 4.1.2 å“åº”æ•°æ®è½¬æ¢
```go
// å°†HTTPå“åº”è½¬æ¢ä¸ºå‰ç«¯å“åº”
func ConvertFromHttpResponse(resp *http.Response, duration time.Duration) (types.ApiResponse, error) {
    apiResp := types.ApiResponse{
        StatusCode:        resp.StatusCode,
        StatusText:        http.StatusText(resp.StatusCode),
        RequestDurationMs: duration.Milliseconds(),
    }
    
    // è¯»å–å“åº”ä½“
    body, err := io.ReadAll(resp.Body)
    if err != nil {
        return apiResp, err
    }
    apiResp.Body = string(body)
    
    // è½¬æ¢å“åº”å¤´
    for key, values := range resp.Header {
        apiResp.Headers = append(apiResp.Headers, types.RequestHeader{
            Key:     key,
            Value:   strings.Join(values, ", "),
            Enabled: true,
        })
    }
    
    return apiResp, nil
}
```

### 4.2 å·¥å…·å‡½æ•°

#### 4.2.1 URL æ„å»ºå·¥å…·
```go
// æ„å»ºå¸¦æŸ¥è¯¢å‚æ•°çš„URL
func BuildURLWithQuery(baseURL, path string, queryParams map[string]string) (string, error) {
    // è§£æåŸºç¡€URL
    base, err := url.Parse(baseURL)
    if err != nil {
        return "", err
    }
    
    // æ‹¼æ¥è·¯å¾„
    fullURL, err := url.JoinPath(base.String(), path)
    if err != nil {
        return "", err
    }
    
    // æ·»åŠ æŸ¥è¯¢å‚æ•°
    if len(queryParams) > 0 {
        parsedURL, err := url.Parse(fullURL)
        if err != nil {
            return "", err
        }
        
        query := parsedURL.Query()
        for key, value := range queryParams {
            query.Set(key, value)
        }
        parsedURL.RawQuery = query.Encode()
        fullURL = parsedURL.String()
    }
    
    return fullURL, nil
}
```

#### 4.2.2 è¯·æ±‚ä½“å¤„ç†å·¥å…·
```go
// å¤„ç†ä¸åŒç±»å‹çš„è¯·æ±‚ä½“
func ConvertRequestBody(body types.RequestBody) (io.Reader, string, error) {
    switch body.Type {
    case types.RequestBodyTypeNone:
        return nil, "", nil
        
    case types.RequestBodyTypeRaw:
        return strings.NewReader(body.RawContent), string(body.RawContentType), nil
        
    case types.RequestBodyTypeFormData:
        formData := url.Values{}
        for _, field := range body.FormData {
            formData.Set(field.Key, field.Value)
        }
        return strings.NewReader(formData.Encode()), "application/x-www-form-urlencoded", nil
        
    default:
        return nil, "", errors.New("ä¸æ”¯æŒçš„è¯·æ±‚ä½“ç±»å‹")
    }
}
```

## 5. Assuranceï¼ˆè´¨é‡ä¿è¯ï¼‰

### 5.1 æ•°æ®å®Œæ•´æ€§
- **ç±»å‹å®‰å…¨**: TypeScript å’Œ Go çš„å¼ºç±»å‹ç³»ç»Ÿ
- **æ•°æ®éªŒè¯**: å‰åç«¯åŒé‡éªŒè¯æœºåˆ¶
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œä¼ æ’­

### 5.2 æ•°æ®å®‰å…¨æ€§
- **è¾“å…¥è¿‡æ»¤**: é˜²æ­¢æ¶æ„è¾“å…¥å’Œæ³¨å…¥æ”»å‡»
- **å‚æ•°ç¼–ç **: URL å’Œè¯·æ±‚ä½“å‚æ•°æ­£ç¡®ç¼–ç 
- **é”™è¯¯éšè—**: ä¸æš´éœ²æ•æ„Ÿçš„ç³»ç»Ÿä¿¡æ¯

### 5.3 æ€§èƒ½ä¿è¯
- **å†…å­˜ç®¡ç†**: åŠæ—¶æ¸…ç†å¤§å‹å“åº”æ•°æ®
- **åºåˆ—åŒ–ä¼˜åŒ–**: é«˜æ•ˆçš„JSONåºåˆ—åŒ–å’Œååºåˆ—åŒ–
- **ç½‘ç»œä¼˜åŒ–**: åˆç†çš„è¶…æ—¶è®¾ç½®å’Œé‡è¯•æœºåˆ¶

## 6. Actionï¼ˆè¡ŒåŠ¨è®¡åˆ’ï¼‰

### 6.1 æ•°æ®ç»“æ„å®ç°è®¡åˆ’

#### é˜¶æ®µ1: åŸºç¡€ç»“æ„ (1å‘¨)
- âœ… æ ¸å¿ƒæ•°æ®æ¨¡å‹å®šä¹‰
- âœ… å‰åç«¯ç±»å‹å®šä¹‰ä¸€è‡´æ€§
- âœ… åŸºç¡€æ•°æ®éªŒè¯è§„åˆ™
- âœ… APIæ¨¡æ¿æ•°æ®ç»“æ„

#### é˜¶æ®µ2: é«˜çº§åŠŸèƒ½ (1å‘¨)
- âœ… æ•°æ®è½¬æ¢å±‚å®ç°
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… å·¥å…·å‡½æ•°å®Œå–„
- âœ… æ€§èƒ½ä¼˜åŒ–

#### é˜¶æ®µ3: è´¨é‡ä¿è¯ (1å‘¨)
- âœ… å•å…ƒæµ‹è¯•ç¼–å†™
- âœ… é›†æˆæµ‹è¯•éªŒè¯
- âœ… æ•°æ®å®‰å…¨æ€§æ£€æŸ¥
- âœ… æ€§èƒ½æµ‹è¯•

### 6.2 æ•°æ®æ²»ç†

#### æ•°æ®è´¨é‡ç®¡ç†
- **æ•°æ®éªŒè¯**: ä¸¥æ ¼çš„è¾“å…¥éªŒè¯å’Œæ ¼å¼æ£€æŸ¥
- **é”™è¯¯ç›‘æ§**: æ•°æ®è½¬æ¢å’Œå¤„ç†é”™è¯¯ç›‘æ§
- **æ—¥å¿—è®°å½•**: å…³é”®æ•°æ®æ“ä½œçš„æ—¥å¿—è®°å½•

#### æ•°æ®å®‰å…¨ç®¡ç†
- **æ•æ„Ÿæ•°æ®è¿‡æ»¤**: é˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²
- **è¾“å…¥æ¸…æ´—**: é˜²æ­¢XSSå’Œæ³¨å…¥æ”»å‡»
- **æ•°æ®åŠ å¯†**: å¿…è¦æ—¶å¯¹æ•æ„Ÿæ•°æ®è¿›è¡ŒåŠ å¯†

### 6.3 æ‰©å±•è®¡åˆ’

#### è¿‘æœŸæ‰©å±• (1-2ä¸ªæœˆ)
- ğŸ“… **è¯·æ±‚å†å²**: æ·»åŠ è¯·æ±‚å†å²è®°å½•æ•°æ®ç»“æ„
- ğŸ“… **æ”¶è—åŠŸèƒ½**: æ·»åŠ æ”¶è—è¯·æ±‚çš„æ•°æ®ç»“æ„
- ğŸ“… **ç¯å¢ƒå˜é‡**: æ”¯æŒåŠ¨æ€å‚æ•°æ›¿æ¢
- ğŸ“… **æ‰¹é‡æ“ä½œ**: æ‰¹é‡è¯·æ±‚çš„æ•°æ®ç»“æ„

#### ä¸­æœŸæ‰©å±• (3-6ä¸ªæœˆ)
- ğŸ“… **æµ‹è¯•å¥—ä»¶**: æµ‹è¯•ç”¨ä¾‹é›†åˆçš„æ•°æ®ç»“æ„
- ğŸ“… **æ€§èƒ½ç›‘æ§**: æ€§èƒ½æŒ‡æ ‡çš„æ•°æ®ç»“æ„
- ğŸ“… **åä½œåŠŸèƒ½**: å¤šç”¨æˆ·åä½œçš„æ•°æ®ç»“æ„
- ğŸ“… **æ’ä»¶ç³»ç»Ÿ**: å¯æ‰©å±•çš„æ’ä»¶æ•°æ®ç»“æ„

å“åº”åŒæ ·ç”± `net/http` çš„ `*http.Response` å¯¹è±¡å¤„ç†ã€‚

*   ä» `resp.StatusCode` å’Œ `resp.Header` ä¸­è¯»å–çŠ¶æ€ç å’Œå“åº”å¤´ã€‚
*   ä½¿ç”¨ `io.ReadAll` ä» `resp.Body` ä¸­è¯»å–å“åº”ä½“å­—ç¬¦ä¸²ã€‚
*   å°†è¿™äº›ä¿¡æ¯ç»„è£…æˆ `types.ApiResponse` ç»“æ„ä½“è¿”å›ç»™å‰ç«¯ã€‚

## 4. å‰åç«¯äº¤äº’æ•°æ®ç»“æ„ (Go & TypeScript)

è¿™äº›ç»“æ„å®šä¹‰åœ¨ `tools-ollama/types/types.go` ä¸­ï¼Œå¹¶ç”± Wails è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ TypeScript ç‰ˆæœ¬ã€‚

```go
// tools-ollama/types/types.go

// (åªå±•ç¤ºç›¸å…³éƒ¨åˆ†)

type FormDataItem struct {
	Key   string `json:"key"`
	Value string `json:"value"`
}

type RequestBody struct {
	Type           RequestBodyType      `json:"type"`
	RawContent     string               `json:"rawContent,omitempty"`
	RawContentType RawBodyContentType   `json:"rawContentType,omitempty"`
	FormData       []FormDataItem       `json:"formData,omitempty"` // å·²ä¿®æ­£ä¸ºæ­£ç¡®çš„ struct slice
}

type ApiRequest struct {
	Method           string          `json:"method"`
	SelectedServerID string          `json:"selectedServerId"`
	Path             string          `json:"path"`
	QueryParams      []QueryParam    `json:"queryParams"`
	Headers          []RequestHeader `json:"headers"`
	Body             RequestBody     `json:"body"`
}

type ApiResponse struct {
	StatusCode        int             `json:"statusCode"`
	StatusText        string          `json:"statusText"`
	Headers           []RequestHeader `json:"headers"`
	Body              string          `json:"body"`
	RequestDurationMs int64           `json:"requestDurationMs"`
	Error             string          `json:"error,omitempty"`
}
```
