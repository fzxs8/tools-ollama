# Ollama API 调试器模块 - 功能需求

## 1. Architecture（架构设计）

### 1.1 模块概述
Ollama API 调试器是一个类似 Postman 的专业 API 调试工具，专门用于调试和测试 Ollama 的 RESTful API 接口。采用 Vue 3 + TypeScript + Wails v2 技术栈，提供直观高效的 API 调试体验。

### 1.2 技术架构
- **前端框架**: Vue 3 Composition API + TypeScript
- **UI组件库**: 原生CSS + Element Plus（部分组件）
- **后端服务**: Go + Wails v2 + net/http 标准库
- **数据存储**: 内存状态管理
- **HTTP客户端**: Go 标准库 net/http（绕过中间封装）

### 1.3 核心组件
```
OllamaApiDebugger 模块
├── OllamaApiDebugger.vue (主组件)
├── ollama_api_debugger.go (后端服务)
└── types.go (数据结构)
```

## 2. Analysis（需求分析）

### 2.1 用户群体分析
- **主要用户**: 开发者、API测试人员、Ollama服务管理员
- **使用场景**: API接口调试、参数测试、响应验证、问题排查
- **核心需求**: 快速测试、参数可视化编辑、响应格式化显示

### 2.2 功能需求优先级矩阵
| 优先级 | 功能模块 | 业务价值 | 实现复杂度 | 状态 |
|--------|----------|----------|------------|------|
| P0 | API预设列表 | 高 | 低 | ✅ 已完成 |
| P0 | 请求构建与发送 | 高 | 中 | ✅ 已完成 |
| P0 | 响应显示与格式化 | 高 | 中 | ✅ 已完成 |
| P1 | 服务器配置集成 | 中 | 低 | ✅ 已完成 |
| P1 | 错误处理与提示 | 中 | 低 | ✅ 已完成 |
| P2 | 请求历史记录 | 低 | 中 | 🔄 待实现 |
| P2 | 请求收藏功能 | 低 | 中 | 🔄 待实现 |

### 2.3 竞品分析
| 产品 | 优势 | 劣势 | 差异化策略 |
|------|------|------|------------|
| Postman | 功能全面，生态丰富 | 通用工具，无针对性 | Ollama专用，预设模板 |
| Insomnia | 界面简洁，性能好 | 配置复杂 | 开箱即用，零配置 |
| curl命令 | 轻量级，脚本化 | 学习成本高 | 可视化界面，易用性 |

## 3. Architecture（架构设计）

### 3.1 核心功能架构

#### 3.1.1 API预设系统

#### 预设API列表
- **硬编码模板**: 基于Ollama API文档预设11个常用接口
- **自动填充**: 点击API项自动填充所有参数
- **参数模板**: 每个API包含完整的请求示例
- **分类展示**: 按功能分组显示API列表

#### API模板结构
```typescript
interface ApiTemplate {
  key: string;           // API标识
  method: string;        // HTTP方法
  path: string;          // API路径
  body: RequestBody;     // 请求体模板
  queryParams: KeyValue[]; // 查询参数
  headers: KeyValue[];   // 请求头
}
```

#### 3.1.2 请求构建系统

#### 可视化编辑器
- **URL构建**: 服务器选择 + 路径编辑
- **查询参数**: 键值对表格编辑器
- **请求头**: 键值对表格编辑器，支持启用/禁用
- **请求体**: 支持None/Raw/FormData三种类型

#### 参数验证
- **必填验证**: 服务器选择、API路径验证
- **格式验证**: JSON格式验证、URL格式验证
- **实时反馈**: 参数错误实时提示

#### 3.1.3 HTTP请求系统

#### 直接HTTP调用
为确保请求的完全可控性，后端实现放弃使用任何HTTP封装库：

- **标准库优先**: 直接使用Go标准库 `net/http`
- **手动构建**: 手动构建URL、请求头、请求体
- **完全控制**: 前端所见即后端所发
- **绕过封装**: 避免中间层的参数转换和限制

#### 请求处理流程
1. **服务器配置获取**: 从OllamaConfigManager获取BaseURL
2. **URL拼接**: 使用url.JoinPath拼接完整URL
3. **请求体构建**: 根据类型构建io.Reader
4. **请求头设置**: 手动设置所有启用的请求头
5. **请求发送**: 使用http.Client.Do发送请求
6. **响应处理**: 读取状态码、响应头、响应体

## 4. Application（应用实现）

### 4.1 预设API模板

#### 4.1.1 完整API列表
```typescript
const apiTemplates = [
  {
    key: 'generateCompletion',
    method: 'POST',
    path: '/api/generate',
    body: {
      type: 'raw',
      rawContentType: 'application/json',
      rawContent: JSON.stringify({
        model: 'llama3.2',
        keep_alive: 0
      }, null, 2)
    }
  },
  {
    key: 'generateChatCompletion', 
    method: 'POST',
    path: '/api/chat',
    body: {
      type: 'raw',
      rawContentType: 'application/json',
      rawContent: JSON.stringify({
        model: 'llama3.2',
        messages: [{ role: 'user', content: 'Hello' }],
        keep_alive: 60
      }, null, 2)
    }
  },
  // ... 其他9个API模板
];
```

### 4.2 核心功能实现

#### 4.2.1 请求发送逻辑
```go
func (d *OllamaApiDebugger) SendHttpRequest(request types.ApiRequest) (types.ApiResponse, error) {
    // 1. 获取服务器配置
    serverConfig, err := d.configMgr.GetServerByID(request.SelectedServerID)
    
    // 2. 构建完整URL
    finalURL, err := BuildURLWithQuery(baseURL, request.Path, queryParams)
    
    // 3. 准备请求体
    var bodyReader io.Reader
    switch request.Body.Type {
    case types.RequestBodyTypeRaw:
        bodyReader = strings.NewReader(request.Body.RawContent)
    case types.RequestBodyTypeFormData:
        // FormData编码
    }
    
    // 4. 创建HTTP请求
    req, err := http.NewRequestWithContext(d.ctx, request.Method, finalURL, bodyReader)
    
    // 5. 设置请求头
    for _, header := range request.Headers {
        if header.Enabled {
            req.Header.Set(header.Key, header.Value)
        }
    }
    
    // 6. 发送请求并处理响应
    client := &http.Client{Timeout: 30 * time.Second}
    resp, err := client.Do(req)
    
    return processResponse(resp)
}
```

## 5. Assurance（质量保证）

### 5.1 用户体验保证

#### 响应性保证
- 请求发送实时反馈，加载状态清晰
- 响应结果即时显示，JSON自动格式化
- 错误信息友好提示，问题定位准确

#### 易用性保证
- 预设API模板，开箱即用
- 可视化参数编辑，降低使用门槛
- Postman风格界面，学习成本低

### 5.2 技术质量保证
- 类型安全的前后端数据传输
- 完全可控的HTTP请求构建
- 统一的错误处理机制

### 5.3 兼容性保证
- 支持所有Ollama官方API接口
- 兼容不同版本的Ollama服务
- 跨平台桌面应用支持

## 6. Action（行动计划）

### 6.1 已完成功能
- ✅ 核心架构设计和实现
- ✅ 11个预设API模板
- ✅ 完整的请求构建功能
- ✅ 响应显示和格式化
- ✅ 服务器配置集成
- ✅ 错误处理机制

### 6.2 近期计划 (1-2周)

#### Sprint 1: 功能增强 (1周)
- 🔄 **请求取消功能**: 支持长时间请求的取消
- 🔄 **JSON格式化**: 请求体JSON美化和压缩
- 🔄 **参数验证增强**: 更严格的参数格式验证
- 🔄 **快捷键支持**: Ctrl+Enter发送请求

#### Sprint 2: 体验优化 (1周)
- 📅 **请求历史记录**: 保存最近的请求历史
- 📅 **请求收藏功能**: 收藏常用的API请求
- 📅 **环境变量支持**: 支持动态参数替换
- 📅 **代码生成**: 生成curl命令和代码示例

### 6.3 中期规划 (1-2个月)

#### 阶段1: 高级功能 (1个月)
- 📅 **批量测试**: 支持批量API测试
- 📅 **测试套件**: 创建和管理测试用例集合
- 📅 **响应断言**: 添加响应结果验证
- 📅 **性能监控**: 请求耗时和成功率统计

#### 阶段2: 集成增强 (1个月)
- 📅 **导入导出**: 支持Postman集合导入导出
- 📅 **团队协作**: 配置和模板共享
- 📅 **插件系统**: 支持自定义扩展
- 📅 **API文档生成**: 基于测试生成API文档

### 6.4 长期规划 (3个月+)

#### 阶段1: 智能化 (2个月)
- 📅 **智能补全**: API参数智能提示
- 📅 **自动化测试**: 基于规则的自动化测试
- 📅 **异常检测**: 自动识别API异常
- 📅 **性能分析**: 深度性能分析报告

#### 阶段2: 生态建设 (1个月)
- 📅 **社区模板**: 用户贡献的API模板库
- 📅 **最佳实践**: API测试最佳实践指南
- 📅 **培训材料**: 使用教程和视频
- 📅 **开发者工具**: CLI工具和SDK

### 6.5 里程碑计划

| 时间节点 | 里程碑 | 交付物 | 成功指标 |
|----------|------|--------|----------|
| 当前 | v1.0 基础版 | 核心调试功能 | 支持所有Ollama API |
| 2024.01 | v1.1 增强版 | 请求取消、历史记录 | 用户体验提升30% |
| 2024.02 | v1.2 专业版 | 批量测试、测试套件 | 测试效率提升50% |
| 2024.04 | v2.0 企业版 | 团队协作、性能监控 | 支持团队使用 |
| 2024.07 | v2.1 智能版 | 智能补全、自动化测试 | AI辅助测试 |

### 6.6 风险识别与应对

| 风险类型 | 风险描述 | 影响程度 | 应对策略 |
|----------|----------|----------|----------|
| 技术风险 | Ollama API变更 | 中 | 版本兼容性设计 |
| 用户风险 | 学习成本高 | 低 | 详细文档和教程 |
| 竞争风险 | 通用工具竞争 | 低 | 专业化差异优势 |
| 维护风险 | 功能复杂度增加 | 中 | 模块化架构设计 |

### 2.1 API 选择与参数自动填充
*   **服务选择**: 
    *   在界面左上角提供一个下拉列表，用于选择 `OllamaSettings` 中配置的 Ollama 服务。
    *   选择的服务将决定当前所有 API 请求的 `BaseURL`。
*   **API 列表**: 
    *   在服务选择器下方，提供一个清晰的、可滚动的 API 列表。
    *   该列表的内容根据 `API.md` 文档生成，每一项都包含 **HTTP 方法** 和 **API 名称**。
*   **自动填充**: 
    *   用户点击左侧 API 列表中的任意一项后，右侧的请求构建区将**自动填充**该 API 对应的所有参数，包括：
        *   HTTP 方法 (GET, POST, etc.)
        *   API 路径 (e.g., `/api/chat`)
        *   预设的请求头 (e.g., `Content-Type: application/json`)
        *   预设的请求体 (e.g., 一个包含 `model` 和 `messages` 字段的 JSON 对象)

### 2.2. 请求自定义
用户在自动填充的基础上，可以对请求进行完全的自定义。
*   **URL 编辑**: 可手动修改自动填充的 API 路径。
*   **查询参数 (Query Params) 编辑**: 可在 Tab 中通过键值对编辑器增、删、改、禁用/启用查询参数。
*   **请求头 (Headers) 编辑**: 可在 Tab 中通过键值对编辑器增、删、改、禁用/启用请求头。
*   **请求体 (Body) 编辑**: 可在 Tab 中选择 `None`, `Raw`, `Form Data` 等类型，并编辑其内容。

### 2.3. 请求发送与响应查看
*   **发送请求**: 提供一个显眼的 “发送” 按钮，点击后触发 HTTP 请求。
*   **加载状态**: 在请求发送和等待响应期间，提供明确的加载指示。
*   **响应显示**:
    *   **布局**: 响应区域会自动填满剩余的屏幕空间，内容超长时提供滚动条，页面整体不拉伸。
    *   **状态行**: 清晰显示 HTTP 响应状态码、状态文本和请求耗时。
    *   **响应内容**: 通过 Tab 切换查看 `响应体` 和 `响应头`。
        *   响应体视图会自动格式化 JSON，并保持左对齐。
    *   **错误信息**: 当请求失败时，在响应区域清晰地显示错误信息。
