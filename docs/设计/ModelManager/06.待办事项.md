# ModelManager 备忘录与待办事项

## 开发重点和注意事项 (必读)

本章节记录了在开发过程中遇到的关键问题和最终解决方案，作为后续迭代的重要参考。

### 1. Wails v2.10.2 调试配置

- **问题**: `wails dev` 命令自身不直接支持调试，尝试直接连接调试器会导致失败或不稳定。
- **解决方案**: 通过修改 `wails.json` 文件，自定义开发模式的启动命令，将 `dlv` 调试器集成进去。
- **关键配置**:
  - `"build:go:gcflags": "-gcflags=all=-N -l"`: 关闭Go编译优化，确保断点和变量在调试时准确无误。
  - `"dev:command": "..."`: 使用此命令来包裹 `dlv` 的执行。
- **时序问题**: IDE（如Goland）的调试器连接速度可能快于 `dlv` 的准备速度，导致“调试器意外断开连接”。
- **最终解决方案**: 在 `dev:command` 中加入 `sleep 2` 命令，给予 `dlv` 足够的启动缓冲时间。
  ```json
  "dev:command": "bash -c 'sleep 2 && dlv --listen=:40000 --headless=true --api-version=2 --accept-multiclient exec ./build/bin/ollama'"
  ```

### 2. 后端作为状态管理的唯一权威

- **问题**: 模型列表刷新后，正在运行的模型的“运行中”状态丢失。
- **根源**: 运行状态之前仅由前端临时维护，刷新时被后端返回的原始数据覆盖。
- **解决方案**: 将Go后端作为模型运行状态的**唯一数据源**。
- **实现**: 
  1. Go后端的 `ModelManager` 中维护一个全局的 `runningModels` map，用于实时记录所有正在运行的模型。
  2. `ListModelsByServer` 函数在从Ollama获取列表后，会用 `runningModels` 的数据为每个模型附加准确的 `IsRunning` 状态，然后再返回给前端。
  3. 前端 (`ModelManager.vue`) 完全信任并直接渲染后端返回的数据，不再做任何状态相关的计算和重置。

### 3. 组件初始化失败导致闪退

- **问题**: 点击“运行和测试”按钮时，应用直接闪退。
- **根源**: Go后端 `app.go` 的 `App` 结构体中，`httpClient` 字段在 `NewApp` 构造函数里没有被初始化，导致在使用时发生 `nil pointer dereference` (空指针引用) 的致命错误。
- **教训**: 在应用的构造函数中，必须确保所有会被用到的核心组件（尤其是涉及I/O、网络等操作的）都已正确创建和初始化。

### 4. 跨页面状态同步

- **问题**: `ModelManager` 页面无法自动选中在 `OllamaSettings` 页面设置的默认活动服务器。
- **根源**: `ModelManager` 页面在初始化时，自己有一套独立的逻辑来决定默认服务器，没有查询全局配置。
- **解决方案**: 让 `ModelManager` 的行为与 `OllamaSettings` 同步。
- **实现**:
  1. `ModelManager.vue` 在 `onMounted` 生命周期钩子中，优先调用后端的 `GetActiveServer()` 函数来获取全局设置。
  2. 只有当获取到的活动服务器无效或不存在时，才降级使用“本地服务”作为备选。
  3. 优化了页面加载顺序，确保在获取到默认服务器之后，再去请求该服务器上的模型列表。

### 5. 停止模型的正确实现

- **问题**: 点击“停止”按钮后，虽然UI更新了，但模型在Ollama服务器上并未真正被卸载。
- **根源**: 后端 `StopModel` 函数向Ollama发送的请求不正确。要真正卸载一个模型，必须在请求体中明确设置 `keep_alive: 0`。
- **解决方案**:
    1. **后端**: 在 `model_manager.go` 的 `StopModel` 函数中，确保发送给Ollama的请求体包含 `{"model": "...", "keep_alive": 0}`。
    2. **前端**: 为“停止”按钮添加与“运行”按钮一致的加载状态（loading）和禁用逻辑，以提供明确的交互反馈并防止重复点击。

### 6. 模型下载错误处理

- **问题**: 在模型下载过程中出现服务器错误（如版本不兼容）时，系统错误地报告下载完成。
- **根源**: 下载过程中的流式错误没有被正确识别和处理，导致即使出现错误也发送下载完成事件。
- **解决方案**:
    1. **后端**: 在 `model_manager.go` 的 `DownloadModel` 函数中增强错误检测逻辑，能够识别下载流中的错误消息。
    2. **实现**: 一旦检测到错误消息，立即中断下载过程并向前端发送错误事件，而不是发送下载完成事件。
    3. **前端**: 保持现有错误处理逻辑，确保错误信息能正确显示给用户。

---

## 待处理事项

### 功能完善
- [ ] 下载失败时显示具体失败原因，避免因版本不兼容等问题导致的调试困难
- [ ] 优化搜索在线模型功能

### 界面优化
- [ ] 优化移动端适配
- [ ] 增加暗色主题支持
- [ ] 优化表单验证提示
- [ ] 增加操作快捷键支持
- [ ] 优化模型列表排序功能

### 性能优化
- [ ] 实现模型列表虚拟滚动
- [ ] 优化模型搜索性能
- [ ] 增加配置缓存机制
- [ ] 优化数据加载性能
- [ ] 实现模型状态实时更新

### 错误处理
- [ ] 增加网络异常处理
- [ ] 增加超时处理机制
- [ ] 增加重试机制
- [ ] 优化错误提示信息
- [ ] 增加操作日志记录

### 安全增强
- [ ] 增加操作权限控制
- [ ] 增加配置备份功能
- [ ] 增加敏感操作二次验证
- [ ] 增加操作审计日志

### 测试完善
- [ ] 编写前端组件单元测试
- [ ] 编写后端接口单元测试
- [ ] 编写集成测试用例
- [ ] 编写性能测试用例
- [ ] 编写端到端测试用例

### 文档完善
- [ ] 编写用户使用手册
- [ ] 编写管理员配置指南
- [ ] 编写故障排除指南
- [ ] 编写 API 接口详细说明
- [ ] 编写最佳实践指南