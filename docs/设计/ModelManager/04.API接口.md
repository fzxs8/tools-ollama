# ModelManager 页面 API 接口文档

## 接口概览

ModelManager 页面通过 Wails 框架提供的绑定机制与 Go 后端进行通信，实现模型管理功能。所有接口均通过 `../../wailsjs/go/main/App` 导入。

## 接口列表

### 1. ListModelsByServer

根据服务器 ID 获取模型列表。

**前端调用**：
```typescript
import { ListModelsByServer } from '../../wailsjs/go/main/App'

ListModelsByServer(serverId: string): Promise<Model[]>
```

**参数说明**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serverId | string | 是 | 服务器ID，本地服务为'local' |

**返回值说明**：
| 类型 | 说明 |
|------|------|
| Model[] | 模型数组（已附带 `is_running` 状态） |

**后端实现**：
```go
// ListModelsByServer 根据服务器获取模型列表
func (a *App) ListModelsByServer(serverID string) ([]Model, error) {
    // ... 获取服务器配置 ...

    // ... 创建临时的HTTP客户端 ...

    // 获取模型列表
    response, err := tempClient.Get("/api/tags", core.Options{})
    // ... 错误处理 ...

    // ... 解析响应 ...

    // [核心] 检查并设置每个模型的运行状态
	for i := range result.Models {
		result.Models[i].IsRunning = a.modelManager.IsModelRunning(result.Models[i].Name)
	}

    return result.Models, nil
}
```

**错误处理**：
- 服务器不存在时返回错误
- 网络连接失败时返回错误
- HTTP状态码错误时返回错误

### 2. DeleteModel

删除指定模型。

**前端调用**：
```typescript
import { DeleteModel } from '../../wailsjs/go/main/App'

DeleteModel(modelName: string): Promise<void>
```

**参数说明**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| modelName | string | 是 | 要删除的模型名称 |

**后端实现**：
```go
// DeleteModel 删除模型
func (a *App) DeleteModel(modelName string) error {
    // ...
}
```

### 3. GetRemoteServers

获取远程服务器列表。

**前端调用**：
```typescript
import { GetRemoteServers } from '../../wailsjs/go/main/App'

GetRemoteServers(): Promise<Server[]>
```

### 4. GetOllamaServerConfig

获取本地 Ollama 服务器配置。

**前端调用**：
```typescript
import { GetOllamaServerConfig } from '../../wailsjs/go/main/App'

GetOllamaServerConfig(): Promise<string>
```

### 5. RunModel

运行指定模型。

**前端调用**：
```typescript
import { RunModel } from '../../wailsjs/go/main/App'

RunModel(modelName: string, params: any): Promise<void>
```

**参数说明**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| modelName | string | 是 | 要运行的模型名称 |
| params | any | 是 | 模型参数对象 |

### 6. StopModel

**[已优化]** 停止指定模型。

**前端调用**：
```typescript
import { StopModel } from '../../wailsjs/go/main/App'

StopModel(modelName: string): Promise<void>
```

**参数说明**：
| 参数名 | 类型 | 必填 | 说明 |
|---|---|---|---|
| modelName | string | 是 | 要停止的模型名称 |

**后端实现**：
```go
// StopModel 停止模型
func (a *App) StopModel(modelName string) error {
    return a.modelManager.StopModel(modelName)
}
```

**ModelManager.StopModel 实现**:
```go
// StopModel 停止模型
func (m *ModelManager) StopModel(modelName string) error {
    // ... 检查模型是否在运行 ...

    // [核心] 发送正确的请求到Ollama以卸载模型
    // 关键在于设置 keep_alive: 0
    requestBody := map[string]interface{}{
        "model":      modelName,
        "keep_alive": 0,
    }

    // 使用 /api/generate 或 /api/chat 触发卸载
    _, err := m.app.httpClient.Post("/api/generate", core.Options{
        // ...
    })

    // ... 从 runningModels map 中删除记录 ...
    
    return nil
}
```

### 7. TestModel

**[已优化]** 测试指定模型。

**前端调用**：
```typescript
import { TestModel } from '../../wailsjs/go/main/App'

TestModel(modelName: string, prompt: string): Promise<string>
```

**参数说明**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| modelName | string | 是 | 要测试的模型名称 |
| prompt    | string | 是 | 用户输入的自定义测试内容 |

**返回值说明**：
| 类型 | 说明 |
|------|------|
| string | 模型测试响应内容 |

**后端实现**：
```go
// TestModel 测试模型
func (a *App) TestModel(modelName string, prompt string) (string, error) {
    return a.modelManager.TestModel(modelName, prompt)
}
```

**ModelManager.TestModel 实现**：
```go
// TestModel 测试模型
func (m *ModelManager) TestModel(modelName string, prompt string) (string, error) {
    // 发送测试请求到Ollama
    requestBody := map[string]interface{}{
        "model":  modelName,
        "prompt": prompt, // [核心] 使用前端传递的prompt
        "stream": false,
    }

    response, err := m.app.httpClient.Post("/api/generate", core.Options{
        // ...
    })

    // ...
}
```

### 8. SetModelParams

设置模型参数。

**前端调用**：
```typescript
import { SetModelParams } from '../../wailsjs/go/main/App'

SetModelParams(modelName: string, params: any): Promise<void>
```

### 9. GetModelParams

获取模型参数。

**前端调用**：
```typescript
import { GetModelParams } from '../../wailsjs/go/main/App'

GetModelParams(modelName: string): Promise<any>
```

### 10. SearchModels

搜索模型。

**前端调用**：
```typescript
import { SearchModels } from '../../wailsjs/go/main/App'

SearchModels(params: any): Promise<Model[]>
```

### 11. GetModelFamilies

获取模型家族列表。

**前端调用**：
```typescript
import { GetModelFamilies } from '../../wailsjs/go/main/App'

GetModelFamilies(): Promise<string[]>
```

### 12. GetModelTags

获取模型标签列表。

**前端调用**：
```typescript
import { GetModelTags } from '../../wailsjs/go/main/App'

GetModelTags(): Promise<string[]>
```

### 13. GetActiveServer

获取活动服务器配置。

**前端调用**：
```typescript
import { GetActiveServer } from '../../wailsjs/go/main/App'

GetActiveServer(): Promise<Server | null>
```

**返回值说明**：
| 类型 | 说明 |
|------|------|
| Server | 活动服务器配置对象 |
| null | 如果没有找到活动服务器 |

### 14. DownloadModel

**[已优化]** 下载指定模型。

**前端调用**：
```typescript
import { DownloadModel } from '../../wailsjs/go/main/App'

DownloadModel(serverId: string, modelName: string): void
```

**参数说明**：
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serverId | string | 是 | 服务器ID |
| modelName | string | 是 | 要下载的模型名称 |

**后端实现**：
```go
// DownloadModel 下载模型
func (a *App) DownloadModel(serverID string, modelName string) {
    a.modelManager.SetContext(a.ctx)
    go a.modelManager.DownloadModel(serverID, modelName)
}
```

**ModelManager.DownloadModel 实现**：
```go
// DownloadModel 下载模型
func (m *ModelManager) DownloadModel(serverID string, modelName string) {
    // ... 获取服务器配置 ...

    // 为特定服务器创建临时的HTTP客户端
    downloadClient := core.NewHttp(logger)
    downloadClient.Create(&core.Config{
        BaseURL: serverConfig.BaseURL,
    })

    // 发送下载请求到Ollama
    requestBody := map[string]interface{}{
        "name":   modelName,    // [核心] 使用name字段而不是model字段
        "stream": true,
    }

    resp, err := downloadClient.PostStream("/api/pull", core.Options{
        // ...
    })

    // ... 错误处理 ...

    scanner := bufio.NewScanner(resp.Body)
    for scanner.Scan() {
        line := scanner.Bytes()
        
        var progressInfo map[string]interface{}
        if err := json.Unmarshal(line, &progressInfo); err != nil {
            // ... 错误处理 ...
            continue
        }
        
        // [核心] 检查是否有错误信息
        if errorMsg, ok := progressInfo["error"]; ok && errorMsg != nil && errorMsg != "" {
            // 发送错误事件并中断下载
            runtime.EventsEmit(m.ctx, "model:download:error", map[string]interface{}{"model": modelName, "error": errorMsg})
            break
        }
        
        // ... 处理进度信息 ...
        runtime.EventsEmit(m.ctx, "model:download:progress", progressInfo)
    }

    // ... 完成处理 ...
}
```

**事件通信**：

1. **下载进度事件**：
   - 事件名：`model:download:progress`
   - 数据格式：包含模型名称、状态、已完成字节数、总字节数等信息
   - 用途：更新前端下载进度条

2. **下载完成事件**：
   - 事件名：`model:download:done`
   - 数据格式：包含模型名称
   - 用途：通知前端下载已完成，刷新模型列表

3. **下载错误事件**：
   - 事件名：`model:download:error`
   - 数据格式：包含模型名称和错误信息
   - 用途：通知前端下载失败，显示错误信息
