# ModelManager 备忘录与待办事项

## 近期重构与优化总结 (2025-01-12)

- **[前端] 统一空状态处理**:
  - **问题**: 当用户删除所有服务配置后，进入本页面会因找不到可用服务器而报错“获取模型列表失败: undefined”。
  - **解决方案**: 重构了 `loadAvailableServers` 和 `getModels` 函数。现在，当检测到没有可用服务时，会通过 `ElMessage` 明确提示用户“没有配置任何Ollama服务。请在“服务设置”页面添加一个。”，并安全地中止后续获取模型列表的API调用，避免了不必要的错误。

- **[后端] 逻辑下沉与解耦**:
  - **问题**: `app.go` 中包含了 `ListModelsByServer`、`DeleteModel` 等本应属于模型管理器的业务逻辑。
  - **解决方案**: 将这些逻辑完全迁移到 `model_manager.go` 中，`app.go` 只负责路由调用。同时通过依赖注入的方式为 `ModelManager` 传入 `configMgr` 和 `logger`，降低了耦合度。

## 开发重点和注意事项 (必读)

### 最新界面设计优化 (2025-01-12)

- **模型详情抽屉统一化**: 将原本分散的两个详情区域合并为一个统一区域，移除重复内容，完善国际化支持。
- **模型测试区域完善**: 在模型详情抽屉中增加完整的模型测试功能，包括自定义提示词输入、加载状态按钮和美观的结果展示区。
- **下载队列管理**: 新增下载队列抽屉，支持实时显示所有下载任务的状态和进度，支持取消和重试操作。
- **国际化增强**: 所有新增的界面元素都完全支持中英文国际化，新增多个国际化键值。

## 开发重点和注意事项 (必读)

本章节记录了在开发过程中遇到的关键问题和最终解决方案，作为后续迭代的重要参考。

### 1. Wails v2.10.2 调试配置 **[已解决]**

- **问题**: `wails dev` 命令自身不直接支持调试，尝试直接连接调试器会导致失败或不稳定。
- **解决方案**: 通过修改 `wails.json` 文件，自定义开发模式的启动命令，将 `dlv` 调试器集成进去。
- **关键配置**:
  - `"build:go:gcflags": "-gcflags=all=-N -l"`: 关闭Go编译优化，确保断点和变量在调试时准确无误。
  - `"dev:command": "..."`: 使用此命令来包裹 `dlv` 的执行。
- **时序问题**: IDE（如Goland）的调试器连接速度可能快于 `dlv` 的准备速度，导致"调试器意外断开连接"。
- **最终解决方案**: 在 `dev:command` 中加入 `sleep 2` 命令，给予 `dlv` 足够的启动缓冲时间。
  ```json
  "dev:command": "bash -c 'sleep 2 && dlv --listen=:40000 --headless=true --api-version=2 --accept-multiclient exec ./build/bin/ollama'"
  ```

### 2. 后端作为状态管理的唯一权威

- **问题**: 模型列表刷新后，正在运行的模型的"运行中"状态丢失。
- **根源**: 运行状态之前仅由前端临时维护，刷新时被后端返回的原始数据覆盖。
- **解决方案**: 将Go后端作为模型运行状态的**唯一数据源**。
- **实现**: 
  1. Go后端的 `ModelManager` 中维护一个全局的 `runningModels` map，用于实时记录所有正在运行的模型。
  2. `ListModelsByServer` 函数在从Ollama获取列表后，会用 `runningModels` 的数据为每个模型附加准确的 `IsRunning` 状态，然后再返回给前端。
  3. 前端 (`ModelManager.vue`) 完全信任并直接渲染后端返回的数据，不再做任何状态相关的计算和重置。

### 3. 组件初始化失败导致闪退

- **问题**: 点击"运行和测试"按钮时，应用直接闪退。
- **根源**: Go后端 `app.go` 的 `App` 结构体中，`httpClient` 字段在 `NewApp` 构造函数里没有被初始化，导致在使用时发生 `nil pointer dereference` (空指针引用) 的致命错误。
- **教训**: 在应用的构造函数中，必须确保所有会被用到的核心组件（尤其是涉及I/O、网络等操作的）都已正确创建和初始化。

### 4. 跨页面状态同步

- **问题**: `ModelManager` 页面无法自动选中在 `OllamaSettings` 页面设置的默认活动服务器。
- **根源**: `ModelManager` 页面在初始化时，自己有一套独立的逻辑来决定默认服务器，没有查询全局配置。
- **解决方案**: 让 `ModelManager` 的行为与 `OllamaSettings` 同步。
- **实现**:
  1. `ModelManager.vue` 在 `onMounted` 生命周期钩子中，优先调用后端的 `GetActiveServer()` 函数来获取全局设置。
  2. 只有当获取到的活动服务器无效或不存在时，才降级使用列表中的第一个作为备选。
  3. 优化了页面加载顺序，确保在获取到默认服务器之后，再去请求该服务器上的模型列表。

### 5. 停止模型的正确实现

- **问题**: 点击"停止"按钮后，虽然UI更新了，但模型在Ollama服务器上并未真正被卸载。
- **根源**: 后端 `StopModel` 函数的实现不完整，只是从内存中删除了记录。
- **解决方案**:
    1. **后端**: 在 `model_manager.go` 的 `StopModel` 函数中，通过发送 `keep_alive: 0` 的请求来真正指示Ollama服务卸载模型。
    2. **前端**: 为"停止"按钮添加与"运行"按钮一致的加载状态（loading）和禁用逻辑，以提供明确的交互反馈并防止重复点击。

### 6. 模型下载错误处理

- **问题**: 在模型下载过程中出现服务器错误（如版本不兼容）时，系统错误地报告下载完成。
- **根源**: 下载过程中的流式错误没有被正确识别和处理，导致即使出现错误也发送下载完成事件。
- **解决方案**:
    1. **后端**: 在 `model_manager.go` 的 `DownloadModel` 函数中增强错误检测逻辑，能够识别下载流中的错误消息。
    2. **实现**: 一旦检测到错误消息，立即中断下载过程并向前端发送错误事件，而不是发送下载完成事件。
    3. **前端**: 保持现有错误处理逻辑，确保错误信息能正确显示给用户。

## 待处理事项

### 功能完善
- [ ] 下载失败时显示具体失败原因，避免因版本不兼容等问题导致的调试困难
- [ ] 完善模型测试区域的流式响应支持
- [ ] 实现下载队列的持久化存储
- [ ] 增加模型参数的预设模板功能
- [ ] 实现模型性能监控和统计

### 界面优化
- [ ] 优化移动端适配（响应式设计增强）
- [ ] 增加暗色主题支持（与系统主题同步）
- [ ] 优化表单验证提示（实时验证反馈）
- [ ] 增加操作快捷键支持（Ctrl+R 刷新等）
- [ ] 优化模型列表排序功能（多列排序支持）
- [ ] 完善模型详情抽屉的国际化支持
- [ ] 优化下载进度显示（增加速度和剩余时间）

### 性能优化
- [ ] 实现模型列表虚拟滚动（大量模型时的性能优化）
- [ ] 优化模型搜索性能（防抖动和缓存机制）
- [ ] 增加配置缓存机制（减少重复请求）
- [ ] 优化数据加载性能（分页加载支持）
- [ ] 实现模型状态实时更新（WebSocket 支持）
- [ ] 优化内存使用（清理无用缓存数据）

### 用户体验优化
- [ ] 增加操作确认对话框（删除模型等危险操作）
- [ ] 实现操作历史记录和撤销功能
- [ ] 增加模型收藏和标签管理功能
- [ ] 实现模型使用统计和分析
- [ ] 增加帮助文档和操作指引

### 技术优化
- [ ] 实现组件懒加载（减少初始加载时间）
- [ ] 增加单元测试覆盖率
- [ ] 优化错误边界处理
- [ ] 实现配置数据的导入导出功能
- [ ] 增加日志系统和调试支持
