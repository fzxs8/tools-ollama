# ModelManager APIæ¥å£æ–‡æ¡£

## 1. Architectureï¼ˆæ¶æ„è®¾è®¡ï¼‰

### 1.1 APIæ¶æ„æ¦‚è¿°
ModelManager æ¨¡å—é‡‡ç”¨ Wails v2 çš„å‰åç«¯é€šä¿¡æœºåˆ¶ï¼Œé€šè¿‡ Go ç»“æ„ä½“æ–¹æ³•æš´éœ² API æ¥å£ï¼Œå‰ç«¯é€šè¿‡è‡ªåŠ¨ç”Ÿæˆçš„ TypeScript ç»‘å®šè¿›è¡Œè°ƒç”¨ã€‚

### 1.2 æ¥å£åˆ†ç±»
```
ModelManager API
â”œâ”€â”€ æ¨¡å‹ç®¡ç†ç±»
â”‚   â”œâ”€â”€ ListModelsByServer
â”‚   â”œâ”€â”€ RunModel / StopModel
â”‚   â””â”€â”€ DeleteModel / TestModel
â”œâ”€â”€ å‚æ•°é…ç½®ç±»
â”‚   â”œâ”€â”€ GetModelParams
â”‚   â””â”€â”€ SetModelParams
â”œâ”€â”€ ä¸‹è½½ç®¡ç†ç±»
â”‚   â””â”€â”€ DownloadModel
â”œâ”€â”€ æœåŠ¡å™¨ç®¡ç†ç±»
â”‚   â”œâ”€â”€ GetServers / GetActiveServer
â”‚   â””â”€â”€ SetActiveServer
â””â”€â”€ åœ¨çº¿æœç´¢ç±»
    â””â”€â”€ SearchOnlineModels
```

## 2. Analysisï¼ˆéœ€æ±‚åˆ†æï¼‰

### 2.1 APIéœ€æ±‚ä¼˜å…ˆçº§
| ä¼˜å…ˆçº§ | APIç±»åˆ« | æ¥å£æ•°é‡ | å¤æ‚åº¦ | çŠ¶æ€ |
|--------|----------|----------|----------|------|
| P0 | æ¨¡å‹ç®¡ç† | 5 | ä¸­ | âœ… å·²ä¼˜åŒ– |
| P0 | æœåŠ¡å™¨ç®¡ç† | 3 | ä½ | âœ… å·²å®Œæˆ |
| P1 | å‚æ•°é…ç½® | 2 | ä½ | âœ… å·²å®Œæˆ |
| P1 | ä¸‹è½½ç®¡ç† | 1 | é«˜ | âœ… å·²ä¼˜åŒ– |
| P2 | åœ¨çº¿æœç´¢ | 1 | ä¸­ | âœ… å·²å®Œæˆ |

### 2.2 å…³é”®ä¿®å¤éœ€æ±‚
**HTTPå®¢æˆ·ç«¯åˆå§‹åŒ–é—®é¢˜**:
- **é—®é¢˜**: `rebuildDependencies()` å‡½æ•°ä¸ºç©ºï¼Œå¯¼è‡´ "unsupported protocol scheme" é”™è¯¯
- **å½±å“**: æ¨¡å‹è¿è¡Œå¤±è´¥ï¼Œæ˜¾ç¤º "undefined" é”™è¯¯
- **è§£å†³**: å®ç°å®Œæ•´çš„HTTPå®¢æˆ·ç«¯åˆå§‹åŒ–é€»è¾‘
- **çŠ¶æ€**: âœ… å·²ä¿®å¤

## 3. Architectureï¼ˆæ¥å£æ¶æ„ï¼‰

### 3.1 æ¨¡å‹ç®¡ç†æ¥å£

#### 3.1.1 ListModelsByServer **[å·²ä¼˜åŒ–]**
è·å–æŒ‡å®šæœåŠ¡å™¨ä¸Šçš„æ¨¡å‹åˆ—è¡¨ã€‚

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
import { ListModelsByServer } from '../../wailsjs/go/main/App'

ListModelsByServer(serverID: string): Promise<Model[]>
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| serverID | string | æ˜¯ | æœåŠ¡å™¨IDï¼Œç”¨äºæŒ‡å®šæŸ¥è¯¢çš„OllamaæœåŠ¡å™¨ |

**è¿”å›å€¼è¯´æ˜**ï¼š

| ç±»å‹ | è¯´æ˜ |
|------|------|
| Model[] | æ¨¡å‹åˆ—è¡¨æ•°ç»„ï¼ŒåŒ…å«å®Œæ•´çš„æ¨¡å‹ä¿¡æ¯å’Œè¿è¡ŒçŠ¶æ€ |

**åç«¯å®ç°**ï¼š
```go
// ListModelsByServer è·å–æŒ‡å®šæœåŠ¡å™¨çš„æ¨¡å‹åˆ—è¡¨
func (a *App) ListModelsByServer(serverID string) ([]types.Model, error) {
    return a.modelManager.ListModelsByServer(serverID)
}
```

**ModelManager.ListModelsByServer å®ç°**:
```go
// ListModelsByServer è·å–æŒ‡å®šæœåŠ¡å™¨çš„æ¨¡å‹åˆ—è¡¨
func (m *ModelManager) ListModelsByServer(serverID string) ([]types.Model, error) {
    m.logger.Debug("å¼€å§‹è·å–æ¨¡å‹åˆ—è¡¨", "serverID", serverID)
    
    // è·å–æœåŠ¡å™¨é…ç½®
    serverConfig, err := m.configMgr.GetServerByID(serverID)
    if err != nil {
        return nil, err
    }

    // åˆ›å»ºä¸´æ—¶HTTPå®¢æˆ·ç«¯
    tempClient := core.NewHttp(m.logger.WithPrefix("TempClient"))
    tempClient.Create(&core.Config{
        BaseURL: serverConfig.BaseURL,
    })

    // è°ƒç”¨Ollama API
    response, err := tempClient.Get("/api/tags", core.Options{})
    if err != nil {
        return nil, err
    }

    // è§£æå“åº”
    var result types.ListModelsResponse
    if err := json.Unmarshal([]byte(response.Body), &result); err != nil {
        return nil, err
    }

    // [å…³é”®ä¼˜åŒ–] é™„åŠ è¿è¡ŒçŠ¶æ€
    for i := range result.Models {
        result.Models[i].IsRunning = m.IsModelRunning(result.Models[i].Name)
    }

    return result.Models, nil
}
```

#### 3.1.2 RunModel **[å·²ä¿®å¤]**
è¿è¡ŒæŒ‡å®šæ¨¡å‹ã€‚

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
import { RunModel } from '../../wailsjs/go/main/App'

RunModel(modelName: string, params: ModelParams): Promise<void>
```

**å…³é”®ä¿®å¤**:
- **HTTPå®¢æˆ·ç«¯åˆå§‹åŒ–**: å®ç°äº† `rebuildDependencies()` å‡½æ•°
- **åè®®å‰ç¼€ä¿®å¤**: è‡ªåŠ¨ä¸ºBaseURLæ·»åŠ  `http://` å‰ç¼€
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—è®°å½•

```go
// [å…³é”®ä¿®å¤] rebuildDependencies å®ç°
func (a *App) rebuildDependencies() error {
    // è·å–æ´»åŠ¨æœåŠ¡å™¨é…ç½®
    activeServer, err := a.configMgr.GetActiveServer()
    if err != nil {
        // ä½¿ç”¨é»˜è®¤é…ç½®
        a.httpClient.Create(&core.Config{
            BaseURL: "http://localhost:11434",
        })
        return nil
    }
    
    // ç¡®ä¿BaseURLåŒ…å«åè®®å‰ç¼€
    baseURL := activeServer.BaseURL
    if baseURL != "" && !strings.HasPrefix(baseURL, "http://") && !strings.HasPrefix(baseURL, "https://") {
        baseURL = "http://" + baseURL
    }
    
    // é‡æ–°é…ç½®HTTPå®¢æˆ·ç«¯
    a.httpClient.Create(&core.Config{
        BaseURL: baseURL,
    })
    
    return nil
}
```

#### 3.1.3 TestModel **[å·²å®Œå–„]**
æµ‹è¯•æŒ‡å®šæ¨¡å‹ã€‚

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
import { TestModel } from '../../wailsjs/go/main/App'

TestModel(modelName: string, prompt: string): Promise<TestModelResponse>
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| modelName | string | æ˜¯ | æ¨¡å‹åç§° |
| prompt | string | æ˜¯ | æµ‹è¯•æç¤ºè¯ |

**è¿”å›å€¼è¯´æ˜**ï¼š

| ç±»å‹ | è¯´æ˜ |
|------|------|
| TestModelResponse | æµ‹è¯•å“åº”ç»“æœï¼ŒåŒ…å«å“åº”å†…å®¹å’Œé”™è¯¯ä¿¡æ¯ |

**åç«¯å®ç°**ï¼š
```go
// TestModel æµ‹è¯•æ¨¡å‹
func (a *App) TestModel(modelName, prompt string) (*types.TestModelResponse, error) {
    return a.modelManager.TestModel(modelName, prompt)
}
```

#### 3.1.4 GetDownloadTasks **[æ–°å¢]**
è·å–æ‰€æœ‰ä¸‹è½½ä»»åŠ¡ã€‚

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
import { GetDownloadTasks } from '../../wailsjs/go/main/App'

GetDownloadTasks(): Promise<DownloadTask[]>
```

**è¿”å›å€¼è¯´æ˜**ï¼š

| ç±»å‹ | è¯´æ˜ |
|------|------|
| DownloadTask[] | ä¸‹è½½ä»»åŠ¡æ•°ç»„ |

#### 3.1.5 CancelDownload **[æ–°å¢]**
å–æ¶ˆæŒ‡å®šä¸‹è½½ä»»åŠ¡ã€‚

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
import { CancelDownload } from '../../wailsjs/go/main/App'

CancelDownload(taskID: string): Promise<void>
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| taskID | string | æ˜¯ | ä¸‹è½½ä»»åŠ¡ID |

#### 3.1.6 SearchOnlineModels
æœç´¢åœ¨çº¿æ¨¡å‹ã€‚

**å‰ç«¯è°ƒç”¨**ï¼š
```typescript
import { SearchOnlineModels } from '../../wailsjs/go/main/App'

SearchOnlineModels(query: string): Promise<OnlineModel[]>
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| query | string | æ˜¯ | æœç´¢å…³é”®è¯ |

**è¿”å›å€¼è¯´æ˜**ï¼š

| ç±»å‹ | è¯´æ˜ |
|------|------|
| OnlineModel[] | åœ¨çº¿æ¨¡å‹æ•°ç»„ |

**åç«¯å®ç°**ï¼š
```go
// SearchOnlineModels æœç´¢åœ¨çº¿æ¨¡å‹
func (a *App) SearchOnlineModels(query string) ([]interface{}, error) {
    return a.modelMarket.SearchOnlineModels(query)
}
```

## 4. Applicationï¼ˆåº”ç”¨å®ç°ï¼‰

### 4.1 å®Œæ•´APIåˆ—è¡¨

| æ¥å£åç§° | æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | çŠ¶æ€ |
|----------|------|------|----------|------|
| ListModelsByServer | GET | serverID | Model[] | âœ… å·²ä¼˜åŒ– |
| RunModel | POST | modelName, params | void | âœ… å·²ä¿®å¤ |
| StopModel | POST | modelName | void | âœ… å·²å®Œæˆ |
| DeleteModel | DELETE | modelName | void | âœ… å·²å®Œæˆ |
| TestModel | POST | modelName, prompt | TestModelResponse | âœ… å·²å®Œå–„ |
| GetModelParams | GET | modelName | ModelParams | âœ… å·²å®Œæˆ |
| SetModelParams | POST | modelName, params | void | âœ… å·²å®Œæˆ |
| DownloadModel | POST | serverID, modelName | DownloadTask | âœ… å·²ä¼˜åŒ– |
| GetDownloadTasks | GET | - | DownloadTask[] | âœ… æ–°å¢ |
| CancelDownload | POST | taskID | void | âœ… æ–°å¢ |
| RetryDownload | POST | taskID | DownloadTask | âœ… æ–°å¢ |
| GetServers | GET | - | OllamaServerConfig[] | âœ… å·²å®Œæˆ |
| GetActiveServer | GET | - | OllamaServerConfig | âœ… å·²å®Œæˆ |
| SetActiveServer | POST | serverID | void | âœ… å·²å®Œæˆ |
| SearchOnlineModels | GET | query | OnlineModel[] | âœ… å·²å®Œæˆ |

### 4.2 å…³é”®ä¿®å¤å®ç°

#### HTTPå®¢æˆ·ç«¯åˆå§‹åŒ–ä¿®å¤
```go
// [å…³é”®ä¿®å¤] rebuildDependencies å®ç°
func (a *App) rebuildDependencies() error {
    a.logger.Debug("å¼€å§‹é‡å»ºåº”ç”¨ä¾èµ–")
    
    activeServer, err := a.configMgr.GetActiveServer()
    if err != nil {
        a.logger.Warn("æœªæ‰¾åˆ°æ´»åŠ¨æœåŠ¡å™¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
        a.httpClient.Create(&core.Config{
            BaseURL: "http://localhost:11434",
        })
        return nil
    }
    
    // ç¡®ä¿BaseURLåŒ…å«åè®®å‰ç¼€
    baseURL := activeServer.BaseURL
    if baseURL != "" && !strings.HasPrefix(baseURL, "http://") && !strings.HasPrefix(baseURL, "https://") {
        baseURL = "http://" + baseURL
    }
    
    a.httpClient.Create(&core.Config{
        BaseURL: baseURL,
    })
    
    return nil
}
```

## 5. Assuranceï¼ˆè´¨é‡ä¿è¯ï¼‰

### 5.1 APIè´¨é‡ä¿è¯
- **å‚æ•°éªŒè¯**: å‰åç«¯åŒé‡éªŒè¯
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯ç å’Œä¿¡æ¯
- **æ—¥å¿—è®°å½•**: å®Œæ•´çš„è°ƒç”¨é“¾è·¯è·Ÿè¸ª
- **æ€§èƒ½ç›‘æ§**: å“åº”æ—¶é—´å’Œèµ„æºä½¿ç”¨ç›‘æ§

### 5.2 æ•°æ®ä¸€è‡´æ€§ä¿è¯
- **å­—æ®µæ˜ å°„**: å‰åç«¯å­—æ®µåå®Œå…¨ä¸€è‡´
- **ç±»å‹å®‰å…¨**: TypeScript ç±»å‹æ£€æŸ¥ä¿è¯
- **æ•°æ®æ ¼å¼**: ç»Ÿä¸€çš„æ—¥æœŸã€æ•°å€¼æ ¼å¼

## 6. Actionï¼ˆè¡ŒåŠ¨è®¡åˆ’ï¼‰

### 6.1 å·²å®Œæˆä¼˜åŒ–
- âœ… HTTPå®¢æˆ·ç«¯åˆå§‹åŒ–ä¿®å¤
- âœ… æ¨¡å‹è¿è¡ŒçŠ¶æ€ç®¡ç†ä¼˜åŒ–
- âœ… ä¸‹è½½è¿›åº¦è·Ÿè¸ªä¼˜åŒ–
- âœ… é”™è¯¯å¤„ç†å¢å¼º

### 6.2 APIä¼˜åŒ–è®¡åˆ’
- ğŸ”„ æ‰¹é‡APIæ”¯æŒï¼ˆæ‰¹é‡åˆ é™¤ã€æ‰¹é‡ä¸‹è½½ï¼‰
- ğŸ”„ å¼‚æ­¥æ“ä½œä¼˜åŒ–ï¼ˆé•¿æ—¶é—´æ“ä½œçš„å¼‚æ­¥å¤„ç†ï¼‰
- ğŸ”„ ç¼“å­˜æœºåˆ¶å®ç°ï¼ˆAPIå“åº”ç¼“å­˜ä¼˜åŒ–ï¼‰
- ğŸ”„ ä¸‹è½½é˜Ÿåˆ—æŒä¹…åŒ–ï¼ˆæ”¯æŒåº”ç”¨é‡å¯åæ¢å¤ä¸‹è½½ï¼‰

### 6.3 é•¿æœŸè§„åˆ’
- ğŸ“… GraphQL APIæ”¯æŒï¼ˆæ›´çµæ´»çš„æ•°æ®æŸ¥è¯¢ï¼‰
- ğŸ“… å®æ—¶æ•°æ®æ¨é€ï¼ˆWebSocketæ”¯æŒï¼‰
- ğŸ“… APIç‰ˆæœ¬ç®¡ç†ï¼ˆå‘åå…¼å®¹æ€§æ”¯æŒï¼‰
- ğŸ“… APIé™æµå’Œé˜²æŠ¤ï¼ˆé˜²æ­¢æ¶æ„è°ƒç”¨ï¼‰