# ModelManager API接口文档

## 1. Architecture（架构设计）

### 1.1 API架构概述
ModelManager 模块采用 Wails v2 的前后端通信机制，通过 Go 结构体方法暴露 API 接口，前端通过自动生成的 TypeScript 绑定进行调用。

### 1.2 接口分类
```
ModelManager API
├── 模型管理类
│   ├── ListModelsByServer
│   ├── RunModel / StopModel
│   └── DeleteModel / TestModel
├── 参数配置类
│   ├── GetModelParams
│   └── SetModelParams
├── 下载管理类
│   └── DownloadModel
├── 服务器管理类
│   ├── GetServers / GetActiveServer
│   └── SetActiveServer
└── 在线搜索类
    └── SearchOnlineModels
```

## 2. Analysis（需求分析）

### 2.1 API需求优先级
| 优先级 | API类别 | 接口数量 | 复杂度 | 状态 |
|--------|----------|----------|----------|------|
| P0 | 模型管理 | 5 | 中 | ✅ 已优化 |
| P0 | 服务器管理 | 3 | 低 | ✅ 已完成 |
| P1 | 参数配置 | 2 | 低 | ✅ 已完成 |
| P1 | 下载管理 | 1 | 高 | ✅ 已优化 |
| P2 | 在线搜索 | 1 | 中 | ✅ 已完成 |

### 2.2 关键修复需求
**HTTP客户端初始化问题**:
- **问题**: `rebuildDependencies()` 函数为空，导致 "unsupported protocol scheme" 错误
- **影响**: 模型运行失败，显示 "undefined" 错误
- **解决**: 实现完整的HTTP客户端初始化逻辑
- **状态**: ✅ 已修复

## 3. Architecture（接口架构）

### 3.1 模型管理接口

#### 3.1.1 ListModelsByServer **[已优化]**
获取指定服务器上的模型列表。

**前端调用**：
```typescript
import { ListModelsByServer } from '../../wailsjs/go/main/App'

ListModelsByServer(serverID: string): Promise<Model[]>
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serverID | string | 是 | 服务器ID，用于指定查询的Ollama服务器 |

**返回值说明**：

| 类型 | 说明 |
|------|------|
| Model[] | 模型列表数组，包含完整的模型信息和运行状态 |

**后端实现**：
```go
// ListModelsByServer 获取指定服务器的模型列表
func (a *App) ListModelsByServer(serverID string) ([]types.Model, error) {
    return a.modelManager.ListModelsByServer(serverID)
}
```

**ModelManager.ListModelsByServer 实现**:
```go
// ListModelsByServer 获取指定服务器的模型列表
func (m *ModelManager) ListModelsByServer(serverID string) ([]types.Model, error) {
    m.logger.Debug("开始获取模型列表", "serverID", serverID)
    
    // 获取服务器配置
    serverConfig, err := m.configMgr.GetServerByID(serverID)
    if err != nil {
        return nil, err
    }

    // 创建临时HTTP客户端
    tempClient := core.NewHttp(m.logger.WithPrefix("TempClient"))
    tempClient.Create(&core.Config{
        BaseURL: serverConfig.BaseURL,
    })

    // 调用Ollama API
    response, err := tempClient.Get("/api/tags", core.Options{})
    if err != nil {
        return nil, err
    }

    // 解析响应
    var result types.ListModelsResponse
    if err := json.Unmarshal([]byte(response.Body), &result); err != nil {
        return nil, err
    }

    // [关键优化] 附加运行状态
    for i := range result.Models {
        result.Models[i].IsRunning = m.IsModelRunning(result.Models[i].Name)
    }

    return result.Models, nil
}
```

#### 3.1.2 RunModel **[已修复]**
运行指定模型。

**前端调用**：
```typescript
import { RunModel } from '../../wailsjs/go/main/App'

RunModel(modelName: string, params: ModelParams): Promise<void>
```

**关键修复**:
- **HTTP客户端初始化**: 实现了 `rebuildDependencies()` 函数
- **协议前缀修复**: 自动为BaseURL添加 `http://` 前缀
- **错误处理**: 完善的错误信息和日志记录

```go
// [关键修复] rebuildDependencies 实现
func (a *App) rebuildDependencies() error {
    // 获取活动服务器配置
    activeServer, err := a.configMgr.GetActiveServer()
    if err != nil {
        // 使用默认配置
        a.httpClient.Create(&core.Config{
            BaseURL: "http://localhost:11434",
        })
        return nil
    }
    
    // 确保BaseURL包含协议前缀
    baseURL := activeServer.BaseURL
    if baseURL != "" && !strings.HasPrefix(baseURL, "http://") && !strings.HasPrefix(baseURL, "https://") {
        baseURL = "http://" + baseURL
    }
    
    // 重新配置HTTP客户端
    a.httpClient.Create(&core.Config{
        BaseURL: baseURL,
    })
    
    return nil
}
```

#### 3.1.3 TestModel **[已完善]**
测试指定模型。

**前端调用**：
```typescript
import { TestModel } from '../../wailsjs/go/main/App'

TestModel(modelName: string, prompt: string): Promise<TestModelResponse>
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| modelName | string | 是 | 模型名称 |
| prompt | string | 是 | 测试提示词 |

**返回值说明**：

| 类型 | 说明 |
|------|------|
| TestModelResponse | 测试响应结果，包含响应内容和错误信息 |

**后端实现**：
```go
// TestModel 测试模型
func (a *App) TestModel(modelName, prompt string) (*types.TestModelResponse, error) {
    return a.modelManager.TestModel(modelName, prompt)
}
```

#### 3.1.4 GetDownloadTasks **[新增]**
获取所有下载任务。

**前端调用**：
```typescript
import { GetDownloadTasks } from '../../wailsjs/go/main/App'

GetDownloadTasks(): Promise<DownloadTask[]>
```

**返回值说明**：

| 类型 | 说明 |
|------|------|
| DownloadTask[] | 下载任务数组 |

#### 3.1.5 CancelDownload **[新增]**
取消指定下载任务。

**前端调用**：
```typescript
import { CancelDownload } from '../../wailsjs/go/main/App'

CancelDownload(taskID: string): Promise<void>
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| taskID | string | 是 | 下载任务ID |

#### 3.1.6 SearchOnlineModels
搜索在线模型。

**前端调用**：
```typescript
import { SearchOnlineModels } from '../../wailsjs/go/main/App'

SearchOnlineModels(query: string): Promise<OnlineModel[]>
```

**参数说明**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| query | string | 是 | 搜索关键词 |

**返回值说明**：

| 类型 | 说明 |
|------|------|
| OnlineModel[] | 在线模型数组 |

**后端实现**：
```go
// SearchOnlineModels 搜索在线模型
func (a *App) SearchOnlineModels(query string) ([]interface{}, error) {
    return a.modelMarket.SearchOnlineModels(query)
}
```

## 4. Application（应用实现）

### 4.1 完整API列表

| 接口名称 | 方法 | 参数 | 返回值 | 状态 |
|----------|------|------|----------|------|
| ListModelsByServer | GET | serverID | Model[] | ✅ 已优化 |
| RunModel | POST | modelName, params | void | ✅ 已修复 |
| StopModel | POST | modelName | void | ✅ 已完成 |
| DeleteModel | DELETE | modelName | void | ✅ 已完成 |
| TestModel | POST | modelName, prompt | TestModelResponse | ✅ 已完善 |
| GetModelParams | GET | modelName | ModelParams | ✅ 已完成 |
| SetModelParams | POST | modelName, params | void | ✅ 已完成 |
| DownloadModel | POST | serverID, modelName | DownloadTask | ✅ 已优化 |
| GetDownloadTasks | GET | - | DownloadTask[] | ✅ 新增 |
| CancelDownload | POST | taskID | void | ✅ 新增 |
| RetryDownload | POST | taskID | DownloadTask | ✅ 新增 |
| GetServers | GET | - | OllamaServerConfig[] | ✅ 已完成 |
| GetActiveServer | GET | - | OllamaServerConfig | ✅ 已完成 |
| SetActiveServer | POST | serverID | void | ✅ 已完成 |
| SearchOnlineModels | GET | query | OnlineModel[] | ✅ 已完成 |

### 4.2 关键修复实现

#### HTTP客户端初始化修复
```go
// [关键修复] rebuildDependencies 实现
func (a *App) rebuildDependencies() error {
    a.logger.Debug("开始重建应用依赖")
    
    activeServer, err := a.configMgr.GetActiveServer()
    if err != nil {
        a.logger.Warn("未找到活动服务器，使用默认配置")
        a.httpClient.Create(&core.Config{
            BaseURL: "http://localhost:11434",
        })
        return nil
    }
    
    // 确保BaseURL包含协议前缀
    baseURL := activeServer.BaseURL
    if baseURL != "" && !strings.HasPrefix(baseURL, "http://") && !strings.HasPrefix(baseURL, "https://") {
        baseURL = "http://" + baseURL
    }
    
    a.httpClient.Create(&core.Config{
        BaseURL: baseURL,
    })
    
    return nil
}
```

## 5. Assurance（质量保证）

### 5.1 API质量保证
- **参数验证**: 前后端双重验证
- **错误处理**: 统一的错误码和信息
- **日志记录**: 完整的调用链路跟踪
- **性能监控**: 响应时间和资源使用监控

### 5.2 数据一致性保证
- **字段映射**: 前后端字段名完全一致
- **类型安全**: TypeScript 类型检查保证
- **数据格式**: 统一的日期、数值格式

## 6. Action（行动计划）

### 6.1 已完成优化
- ✅ HTTP客户端初始化修复
- ✅ 模型运行状态管理优化
- ✅ 下载进度跟踪优化
- ✅ 错误处理增强

### 6.2 API优化计划
- 🔄 批量API支持（批量删除、批量下载）
- 🔄 异步操作优化（长时间操作的异步处理）
- 🔄 缓存机制实现（API响应缓存优化）
- 🔄 下载队列持久化（支持应用重启后恢复下载）

### 6.3 长期规划
- 📅 GraphQL API支持（更灵活的数据查询）
- 📅 实时数据推送（WebSocket支持）
- 📅 API版本管理（向后兼容性支持）
- 📅 API限流和防护（防止恶意调用）