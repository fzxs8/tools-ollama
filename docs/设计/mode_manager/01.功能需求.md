# ModelManager 页面功能需求

## 1. Architecture（架构设计）

### 1.1 页面概述
ModelManager 页面是 Ollama 模型管理工具的核心功能模块，采用 Vue 3 + TypeScript + Element Plus 技术栈构建。主要用于管理本地和远程 Ollama 服务器上的大语言模型。

### 1.2 技术架构
- **前端框架**: Vue 3 Composition API + TypeScript
- **UI组件库**: Element Plus
- **状态管理**: Vue 3 Reactive API
- **后端服务**: Go + Wails v2 + duolasdk
- **数据存储**: SQLite + 内存缓存
- **国际化**: Vue I18n

### 1.3 核心组件
```
ModelManager 模块
├── ModelManager.vue (主组件)
├── model_manager.go (后端服务)
├── types.go (数据结构)
└── ollama_config.go (配置管理)
```

## 2. Analysis（需求分析）

### 2.1 用户群体分析
- **主要用户**: AI模型开发者、研究人员、系统管理员
- **使用场景**: 本地模型部署、远程模型管理、批量操作、模型测试
- **核心需求**: 高效管理、实时监控、精确控制、稳定运行

### 2.2 功能需求优先级矩阵
| 优先级 | 功能模块 | 业务价值 | 实现复杂度 | 状态 |
|--------|----------|----------|------------|------|
| P0 | 模型列表管理 | 高 | 低 | ✅ 已完成 |
| P0 | 模型运行控制 | 高 | 中 | ✅ 已优化 |
| P0 | 模型详情查看 | 高 | 低 | ✅ 已优化 |
| P1 | 模型下载管理 | 中 | 高 | ✅ 已优化 |
| P1 | 参数配置管理 | 中 | 中 | ✅ 已完成 |
| P2 | 模型测试功能 | 中 | 低 | ✅ 已完成 |
| P2 | 多服务器支持 | 低 | 中 | ✅ 已完成 |

## 3. Architecture（架构设计）

### 3.1 核心功能架构

#### 3.1.1 多服务器支持

#### 服务器选择
- 提供下拉菜单选择当前操作的服务器。
- 支持本地服务和多个远程服务切换。
- 服务器切换时自动刷新模型列表。

#### 服务器状态同步
- **[已优化]** 页面加载时，应自动查询并默认选中在 `OllamaSettings` 页面中被设为"活动"的服务器。
- 如果未找到活动服务器或获取失败，则默认选中"本地服务"作为备选项。

#### 3.1.2 模型列表管理

#### 模型展示
- 以表格形式展示模型信息。
- 显示模型名称、大小、修改时间。
- 显示模型运行状态（运行中/未运行）。
- 提供刷新按钮更新模型列表。

#### 模型状态管理
- **[已优化]** Go后端是模型运行状态的唯一权威来源，确保刷新列表后，正在运行的模型的"运行中"状态不会丢失。
- 前端应直接使用后端返回的状态，无需进行二次处理。

#### 3.1.3 模型详情管理

**[重大优化]** 模型详情展示统一化，移除重复内容，完善国际化支持

#### 模型详情抽屉
- 点击"查看"按钮打开模型详情抽屉。
- 展示模型详细信息（名称、大小、修改时间、运行状态）。
- 提供模型操作按钮和参数配置表单。

#### 模型操作
- **运行模型**：
  - **[已优化]** 点击"运行"按钮后，按钮应立即进入加载状态（loading）并被禁用，以防止重复点击。
  - 启动请求完成后，按钮恢复正常状态。
  - **[已优化]** "运行"按钮与"停止"按钮应根据模型运行状态互斥显示。模型未运行时，显示"运行"；模型运行时，显示"停止"。
- **停止模型**：
  - **[已优化]** 点击"停止"按钮后，按钮应立即进入加载状态（loading）并被禁用，以防止重复点击。
  - 停止请求完成后，按钮恢复正常状态。
- **删除模型**：从服务器删除模型，并提供二次确认。
- **[已优化]** **测试模型**：
  - 测试功能区应布局在"模型参数"下方。
  - 提供一个文本输入框，允许用户输入自定义的测试内容（prompt）。
  - 提供一个"发送测试"按钮，点击后进入加载状态。
  - 在按钮下方提供一个美观的结果展示区（如卡片），用于清晰地显示模型的返回结果或错误信息。

#### 3.1.4 模型参数配置

#### 参数配置表单
- 提供温度（Temperature）滑块配置。
- 提供 Top P 滑块配置。
- 提供上下文大小数字输入框。
- 提供保存参数按钮。

#### 参数管理
- 加载模型默认参数或已保存参数。
- 支持保存参数配置。
- 参数在运行模型时应用。

#### 3.1.5 模型搜索功能

#### 搜索抽屉
- 点击"搜索模型"按钮打开搜索抽屉。
- 提供模型名称搜索输入框。
- 提供模型家族和标签筛选（待实现）。
- 搜索结果按模型家族分组展示。

#### 搜索结果
- 显示模型名称和大小。
- 提供下载按钮（待实现完整功能）。
- 支持从搜索结果刷新模型列表。

#### 3.1.6 模型下载功能

#### 下载流程
- **[已优化]** 用户可以通过模型搜索或手动输入模型名称来启动下载。
- **[已优化]** 下载请求发送到指定的Ollama服务器（本地或远程）。
- **[已优化]** 下载过程中实时显示进度信息。
- **[已优化]** 下载完成后自动刷新模型列表。

#### 错误处理
- **[已优化]** 能够正确识别和处理下载过程中的各种错误，包括：
  - 网络连接错误
  - 模型不存在错误
  - Ollama版本不兼容错误
  - 服务器内部错误
- **[已优化]** 出现错误时立即通知用户，而不是错误地报告下载完成。
- **[已优化]** 提供清晰的错误信息帮助用户理解问题原因。

#### 3.1.7 模型测试功能 **[已完善]**

#### 测试区域设计
- **布局位置**: 位于模型详情抽屉的"模型参数"配置区域下方
- **输入区域**: 提供多行文本输入框，支持自定义测试内容（prompt）
- **操作按钮**: "发送测试"按钮，点击后进入加载状态，防止重复提交
- **结果展示**: 美观的卡片式结果展示区，清晰显示模型返回结果或错误信息

#### 测试流程优化
- **默认提示词**: 预设友好的中文测试提示词
- **实时反馈**: 测试过程中显示加载状态和进度指示
- **错误处理**: 完善的错误捕获和用户友好的错误信息展示
- **结果格式化**: 支持多种格式的结果展示（文本、JSON等）

#### 3.1.8 下载队列管理功能

#### 下载队列抽屉
- 点击"下载队列"按钮打开下载队列管理抽屉
- 实时显示所有正在进行的下载任务
- 显示每个任务的详细进度信息和状态
- 支持取消正在进行的下载任务

#### 进度跟踪优化
- **实时进度**: 通过事件机制实时更新下载进度
- **状态管理**: 准确跟踪下载状态（进行中、已完成、已失败、已取消）
- **错误恢复**: 支持失败任务的重试机制
- **批量管理**: 支持批量取消和重试操作

#### 3.1.9 在线模型市场功能

#### 模型搜索抽屉
- 点击"搜索模型"按钮打开在线模型搜索抽屉
- 提供模型名称搜索输入框，支持实时搜索
- 搜索结果按模型家族分组展示，便于浏览
- 显示模型的基本信息（名称、大小、描述等）

#### 在线模型下载
- 支持从搜索结果直接下载在线模型
- 集成到统一的下载队列管理系统
- 下载完成后自动刷新本地模型列表
- 提供下载进度的实时反馈

### 3.2 关键修复记录

**修改时间字段映射修复**:
- **问题**: 前端使用 `modifiedAt`，后端API返回 `modified_at`
- **影响**: 导致显示 "Invalid Date Invalid Date"
- **解决**: 统一使用 `modified_at` 字段名
- **状态**: ✅ 已修复

```go
// 修复后的结构体
type Model struct {
    Name       string `json:"name"`
    Model      string `json:"model"`
    ModifiedAt string `json:"modified_at"` // 修复字段映射
    Size       int64  `json:"size"`
    Digest     string `json:"digest"`
    Details    map[string]interface{} `json:"details"`
    IsRunning  bool   `json:"isRunning"`
}
```

## 4. Application（应用实现）

### 4.1 数据结构设计

#### 模型数据结构
```typescript
interface Model {
  name: string;              // 模型名称
  model: string;             // 模型 ID
  size: number;              // 模型大小（字节）
  modified_at: string;       // [已修复] 修改时间
  digest: string;            // 模型摘要
  details: object;           // [新增] 详细信息
  isRunning: boolean;        // [优化] 运行状态
}
```

### 4.2 交互逻辑实现

#### 页面加载流程
1. **[优化]** 加载可用服务器列表（本地+远程）。
2. **[优化]** 调用后端接口，获取在"设置"中指定的活动服务器。
3. **[优化]** 将下拉列表的默认选中项设置为活动服务器，若无则默认为本地。
4. **[优化]** 根据选中的服务器，调用后端接口获取模型列表（列表已包含准确的运行状态）。
5. 加载搜索相关数据。

#### 模型运行流程
1. 打开模型详情抽屉。
2. 点击"运行"按钮，按钮进入加载状态并禁用。
3. 调用 `RunModel` 接口。
4. 接口返回后，按钮恢复。
5. 成功后更新模型状态为"运行中"，并切换显示"停止"按钮。
6. 显示成功消息。

#### 模型停止流程
1. 打开模型详情抽屉（模型处于运行状态）。
2. 点击"停止"按钮，按钮进入加载状态并禁用。
3. 调用 `StopModel` 接口。
4. 接口返回后，按钮恢复。
5. 成功后更新模型状态为"未运行"，并切换显示"运行"按钮。
6. 显示成功消息。

#### 模型测试流程
1. 打开模型详情抽屉。
2. 在"测试内容"输入框中输入文本。
3. 点击"发送测试"按钮，按钮和结果区进入加载状态。
4. 调用 `TestModel` 接口，并传递自定义的测试内容。
5. 接口返回后，加载状态结束。
6. 在结果区显示模型返回的完整内容或错误信息。

## 5. Assurance（质量保证）

### 5.1 状态管理保证

#### 模型运行状态保证
- **单一数据源**: Go后端通过内存 `runningModels` map 维护权威状态
- **实时同步**: 前端每次请求都获取最新状态
- **数据一致性**: 确保前后端状态完全一致

### 5.2 错误处理保证
- **网络异常**: 完善的超时和重试机制
- **数据验证**: 前后端双重验证保证
- **用户反馈**: 明确的错误信息和操作指引

### 5.3 性能保证
- **响应时间**: 模型列表加载 < 2s
- **内存使用**: 优化数据结构，减少内存占用
- **并发处理**: 支持多模型并发操作

## 6. Action（行动计划）

### 6.1 已完成优化
- ✅ 修改时间字段映射修复
- ✅ 模型详情展示统一化
- ✅ 国际化支持完善
- ✅ 状态管理优化
- ✅ 错误处理增强

### 6.2 近期计划
- 🔄 性能优化（虚拟滚动、缓存机制）
- 🔄 移动端适配优化
- 🔄 批量操作功能

### 6.3 长期规划
- 📅 模型版本管理
- 📅 模型性能监控
- 📅 自动化部署支持