# PromptEngineering 功能需求

## 1. Architecture（架构设计）

### 1.1 模块概述
PromptEngineering 是一个专门用于提示词工程的核心模块，采用 Vue 3 + TypeScript + Element Plus 技术栈构建。帮助用户创建、优化和管理提示词，提供直观的界面让用户能够快速生成初始提示词，对其进行调优，并支持多模型对比测试，以找到最佳的提示词配置。

### 1.2 技术架构
- **前端框架**: Vue 3 Composition API + TypeScript
- **UI组件库**: Element Plus
- **状态管理**: Vue 3 Reactive API
- **后端服务**: Go + Wails v2 + duolasdk
- **数据存储**: SQLite + 内存缓存
- **国际化**: Vue I18n
- **AI服务**: duolasdk/core/ai 包

### 1.3 核心组件
```
PromptEngineering 模块
├── PromptEngineering.vue (主组件)
├── components/
│   └── ModelSelector.vue (模型选择器)
├── prompt_engineering.go (后端服务)
└── types.go (数据结构)
```

## 2. Analysis（需求分析）

### 2.1 用户群体分析
- **主要用户**: AI研究人员、提示词工程师、内容创作者、开发者
- **使用场景**: 提示词创建、多模型对比、提示词优化、批量管理
- **核心需求**: 高效生成、实时预览、多模型支持、版本管理

### 2.2 功能需求优先级矩阵
| 优先级 | 功能模块 | 业务价值 | 实现复杂度 | 状态 |
|--------|----------|----------|------------|------|
| P0 | 流式生成提示词 | 高 | 高 | ✅ 已完成 |
| P0 | 多模型并行生成 | 高 | 中 | ✅ 已完成 |
| P0 | 提示词CRUD管理 | 高 | 中 | ✅ 已完成 |
| P1 | 事件驱动架构 | 中 | 高 | ✅ 已完成 |
| P1 | 单模型重新生成 | 中 | 低 | ✅ 已完成 |
| P2 | 提示词优化功能 | 中 | 中 | 🔄 待完善 |
| P2 | 标签分类管理 | 低 | 低 | ✅ 已完成 |

### 2.3 竞品分析
| 产品 | 优势 | 劣势 | 差异化策略 |
|------|------|------|------------|
| ChatGPT Playground | 界面简洁，响应快速 | 单模型，无本地化 | 多模型对比，本地部署 |
| Anthropic Console | 提示词优化建议 | 云端依赖，成本高 | 离线使用，免费开源 |
| OpenAI Playground | 参数调节丰富 | 复杂度高，学习成本 | 简化操作，智能预设 |

### 2.4 用户旅程分析
#### 新手用户旅程
1. **发现阶段**: 通过工具集成发现功能
2. **学习阶段**: 查看示例提示词，理解基本概念
3. **尝试阶段**: 输入简单想法，体验生成过程
4. **成长阶段**: 学会多模型对比，保存常用提示词
5. **熟练阶段**: 使用高级功能，优化提示词效果

#### 专家用户旅程
1. **快速创建**: 直接输入复杂需求
2. **批量测试**: 同时测试多个模型
3. **精细调优**: 使用优化功能改进效果
4. **管理维护**: 分类管理大量提示词
5. **分享协作**: 导出分享优质提示词

### 2.5 技术约束分析
#### 性能约束
- **并发限制**: 单个服务器最多3个模型同时生成
- **内存限制**: 大型模型可能占用大量内存
- **网络限制**: 远程Ollama服务依赖网络稳定性

#### 兼容性约束
- **模型兼容**: 依赖Ollama支持的模型列表
- **系统兼容**: 需要Wails v2运行环境
- **浏览器兼容**: 现代浏览器ES6+支持

#### 安全约束
- **数据隐私**: 本地存储，避免数据泄露
- **输入过滤**: 防止恶意提示词注入
- **访问控制**: 限制敏感功能访问权限

## 3. Architecture（架构设计）

### 3.1 核心功能架构

#### 3.1.1 流式提示词生成

#### 想法输入与模型选择
- **想法输入**: 多行文本输入框，支持复杂需求描述
- **服务选择**: 从已配置的Ollama服务中选择目标服务器
- **模型选择**: 支持多选，最多3个模型同时生成
- **智能验证**: 实时验证输入完整性，防止无效请求

#### 并行流式生成架构
- **并行处理**: 每个模型独立并行生成，互不影响
- **实时显示**: 打字机效果，文本逐块显示
- **状态管理**: 每个模型独立的加载状态和错误处理
- **单模型重新生成**: 支持针对单个模型的重新生成

#### 3.1.2 事件驱动架构

#### 事件系统设计
为了实现前后端的解耦和健壮通信，采用 Wails 事件总线模式：

- **前端职责**: 调用 `GeneratePromptStream` 触发生成任务
- **后端职责**: 异步执行任务，通过事件广播结果
- **事件类型**:
  - `prompt_pilot_stream`: 数据块事件
  - `prompt_pilot_stream_error`: 错误事件
  - `prompt_pilot_stream_done`: 完成事件

#### 前端事件处理
```typescript
// 组件挂载时注册事件监听器
EventsOn('prompt_pilot_stream', (data) => {
  renderedPrompt.value[data.model] += data.chunk;
});

EventsOn('prompt_pilot_stream_error', (data) => {
  generatingModels.value[data.model] = false;
  showErrorMessage(data.error);
});

EventsOn('prompt_pilot_stream_done', (data) => {
  generatingModels.value[data.model] = false;
  checkAllModelsFinished();
});
```

#### 3.1.3 提示词管理系统

#### CRUD 操作架构

#### 创建提示词 (Create)
- **触发机制**: 点击主界面「保存」按钮打开保存抽屉
- **智能预填充**: 
  - 标题: 自动截取想法前20个字符
  - 内容: 当前激活模型的生成结果
  - 关联模型: 当前选中的所有模型
- **表单验证**: 必填字段验证，防止无效数据提交
- **持久化**: 调用 `SavePrompt` API 保存到数据库

#### 读取提示词 (Read)
- **列表加载**: 组件挂载时自动调用 `ListPrompts`
- **实时更新**: CRUD 操作后自动刷新列表
- **分类显示**: 按标签分组展示，支持筛选
- **搜索功能**: 支持按名称、内容、标签搜索

#### 更新提示词 (Update)
- **编辑入口**: 列表中点击「编辑」按钮
- **表单预填充**: 自动填充现有数据到编辑表单
- **版本管理**: 自动增加版本号，记录修改时间
- **差异检测**: 只有内容变更时才执行更新操作

#### 删除提示词 (Delete)
- **安全删除**: 单次确认对话框，防止误操作
- **批量删除**: 支持多选删除功能
- **软删除**: 支持回收站机制，可恢复删除
- **关联清理**: 删除时清理相关引用和缓存

#### 高级功能
- **快速预览**: 一键加载到主界面当前视图
- **一键复制**: 快速复制完整提示词内容
- **模板化**: 支持将提示词保存为模板
- **导入导出**: 支持 JSON/Markdown 格式导入导出
- **版本对比**: 查看提示词的修改历史

## 4. Application（应用实现）

### 4.1 数据结构设计

#### 提示词数据结构
```typescript
interface Prompt {
  id: string;              // 唯一标识符
  name: string;            // 提示词名称
  content: string;         // 提示词内容
  description?: string;    // 描述信息
  tags?: string[];         // 标签列表
  models?: string[];       // 关联模型
  version: number;         // 版本号
  createdAt: number;       // 创建时间
  updatedAt: number;       // 更新时间
}
```

#### 状态管理结构
```typescript
interface PromptState {
  // 用户输入
  userIdea: string;
  selectedServerId: string;
  selectedModels: string[];
  
  // 生成状态
  isGenerating: boolean;
  generatingModels: Record<string, boolean>;
  renderedPrompt: Record<string, string>;
  activePromptTab: string;
  
  // 提示词管理
  savedPrompts: Prompt[];
  promptToSave: Partial<Prompt>;
  
  // UI 状态
  showSaveDrawer: boolean;
  showSavedPrompts: boolean;
  isSaving: boolean;
}
```

### 4.2 交互流程实现

#### 提示词生成流程
1. **输入验证**: 检查想法、服务器、模型选择
2. **状态初始化**: 设置加载状态，清空之前结果
3. **并行触发**: 为每个模型调用 `GeneratePromptStream`
4. **实时更新**: 监听事件，更新界面内容
5. **状态管理**: 跟踪每个模型的完成状态
6. **错误处理**: 显示错误信息，恢复正常状态

#### 提示词保存流程
1. **数据预填充**: 自动填充标题、内容、模型
2. **表单验证**: 检查必填字段和数据格式
3. **数据提交**: 调用 `SavePrompt` API
4. **状态更新**: 刷新列表，关闭抽屉
5. **反馈提示**: 显示成功或失败消息

### 4.3 API 设计

#### 后端 API 接口
```go
// 提示词生成
func (p *PromptEngineering) GeneratePromptStream(ctx context.Context, req GenerateRequest) error

// 提示词管理
func (p *PromptEngineering) SavePrompt(ctx context.Context, prompt Prompt) (*Prompt, error)
func (p *PromptEngineering) ListPrompts(ctx context.Context) ([]Prompt, error)
func (p *PromptEngineering) UpdatePrompt(ctx context.Context, prompt Prompt) (*Prompt, error)
func (p *PromptEngineering) DeletePrompt(ctx context.Context, id string) error

// 模型管理
func (p *PromptEngineering) GetAvailableModels(ctx context.Context, serverId string) ([]string, error)
```

#### 事件定义
```go
type StreamEvent struct {
    Model string `json:"model"`
    Chunk string `json:"chunk"`
}

type ErrorEvent struct {
    Model string `json:"model"`
    Error string `json:"error"`
}

type DoneEvent struct {
    Model string `json:"model"`
}
```

### 4.4 错误处理机制

#### 前端错误处理
```typescript
// 网络错误处理
const handleNetworkError = (error: Error) => {
  if (error.message.includes('timeout')) {
    showErrorMessage('请求超时，请检查网络连接');
  } else if (error.message.includes('connection')) {
    showErrorMessage('连接失败，请检查Ollama服务状态');
  } else {
    showErrorMessage('未知错误，请稍后重试');
  }
};

// 数据验证错误
const validateInput = () => {
  if (!userIdea.value.trim()) {
    throw new Error('请输入想法描述');
  }
  if (selectedModels.value.length === 0) {
    throw new Error('请选择至少一个模型');
  }
};
```

#### 后端错误处理
```go
// 统一错误处理
func (p *PromptEngineering) handleError(model string, err error) {
    errorMsg := "生成失败"
    
    switch {
    case strings.Contains(err.Error(), "connection refused"):
        errorMsg = "Ollama服务连接失败"
    case strings.Contains(err.Error(), "model not found"):
        errorMsg = "模型不存在或未加载"
    case strings.Contains(err.Error(), "timeout"):
        errorMsg = "请求超时"
    }
    
    p.ctx.Events.Emit("prompt_pilot_stream_error", ErrorEvent{
        Model: model,
        Error: errorMsg,
    })
}
```

## 5. Assurance（质量保证）

### 5.1 用户体验保证

#### 响应性保证
- 流式输出实时显示，无明显延迟
- 加载状态清晰，用户操作反馈及时
- 错误处理友好，提供明确的错误信息

#### 数据一致性保证
- 前后端数据结构一致
- 状态管理集中化，避免数据不同步
- 事件驱动架构保证实时性

### 5.2 性能保证
- 多模型并行处理，提高效率
- 事件驱动架构，减少轮询开销
- 组件懒加载，优化初始加载时间

### 5.3 安全性保证
- 输入验证和过滤，防止恶意输入
- 数据加密存储，保护用户隐私
- API 调用限流，防止滥用

### 5.4 测试策略

#### 单元测试
- **组件测试**: Vue Test Utils + Jest
- **API 测试**: Go testing 包 + testify
- **事件测试**: 模拟 Wails 事件系统

#### 集成测试
- **E2E 测试**: Playwright 自动化测试
- **性能测试**: 并发生成性能测试
- **兼容性测试**: 多模型兼容性验证

#### 用户验收测试
- **可用性测试**: 用户操作流程验证
- **性能测试**: 响应时间和资源占用
- **错误处理测试**: 异常情况处理验证

## 6. Action（行动计划）

### 6.1 已完成功能
- ✅ 流式提示词生成架构
- ✅ 多模型并行处理
- ✅ 事件驱动通信机制
- ✅ 完整的CRUD管理功能
- ✅ 组件统一化重构
- ✅ 响应式设计适配

### 6.2 近期计划 (1-2个月)

#### Sprint 1: 体验优化 (2周)
- 🔄 **快捷键支持**: Ctrl+Enter 快速生成，Esc 取消操作
- 🔄 **操作引导**: 新手引导流程，功能提示
- 🔄 **响应式优化**: 移动端适配，小屏幕体验
- 🔄 **加载状态优化**: 骨架屏、进度条、动画效果

#### Sprint 2: 性能优化 (2周)
- 🔄 **虚拟滚动**: 大量提示词列表性能优化
- 🔄 **缓存机制**: 模型列表、常用数据缓存
- 🔄 **懒加载**: 组件分割，按需加载
- 🔄 **内存优化**: 大文本处理，垃圾回收

#### Sprint 3: 功能完善 (2周)
- 🔄 **提示词优化**: AI 辅助改写、评分系统
- 🔄 **批量操作**: 多选删除、批量导出
- 🔄 **高级搜索**: 正则搜索、模糊匹配
- 🔄 **错误处理**: 重试机制、错误日志

### 6.3 中期规划 (3-6个月)

#### 阶段 1: 智能化提升 (2个月)
- 📅 **AI 辅助优化**: 自动分析提示词质量，提供改进建议
- 📅 **效果评估**: 提示词效果评分、A/B 测试
- 📅 **智能推荐**: 根据历史使用推荐相似提示词
- 📅 **自动分类**: AI 自动打标签、分类管理

#### 阶段 2: 协作功能 (2个月)
- 📅 **模板市场**: 内置优质模板库，社区分享
- 📅 **协作编辑**: 多用户实时协作编辑提示词
- 📅 **版本控制**: Git 风格的提示词版本管理
- 📅 **导入导出**: 支持多种格式，与其他工具集成

### 6.4 长期规划 (6个月+)

#### 阶段 1: 平台化 (3个月)
- 📅 **多语言支持**: 国际化框架，支持中英文切换
- 📅 **插件系统**: 支持第三方插件开发
- 📅 **API 开放**: RESTful API，支持外部集成
- 📅 **云同步**: 支持云端备份和同步

#### 阶段 2: 生态建设 (3个月)
- 📅 **社区建设**: 用户社区、经验分享
- 📅 **数据分析**: 用户行为分析、使用统计
- 📅 **机器学习**: 个性化推荐算法
- 📅 **企业版**: 团队管理、权限控制

### 6.5 里程碑计划

| 时间节点 | 里程碑 | 交付物 | 成功指标 |
|----------|------|--------|----------|
| 2024.01 | v1.1 体验优化 | 快捷键、引导流程 | 用户满意度 >85% |
| 2024.02 | v1.2 性能优化 | 虚拟滚动、缓存 | 加载时间 <2s |
| 2024.03 | v1.3 功能完善 | AI优化、批量操作 | 功能完整度 >90% |
| 2024.05 | v2.0 智能化 | AI辅助、效果评估 | AI准确率 >80% |
| 2024.07 | v2.1 协作版 | 模板市场、协作编辑 | 活跃用户 >1000 |
| 2024.10 | v3.0 平台版 | 多语言、插件系统 | 国际化覆盖 >5国 |

### 6.6 资源配置

#### 人力资源
- **前端开发**: 2人，负责Vue组件和UI体验
- **后端开发**: 1人，负责Go服务和API设计
- **产品设计**: 1人，负责交互设计和用户研究
- **测试工程师**: 1人，负责质量保证

#### 技术资源
- **开发环境**: Docker + K8s 集群
- **CI/CD**: GitHub Actions + 自动化测试
- **监控告警**: Prometheus + Grafana
- **日志系统**: ELK Stack

### 6.7 风险识别与应对

| 风险类型 | 风险描述 | 影响程度 | 应对策略 |
|----------|----------|----------|----------|
| 技术风险 | Ollama API 变更 | 高 | 版本兼容性设计 |
| 产品风险 | 用户需求变化 | 中 | 敏捷开发，快速迭代 |
| 资源风险 | 人力不足 | 中 | 优先级排序，分阶段交付 |
| 市场风险 | 竞品冲击 | 低 | 差异化竞争，技术领先 |
