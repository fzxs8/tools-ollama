# PromptEngineering 数据结构

## 1. Architecture（架构设计）

### 1.1 数据架构概述
PromptEngineering 模块采用分层数据架构，包含前端状态管理、后端数据模型、数据库存储和缓存层，确保数据的一致性、完整性和高性能访问。

### 1.2 数据流架构
```
前端状态层 (Vue Reactive)
    ↕
API 接口层 (Wails Binding)
    ↕
业务逻辑层 (Go Service)
    ↕
数据访问层 (Repository)
    ↕
存储层 (SQLite + Cache)
```

### 1.3 数据存储策略
- **持久化存储**: SQLite 数据库存储核心数据
- **内存缓存**: Redis/内存缓存热点数据
- **会话存储**: 浏览器 SessionStorage 存储临时状态
- **本地存储**: LocalStorage 存储用户偏好设置

## 2. Analysis（需求分析）

### 2.1 数据实体分析
| 实体 | 用途 | 存储方式 | 访问频率 |
|------|------|----------|----------|
| Prompt | 提示词核心数据 | SQLite | 高 |
| Model | 模型信息 | 内存缓存 | 高 |
| Server | 服务器配置 | SQLite | 中 |
| Tag | 标签分类 | SQLite | 中 |
| Session | 会话状态 | 内存 | 高 |

### 2.2 数据关系分析
```
Prompt (1:N) → PromptModel (N:1) → Model
Prompt (1:N) → PromptTag (N:1) → Tag
Server (1:N) → Model
```

### 2.3 数据访问模式
- **读多写少**: 提示词查询频繁，创建相对较少
- **实时性要求**: 生成过程需要实时状态更新
- **批量操作**: 支持批量导入导出操作

## 3. Architecture（数据架构）

### 3.1 前端数据结构

#### 3.1.1 核心状态接口
```typescript
// 提示词实体
interface Prompt {
  id: string;                    // 唯一标识符
  name: string;                  // 提示词名称
  content: string;               // 提示词内容
  description?: string;          // 描述信息
  tags: string[];                // 标签列表
  models: string[];              // 关联模型列表
  serverId: string;              // 服务器ID
  version: number;               // 版本号
  rating?: number;               // 评分 (1-5)
  usage: number;                 // 使用次数
  createdAt: number;             // 创建时间戳
  updatedAt: number;             // 更新时间戳
  createdBy?: string;            // 创建者
}

// 模型信息
interface Model {
  name: string;                  // 模型名称
  serverId: string;              // 所属服务器ID
  size?: string;                 // 模型大小
  family?: string;               // 模型家族
  format?: string;               // 模型格式
  parameter_size?: string;       // 参数规模
  quantization_level?: string;   // 量化级别
  modified_at?: string;          // 修改时间
}

// 服务器配置
interface Server {
  id: string;                    // 服务器ID
  name: string;                  // 服务器名称
  host: string;                  // 主机地址
  port: number;                  // 端口号
  isActive: boolean;             // 是否激活
  status: 'online' | 'offline' | 'error'; // 连接状态
  lastCheck: number;             // 最后检查时间
}

// 标签信息
interface Tag {
  name: string;                  // 标签名称
  color?: string;                // 标签颜色
  count: number;                 // 使用次数
  description?: string;          // 标签描述
}
```

#### 3.1.2 应用状态管理
```typescript
// 主应用状态
interface AppState {
  // 用户输入状态
  userInput: {
    idea: string;                // 用户想法输入
    selectedServerId: string;    // 选中的服务器ID
    selectedModels: string[];    // 选中的模型列表
  };
  
  // 生成状态
  generation: {
    isGenerating: boolean;       // 是否正在生成
    generatingModels: Record<string, boolean>; // 各模型生成状态
    renderedPrompts: Record<string, string>;   // 各模型生成结果
    activeTab: string;           // 当前激活的标签页
    progress: Record<string, number>; // 生成进度
  };
  
  // 提示词管理状态
  promptManagement: {
    prompts: Prompt[];           // 提示词列表
    filteredPrompts: Prompt[];   // 过滤后的提示词
    selectedPrompts: Prompt[];   // 选中的提示词
    searchQuery: string;         // 搜索查询
    selectedTags: string[];      // 选中的标签过滤
    sortBy: 'name' | 'createdAt' | 'updatedAt' | 'usage'; // 排序字段
    sortOrder: 'asc' | 'desc';   // 排序方向
    pagination: {
      page: number;              // 当前页码
      pageSize: number;          // 每页大小
      total: number;             // 总数量
    };
  };
  
  // UI状态
  ui: {
    showSaveDrawer: boolean;     // 显示保存抽屉
    showManagementPanel: boolean; // 显示管理面板
    showSettings: boolean;       // 显示设置面板
    loading: {
      prompts: boolean;          // 提示词加载状态
      models: boolean;           // 模型加载状态
      servers: boolean;          // 服务器加载状态
    };
    errors: {
      generation: string | null; // 生成错误信息
      network: string | null;    // 网络错误信息
      validation: string | null; // 验证错误信息
    };
  };
  
  // 系统配置
  config: {
    servers: Server[];           // 服务器列表
    models: Model[];             // 模型列表
    tags: Tag[];                 // 标签列表
    settings: {
      theme: 'light' | 'dark';   // 主题模式
      language: 'zh' | 'en';     // 语言设置
      autoSave: boolean;         // 自动保存
      maxConcurrent: number;     // 最大并发数
    };
  };
}
```

#### 3.1.3 API 请求/响应结构
```typescript
// 生成请求
interface GenerateRequest {
  idea: string;                  // 用户想法
  serverId: string;              // 服务器ID
  models: string[];              // 模型列表
  options?: {
    temperature?: number;        // 温度参数
    max_tokens?: number;         // 最大token数
    stream?: boolean;            // 是否流式输出
  };
}

// 流式响应事件
interface StreamEvent {
  model: string;                 // 模型名称
  chunk: string;                 // 文本块
  done: boolean;                 // 是否完成
  timestamp: number;             // 时间戳
}

// 错误事件
interface ErrorEvent {
  model: string;                 // 模型名称
  error: string;                 // 错误信息
  code?: string;                 // 错误代码
  timestamp: number;             // 时间戳
}

// API 响应包装
interface ApiResponse<T> {
  success: boolean;              // 是否成功
  data?: T;                      // 响应数据
  error?: string;                // 错误信息
  code?: string;                 // 错误代码
  timestamp: number;             // 时间戳
}
```

### 3.2 后端数据结构

#### 3.2.1 Go 数据模型
```go
// 提示词模型
type Prompt struct {
    ID          string    `json:"id" gorm:"primaryKey"`
    Name        string    `json:"name" gorm:"not null"`
    Content     string    `json:"content" gorm:"type:text;not null"`
    Description string    `json:"description" gorm:"type:text"`
    ServerID    string    `json:"serverId" gorm:"not null"`
    Version     int       `json:"version" gorm:"default:1"`
    Rating      *int      `json:"rating" gorm:"check:rating >= 1 AND rating <= 5"`
    Usage       int       `json:"usage" gorm:"default:0"`
    CreatedAt   time.Time `json:"createdAt" gorm:"autoCreateTime"`
    UpdatedAt   time.Time `json:"updatedAt" gorm:"autoUpdateTime"`
    CreatedBy   string    `json:"createdBy"`
    
    // 关联关系
    Tags   []Tag   `json:"tags" gorm:"many2many:prompt_tags;"`
    Models []Model `json:"models" gorm:"many2many:prompt_models;"`
}

// 模型信息
type Model struct {
    Name              string    `json:"name" gorm:"primaryKey"`
    ServerID          string    `json:"serverId" gorm:"primaryKey"`
    Size              string    `json:"size"`
    Family            string    `json:"family"`
    Format            string    `json:"format"`
    ParameterSize     string    `json:"parameter_size"`
    QuantizationLevel string    `json:"quantization_level"`
    ModifiedAt        time.Time `json:"modified_at"`
    
    // 关联关系
    Server  Server    `json:"server" gorm:"foreignKey:ServerID"`
    Prompts []Prompt  `json:"prompts" gorm:"many2many:prompt_models;"`
}

// 服务器配置
type Server struct {
    ID        string    `json:"id" gorm:"primaryKey"`
    Name      string    `json:"name" gorm:"not null"`
    Host      string    `json:"host" gorm:"not null"`
    Port      int       `json:"port" gorm:"not null"`
    IsActive  bool      `json:"isActive" gorm:"default:true"`
    Status    string    `json:"status" gorm:"default:'offline'"`
    LastCheck time.Time `json:"lastCheck" gorm:"autoUpdateTime"`
    CreatedAt time.Time `json:"createdAt" gorm:"autoCreateTime"`
    UpdatedAt time.Time `json:"updatedAt" gorm:"autoUpdateTime"`
    
    // 关联关系
    Models  []Model  `json:"models" gorm:"foreignKey:ServerID"`
    Prompts []Prompt `json:"prompts" gorm:"foreignKey:ServerID"`
}

// 标签模型
type Tag struct {
    Name        string    `json:"name" gorm:"primaryKey"`
    Color       string    `json:"color"`
    Count       int       `json:"count" gorm:"default:0"`
    Description string    `json:"description"`
    CreatedAt   time.Time `json:"createdAt" gorm:"autoCreateTime"`
    
    // 关联关系
    Prompts []Prompt `json:"prompts" gorm:"many2many:prompt_tags;"`
}
```

#### 3.2.2 关联表结构
```go
// 提示词-标签关联表
type PromptTag struct {
    PromptID string `gorm:"primaryKey"`
    TagName  string `gorm:"primaryKey"`
}

// 提示词-模型关联表
type PromptModel struct {
    PromptID  string `gorm:"primaryKey"`
    ModelName string `gorm:"primaryKey"`
    ServerID  string `gorm:"primaryKey"`
}
```

### 3.3 数据库设计

#### 3.3.1 SQLite 表结构
```sql
-- 提示词表
CREATE TABLE prompts (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    content TEXT NOT NULL,
    description TEXT,
    server_id TEXT NOT NULL,
    version INTEGER DEFAULT 1,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    usage INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_by TEXT,
    FOREIGN KEY (server_id) REFERENCES servers(id)
);

-- 服务器表
CREATE TABLE servers (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    host TEXT NOT NULL,
    port INTEGER NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    status TEXT DEFAULT 'offline',
    last_check DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 模型表
CREATE TABLE models (
    name TEXT,
    server_id TEXT,
    size TEXT,
    family TEXT,
    format TEXT,
    parameter_size TEXT,
    quantization_level TEXT,
    modified_at DATETIME,
    PRIMARY KEY (name, server_id),
    FOREIGN KEY (server_id) REFERENCES servers(id)
);

-- 标签表
CREATE TABLE tags (
    name TEXT PRIMARY KEY,
    color TEXT,
    count INTEGER DEFAULT 0,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 提示词-标签关联表
CREATE TABLE prompt_tags (
    prompt_id TEXT,
    tag_name TEXT,
    PRIMARY KEY (prompt_id, tag_name),
    FOREIGN KEY (prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_name) REFERENCES tags(name) ON DELETE CASCADE
);

-- 提示词-模型关联表
CREATE TABLE prompt_models (
    prompt_id TEXT,
    model_name TEXT,
    server_id TEXT,
    PRIMARY KEY (prompt_id, model_name, server_id),
    FOREIGN KEY (prompt_id) REFERENCES prompts(id) ON DELETE CASCADE,
    FOREIGN KEY (model_name, server_id) REFERENCES models(name, server_id) ON DELETE CASCADE
);
```

#### 3.3.2 索引设计
```sql
-- 性能优化索引
CREATE INDEX idx_prompts_created_at ON prompts(created_at DESC);
CREATE INDEX idx_prompts_updated_at ON prompts(updated_at DESC);
CREATE INDEX idx_prompts_usage ON prompts(usage DESC);
CREATE INDEX idx_prompts_rating ON prompts(rating DESC);
CREATE INDEX idx_prompts_server_id ON prompts(server_id);

-- 搜索优化索引
CREATE INDEX idx_prompts_name ON prompts(name);
CREATE INDEX idx_tags_name ON tags(name);

-- 关联查询索引
CREATE INDEX idx_prompt_tags_prompt_id ON prompt_tags(prompt_id);
CREATE INDEX idx_prompt_tags_tag_name ON prompt_tags(tag_name);
CREATE INDEX idx_prompt_models_prompt_id ON prompt_models(prompt_id);
```

## 4. Application（应用实现）

### 4.1 数据访问层

#### 4.1.1 Repository 接口
```go
// 提示词仓储接口
type PromptRepository interface {
    Create(prompt *Prompt) error
    GetByID(id string) (*Prompt, error)
    List(filter PromptFilter) ([]Prompt, error)
    Update(prompt *Prompt) error
    Delete(id string) error
    Search(query string) ([]Prompt, error)
    GetByTags(tags []string) ([]Prompt, error)
}

// 查询过滤器
type PromptFilter struct {
    ServerID   string   `json:"serverId"`
    Tags       []string `json:"tags"`
    Models     []string `json:"models"`
    SearchText string   `json:"searchText"`
    SortBy     string   `json:"sortBy"`
    SortOrder  string   `json:"sortOrder"`
    Page       int      `json:"page"`
    PageSize   int      `json:"pageSize"`
}
```

#### 4.1.2 缓存策略
```go
// 缓存管理器
type CacheManager struct {
    modelCache  map[string][]Model
    serverCache map[string]Server
    tagCache    []Tag
    mutex       sync.RWMutex
    ttl         time.Duration
}

// 缓存键定义
const (
    CacheKeyModels  = "models:%s"      // 按服务器ID缓存模型
    CacheKeyServers = "servers"        // 服务器列表
    CacheKeyTags    = "tags"           // 标签列表
    CacheKeyPrompts = "prompts:%s"     // 按查询条件缓存提示词
)
```

### 4.2 数据验证

#### 4.2.1 前端验证规则
```typescript
// 表单验证规则
const promptValidationRules = {
  name: [
    { required: true, message: '请输入提示词名称', trigger: 'blur' },
    { min: 1, max: 100, message: '名称长度在 1 到 100 个字符', trigger: 'blur' }
  ],
  content: [
    { required: true, message: '请输入提示词内容', trigger: 'blur' },
    { min: 10, max: 10000, message: '内容长度在 10 到 10000 个字符', trigger: 'blur' }
  ],
  tags: [
    { type: 'array', max: 10, message: '最多选择 10 个标签', trigger: 'change' }
  ],
  models: [
    { type: 'array', min: 1, max: 3, message: '请选择 1-3 个模型', trigger: 'change' }
  ]
};

// 数据验证函数
const validatePrompt = (prompt: Partial<Prompt>): ValidationResult => {
  const errors: string[] = [];
  
  if (!prompt.name?.trim()) {
    errors.push('提示词名称不能为空');
  }
  
  if (!prompt.content?.trim()) {
    errors.push('提示词内容不能为空');
  }
  
  if (prompt.content && prompt.content.length > 10000) {
    errors.push('提示词内容过长');
  }
  
  return {
    valid: errors.length === 0,
    errors
  };
};
```

#### 4.2.2 后端验证
```go
// 数据验证器
type PromptValidator struct{}

func (v *PromptValidator) Validate(prompt *Prompt) error {
    if strings.TrimSpace(prompt.Name) == "" {
        return errors.New("提示词名称不能为空")
    }
    
    if len(prompt.Name) > 100 {
        return errors.New("提示词名称过长")
    }
    
    if strings.TrimSpace(prompt.Content) == "" {
        return errors.New("提示词内容不能为空")
    }
    
    if len(prompt.Content) > 10000 {
        return errors.New("提示词内容过长")
    }
    
    if prompt.Rating != nil && (*prompt.Rating < 1 || *prompt.Rating > 5) {
        return errors.New("评分必须在1-5之间")
    }
    
    return nil
}
```

### 4.3 数据迁移

#### 4.3.1 版本管理
```go
// 数据库版本管理
type Migration struct {
    Version     int
    Description string
    Up          func(*gorm.DB) error
    Down        func(*gorm.DB) error
}

var migrations = []Migration{
    {
        Version:     1,
        Description: "初始化数据库结构",
        Up:          migration001Up,
        Down:        migration001Down,
    },
    {
        Version:     2,
        Description: "添加提示词评分字段",
        Up:          migration002Up,
        Down:        migration002Down,
    },
}
```

#### 4.3.2 数据导入导出
```go
// 导出格式
type ExportData struct {
    Version   string   `json:"version"`
    Timestamp int64    `json:"timestamp"`
    Prompts   []Prompt `json:"prompts"`
    Tags      []Tag    `json:"tags"`
}

// 导入验证
func ValidateImportData(data *ExportData) error {
    if data.Version == "" {
        return errors.New("缺少版本信息")
    }
    
    for _, prompt := range data.Prompts {
        if err := validator.Validate(&prompt); err != nil {
            return fmt.Errorf("提示词 %s 验证失败: %v", prompt.Name, err)
        }
    }
    
    return nil
}
```

## 5. Assurance（质量保证）

### 5.1 数据完整性
- **外键约束**: 确保关联数据的一致性
- **检查约束**: 验证数据值的有效性
- **唯一约束**: 防止重复数据
- **非空约束**: 确保必要字段不为空

### 5.2 数据安全性
- **输入验证**: 前后端双重验证
- **SQL注入防护**: 使用参数化查询
- **数据加密**: 敏感数据加密存储
- **访问控制**: 基于角色的数据访问

### 5.3 性能优化
- **索引优化**: 针对查询模式设计索引
- **缓存策略**: 热点数据内存缓存
- **分页查询**: 大数据集分页处理
- **连接池**: 数据库连接池管理

## 6. Action（行动计划）

### 6.1 数据结构实现计划

#### 阶段1: 基础结构 (1周)
- ✅ 核心数据模型定义
- ✅ 数据库表结构设计
- ✅ 基础CRUD操作
- 🔄 数据验证规则

#### 阶段2: 高级功能 (1周)
- 🔄 关联查询优化
- 🔄 缓存机制实现
- 🔄 数据导入导出
- 🔄 全文搜索功能

#### 阶段3: 性能优化 (1周)
- 📅 索引优化
- 📅 查询性能调优
- 📅 内存使用优化
- 📅 并发安全保证

### 6.2 数据治理
- **数据质量**: 定期数据质量检查
- **数据备份**: 自动化备份策略
- **数据清理**: 过期数据清理机制
- **数据监控**: 数据使用情况监控