# ChatManager API接口设计

## 1. Architecture（架构设计）

### 1.1 API架构概述
ChatManager 采用 Wails v2 框架，通过 Go 后端提供 API 接口，前端 Vue 组件通过生成的绑定函数调用后端服务。

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Vue Frontend  │───▶│  Wails Binding  │───▶│   Go Backend    │
│   (TypeScript)  │    │   (Generated)   │    │   (App Struct)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   UI Components │    │  Runtime Events │    │  Business Logic │
│   (Chat, Input) │    │  (Streaming)    │    │  (ChatManager)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 接口分类
- **聊天接口**: 消息发送、流式输出、模型调用
- **对话管理**: 对话CRUD操作、历史记录管理
- **模型管理**: 模型列表、参数配置、状态管理
- **配置接口**: 服务器配置、系统设置
- **事件接口**: 实时通信、状态同步

## 2. Analysis（接口分析）

### 2.1 接口调用模式
- **同步调用**: 配置获取、数据查询类接口
- **异步调用**: 消息发送、文件操作类接口
- **事件驱动**: 流式输出、状态变更通知
- **错误处理**: 统一的错误返回和处理机制

### 2.2 数据传输格式
- **请求格式**: JSON序列化的Go结构体
- **响应格式**: Go结构体自动转换为TypeScript类型
- **事件格式**: 通过Wails Runtime Events传输
- **错误格式**: 标准的Go error类型

## 3. Architecture（接口定义）

### 3.1 聊天相关接口

#### 3.1.1 发送聊天消息
```go
// ChatMessage 发送聊天消息到AI模型
func (a *App) ChatMessage(modelName string, messages []types.Message, stream bool) (string, error)
```

**参数说明**:
- `modelName`: 目标AI模型名称
- `messages`: 消息历史列表
- `stream`: 是否使用流式输出

**返回值**:
- `string`: 阻塞模式下返回完整响应，流式模式返回空字符串
- `error`: 错误信息

**前端调用示例**:
```typescript
// 阻塞式调用
const response = await ChatMessage(selectedModel.value, messagesWithSystemPrompt, false);

// 流式调用
await ChatMessage(selectedModel.value, messagesWithSystemPrompt, true);
// 通过事件监听接收流式数据
EventsOn("chat_stream_chunk", (data: string) => {
  // 处理流式数据片段
});
```

#### 3.1.2 流式输出事件

**事件名称**: `chat_stream_chunk`
**事件数据**: `string` - 消息内容片段
```typescript
EventsOn("chat_stream_chunk", (data: string) => {
  const lastMessageIndex = messages.value.length - 1;
  if (lastMessageIndex >= 0 && messages.value[lastMessageIndex].role === 'assistant') {
    messages.value[lastMessageIndex].content += data;
  }
});
```

**事件名称**: `chat_stream_done`
**事件数据**: 无
```typescript
EventsOn("chat_stream_done", () => {
  isThinking.value = false;
  scrollToBottom();
});
```

**事件名称**: `chat_stream_error`
**事件数据**: `string` - 错误信息
```typescript
EventsOn("chat_stream_error", (error: string) => {
  isThinking.value = false;
  // 显示错误信息
});
```

### 3.2 对话管理接口

#### 3.2.1 获取对话列表
```go
func (a *App) ListConversations() ([]*types.Conversation, error)
```

**返回值**:
- `[]*types.Conversation`: 对话列表，按时间倒序排列
- `error`: 错误信息

**前端调用**:
```typescript
const conversations = await ListConversations();
```

#### 3.2.2 保存对话
```go
func (a *App) SaveConversation(conv *types.Conversation) (*types.Conversation, error)
```

**参数说明**:
- `conv`: 对话对象，如果ID为空则创建新对话

**返回值**:
- `*types.Conversation`: 保存后的对话对象（包含生成的ID）
- `error`: 错误信息

**前端调用**:
```typescript
const savedConversation = await SaveConversation({
  messages: messages.value,
  modelName: selectedModel.value,
  title: conversationTitle,
  timestamp: Date.now()
});
```

#### 3.2.3 获取单个对话
```go
func (a *App) GetConversation(id string) (*types.Conversation, error)
```

**参数说明**:
- `id`: 对话唯一标识符

**返回值**:
- `*types.Conversation`: 对话详细信息
- `error`: 错误信息

#### 3.2.4 删除对话
```go
func (a *App) DeleteConversation(id string) error
```

**参数说明**:
- `id`: 要删除的对话ID

**返回值**:
- `error`: 错误信息

### 3.3 模型管理接口

#### 3.3.1 获取模型列表
```go
func (a *App) ListModelsByServer(serverID string) ([]types.Model, error)
```

**参数说明**:
- `serverID`: 服务器ID

**返回值**:
- `[]types.Model`: 模型列表
- `error`: 错误信息

#### 3.3.2 运行模型
```go
func (a *App) RunModel(modelName string, params map[string]interface{}) error
```

**参数说明**:
- `modelName`: 模型名称
- `params`: 模型参数配置

#### 3.3.3 停止模型
```go
func (a *App) StopModel(modelName string) error
```

#### 3.3.4 测试模型
```go
func (a *App) TestModel(modelName string, prompt string) (string, error)
```

**参数说明**:
- `modelName`: 模型名称
- `prompt`: 测试提示词

**返回值**:
- `string`: 模型响应内容
- `error`: 错误信息

### 3.4 服务器配置接口

#### 3.4.1 获取服务器列表
```go
func (a *App) GetServers() ([]types.OllamaServerConfig, error)
```

#### 3.4.2 获取活动服务器
```go
func (a *App) GetActiveServer() (*types.OllamaServerConfig, error)
```

#### 3.4.3 设置活动服务器
```go
func (a *App) SetActiveServer(serverID string) error
```

#### 3.4.4 测试服务器连接
```go
func (a *App) TestOllamaServer(baseURL string) (string, error)
```

### 3.5 系统提示词接口

#### 3.5.1 获取提示词列表
```go
func (a *App) ListPrompts() ([]types.Prompt, error)
```

#### 3.5.2 获取单个提示词
```go
func (a *App) GetPrompt(id string) (types.Prompt, error)
```

## 4. Application（应用实现）

### 4.1 错误处理机制

#### 4.1.1 统一错误处理
```typescript
async function handleApiCall<T>(apiCall: () => Promise<T>): Promise<T | null> {
  try {
    return await apiCall();
  } catch (error) {
    console.error('API调用失败:', error);
    ElMessage.error(`操作失败: ${(error as Error).message}`);
    return null;
  }
}

// 使用示例
const conversations = await handleApiCall(() => ListConversations());
if (conversations) {
  // 处理成功结果
}
```

#### 4.1.2 特定错误处理
```typescript
async function sendMessageWithErrorHandling() {
  try {
    const result = await ChatMessage(selectedModel.value, messages, stream);
    // 处理成功结果
  } catch (error: any) {
    let errorMessage = t('chatManager.sorry');
    
    if (error && error.message) {
      errorMessage += ': ' + error.message;
    } else if (typeof error === 'string') {
      errorMessage += ': ' + error;
    }
    
    // 显示错误消息
    const lastMessageIndex = messages.value.length - 1;
    if (lastMessageIndex >= 0 && messages.value[lastMessageIndex].role === 'assistant') {
      messages.value[lastMessageIndex].content = errorMessage;
    }
  }
}
```

### 4.2 数据转换和验证

#### 4.2.1 消息类型转换
```typescript
// 前端Message转换为后端期望的格式
function prepareMessagesForAPI(messages: Message[]): Message[] {
  return messages.map(msg => ({
    role: msg.role,
    content: msg.content,
    timestamp: msg.timestamp || Date.now()
  }));
}
```

#### 4.2.2 参数验证
```typescript
function validateModelParams(params: ModelParams): boolean {
  return (
    params.temperature >= 0.1 && params.temperature <= 2.0 &&
    params.topP >= 0.1 && params.topP <= 1.0 &&
    params.topK >= 1 && params.topK <= 100 &&
    params.context >= 512 && params.context <= 4096 &&
    params.numPredict >= 128 && params.numPredict <= 2048 &&
    params.repeatPenalty >= 0.5 && params.repeatPenalty <= 2.0
  );
}
```

### 4.3 缓存和性能优化

#### 4.3.1 接口缓存策略
```typescript
class APICache {
  private cache = new Map<string, { data: any; timestamp: number }>();
  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5分钟

  async getCachedOrFetch<T>(
    key: string,
    fetcher: () => Promise<T>
  ): Promise<T> {
    const cached = this.cache.get(key);
    const now = Date.now();
    
    if (cached && (now - cached.timestamp) < this.CACHE_DURATION) {
      return cached.data;
    }
    
    const data = await fetcher();
    this.cache.set(key, { data, timestamp: now });
    return data;
  }
}

// 使用示例
const apiCache = new APICache();
const models = await apiCache.getCachedOrFetch(
  `models-${selectedServer.value}`,
  () => ListModelsByServer(selectedServer.value)
);
```

#### 4.3.2 批量操作优化
```typescript
// 批量加载初始数据
async function loadInitialData() {
  const [servers, prompts, conversations] = await Promise.all([
    GetServers(),
    ListPrompts(),
    ListConversations()
  ]);
  
  // 更新状态
  availableServers.value = servers;
  systemPromptList.value = prompts;
  conversations.value = conversations;
}
```

## 5. Assurance（质量保证）

### 5.1 接口测试

#### 5.1.1 单元测试示例
```typescript
describe('ChatManager API', () => {
  test('should send message successfully', async () => {
    const mockMessages = [
      { role: 'user', content: 'Hello', timestamp: Date.now() }
    ];
    
    const result = await ChatMessage('test-model', mockMessages, false);
    expect(result).toBeDefined();
    expect(typeof result).toBe('string');
  });
  
  test('should handle API errors gracefully', async () => {
    try {
      await ChatMessage('', [], false);
    } catch (error) {
      expect(error).toBeDefined();
    }
  });
});
```

#### 5.1.2 集成测试
```typescript
describe('ChatManager Integration', () => {
  test('complete chat flow', async () => {
    // 1. 加载服务器列表
    const servers = await GetServers();
    expect(servers.length).toBeGreaterThan(0);
    
    // 2. 设置活动服务器
    await SetActiveServer(servers[0].id);
    
    // 3. 获取模型列表
    const models = await ListModelsByServer(servers[0].id);
    expect(models.length).toBeGreaterThan(0);
    
    // 4. 发送消息
    const response = await ChatMessage(models[0].name, [
      { role: 'user', content: 'test', timestamp: Date.now() }
    ], false);
    expect(response).toBeDefined();
  });
});
```

### 5.2 性能监控

#### 5.2.1 API响应时间监控
```typescript
class APIMonitor {
  private metrics = new Map<string, number[]>();
  
  async measureAPI<T>(name: string, apiCall: () => Promise<T>): Promise<T> {
    const startTime = performance.now();
    try {
      const result = await apiCall();
      const duration = performance.now() - startTime;
      this.recordMetric(name, duration);
      return result;
    } catch (error) {
      const duration = performance.now() - startTime;
      this.recordMetric(`${name}_error`, duration);
      throw error;
    }
  }
  
  private recordMetric(name: string, duration: number) {
    if (!this.metrics.has(name)) {
      this.metrics.set(name, []);
    }
    this.metrics.get(name)!.push(duration);
  }
  
  getAverageResponseTime(name: string): number {
    const times = this.metrics.get(name) || [];
    return times.reduce((sum, time) => sum + time, 0) / times.length;
  }
}
```

## 6. Action（行动计划）

### 6.1 已完成接口
- ✅ 基础聊天接口（同步/异步）
- ✅ 流式输出事件处理
- ✅ 对话CRUD操作
- ✅ 模型管理接口
- ✅ 服务器配置接口
- ✅ 系统提示词接口

### 6.2 接口优化计划
- 🔄 接口响应缓存机制
- 🔄 批量操作接口
- 🔄 接口版本管理
- 🔄 API文档自动生成

### 6.3 扩展接口计划
- 📅 文件上传下载接口
- 📅 语音消息处理接口
- 📅 多媒体内容支持
- 📅 实时协作接口