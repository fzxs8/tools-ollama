# ChatManager APIæ¥å£è®¾è®¡

## 1. Architectureï¼ˆæ¶æ„è®¾è®¡ï¼‰

### 1.1 APIæ¶æ„æ¦‚è¿°
ChatManager é‡‡ç”¨ Wails v2 æ¡†æ¶ï¼Œé€šè¿‡ Go åç«¯æä¾› API æ¥å£ï¼Œå‰ç«¯ Vue ç»„ä»¶é€šè¿‡ç”Ÿæˆçš„ç»‘å®šå‡½æ•°è°ƒç”¨åç«¯æœåŠ¡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Vue Frontend  â”‚â”€â”€â”€â–¶â”‚  Wails Binding  â”‚â”€â”€â”€â–¶â”‚   Go Backend    â”‚
â”‚   (TypeScript)  â”‚    â”‚   (Generated)   â”‚    â”‚   (App Struct)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI Components â”‚    â”‚  Runtime Events â”‚    â”‚  Business Logic â”‚
â”‚   (Chat, Input) â”‚    â”‚  (Streaming)    â”‚    â”‚  (ChatManager)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¥å£åˆ†ç±»
- **èŠå¤©æ¥å£**: æ¶ˆæ¯å‘é€ã€æµå¼è¾“å‡ºã€æ¨¡å‹è°ƒç”¨
- **å¯¹è¯ç®¡ç†**: å¯¹è¯CRUDæ“ä½œã€å†å²è®°å½•ç®¡ç†
- **æ¨¡å‹ç®¡ç†**: æ¨¡å‹åˆ—è¡¨ã€å‚æ•°é…ç½®ã€çŠ¶æ€ç®¡ç†
- **é…ç½®æ¥å£**: æœåŠ¡å™¨é…ç½®ã€ç³»ç»Ÿè®¾ç½®
- **äº‹ä»¶æ¥å£**: å®æ—¶é€šä¿¡ã€çŠ¶æ€åŒæ­¥

## 2. Analysisï¼ˆæ¥å£åˆ†æï¼‰

### 2.1 æ¥å£è°ƒç”¨æ¨¡å¼
- **åŒæ­¥è°ƒç”¨**: é…ç½®è·å–ã€æ•°æ®æŸ¥è¯¢ç±»æ¥å£
- **å¼‚æ­¥è°ƒç”¨**: æ¶ˆæ¯å‘é€ã€æ–‡ä»¶æ“ä½œç±»æ¥å£
- **äº‹ä»¶é©±åŠ¨**: æµå¼è¾“å‡ºã€çŠ¶æ€å˜æ›´é€šçŸ¥
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯è¿”å›å’Œå¤„ç†æœºåˆ¶

### 2.2 æ•°æ®ä¼ è¾“æ ¼å¼
- **è¯·æ±‚æ ¼å¼**: JSONåºåˆ—åŒ–çš„Goç»“æ„ä½“
- **å“åº”æ ¼å¼**: Goç»“æ„ä½“è‡ªåŠ¨è½¬æ¢ä¸ºTypeScriptç±»å‹
- **äº‹ä»¶æ ¼å¼**: é€šè¿‡Wails Runtime Eventsä¼ è¾“
- **é”™è¯¯æ ¼å¼**: æ ‡å‡†çš„Go errorç±»å‹

## 3. Architectureï¼ˆæ¥å£å®šä¹‰ï¼‰

### 3.1 èŠå¤©ç›¸å…³æ¥å£

#### 3.1.1 å‘é€èŠå¤©æ¶ˆæ¯
```go
// ChatMessage å‘é€èŠå¤©æ¶ˆæ¯åˆ°AIæ¨¡å‹
func (a *App) ChatMessage(modelName string, messages []types.Message, stream bool) (string, error)
```

**å‚æ•°è¯´æ˜**:
- `modelName`: ç›®æ ‡AIæ¨¡å‹åç§°
- `messages`: æ¶ˆæ¯å†å²åˆ—è¡¨
- `stream`: æ˜¯å¦ä½¿ç”¨æµå¼è¾“å‡º

**è¿”å›å€¼**:
- `string`: é˜»å¡æ¨¡å¼ä¸‹è¿”å›å®Œæ•´å“åº”ï¼Œæµå¼æ¨¡å¼è¿”å›ç©ºå­—ç¬¦ä¸²
- `error`: é”™è¯¯ä¿¡æ¯

**å‰ç«¯è°ƒç”¨ç¤ºä¾‹**:
```typescript
// é˜»å¡å¼è°ƒç”¨
const response = await ChatMessage(selectedModel.value, messagesWithSystemPrompt, false);

// æµå¼è°ƒç”¨
await ChatMessage(selectedModel.value, messagesWithSystemPrompt, true);
// é€šè¿‡äº‹ä»¶ç›‘å¬æ¥æ”¶æµå¼æ•°æ®
EventsOn("chat_stream_chunk", (data: string) => {
  // å¤„ç†æµå¼æ•°æ®ç‰‡æ®µ
});
```

#### 3.1.2 æµå¼è¾“å‡ºäº‹ä»¶

**äº‹ä»¶åç§°**: `chat_stream_chunk`
**äº‹ä»¶æ•°æ®**: `string` - æ¶ˆæ¯å†…å®¹ç‰‡æ®µ
```typescript
EventsOn("chat_stream_chunk", (data: string) => {
  const lastMessageIndex = messages.value.length - 1;
  if (lastMessageIndex >= 0 && messages.value[lastMessageIndex].role === 'assistant') {
    messages.value[lastMessageIndex].content += data;
  }
});
```

**äº‹ä»¶åç§°**: `chat_stream_done`
**äº‹ä»¶æ•°æ®**: æ— 
```typescript
EventsOn("chat_stream_done", () => {
  isThinking.value = false;
  scrollToBottom();
});
```

**äº‹ä»¶åç§°**: `chat_stream_error`
**äº‹ä»¶æ•°æ®**: `string` - é”™è¯¯ä¿¡æ¯
```typescript
EventsOn("chat_stream_error", (error: string) => {
  isThinking.value = false;
  // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
});
```

### 3.2 å¯¹è¯ç®¡ç†æ¥å£

#### 3.2.1 è·å–å¯¹è¯åˆ—è¡¨
```go
func (a *App) ListConversations() ([]*types.Conversation, error)
```

**è¿”å›å€¼**:
- `[]*types.Conversation`: å¯¹è¯åˆ—è¡¨ï¼ŒæŒ‰æ—¶é—´å€’åºæ’åˆ—
- `error`: é”™è¯¯ä¿¡æ¯

**å‰ç«¯è°ƒç”¨**:
```typescript
const conversations = await ListConversations();
```

#### 3.2.2 ä¿å­˜å¯¹è¯
```go
func (a *App) SaveConversation(conv *types.Conversation) (*types.Conversation, error)
```

**å‚æ•°è¯´æ˜**:
- `conv`: å¯¹è¯å¯¹è±¡ï¼Œå¦‚æœIDä¸ºç©ºåˆ™åˆ›å»ºæ–°å¯¹è¯

**è¿”å›å€¼**:
- `*types.Conversation`: ä¿å­˜åçš„å¯¹è¯å¯¹è±¡ï¼ˆåŒ…å«ç”Ÿæˆçš„IDï¼‰
- `error`: é”™è¯¯ä¿¡æ¯

**å‰ç«¯è°ƒç”¨**:
```typescript
const savedConversation = await SaveConversation({
  messages: messages.value,
  modelName: selectedModel.value,
  title: conversationTitle,
  timestamp: Date.now()
});
```

#### 3.2.3 è·å–å•ä¸ªå¯¹è¯
```go
func (a *App) GetConversation(id string) (*types.Conversation, error)
```

**å‚æ•°è¯´æ˜**:
- `id`: å¯¹è¯å”¯ä¸€æ ‡è¯†ç¬¦

**è¿”å›å€¼**:
- `*types.Conversation`: å¯¹è¯è¯¦ç»†ä¿¡æ¯
- `error`: é”™è¯¯ä¿¡æ¯

#### 3.2.4 åˆ é™¤å¯¹è¯
```go
func (a *App) DeleteConversation(id string) error
```

**å‚æ•°è¯´æ˜**:
- `id`: è¦åˆ é™¤çš„å¯¹è¯ID

**è¿”å›å€¼**:
- `error`: é”™è¯¯ä¿¡æ¯

### 3.3 æ¨¡å‹ç®¡ç†æ¥å£

#### 3.3.1 è·å–æ¨¡å‹åˆ—è¡¨
```go
func (a *App) ListModelsByServer(serverID string) ([]types.Model, error)
```

**å‚æ•°è¯´æ˜**:
- `serverID`: æœåŠ¡å™¨ID

**è¿”å›å€¼**:
- `[]types.Model`: æ¨¡å‹åˆ—è¡¨
- `error`: é”™è¯¯ä¿¡æ¯

#### 3.3.2 è¿è¡Œæ¨¡å‹
```go
func (a *App) RunModel(modelName string, params map[string]interface{}) error
```

**å‚æ•°è¯´æ˜**:
- `modelName`: æ¨¡å‹åç§°
- `params`: æ¨¡å‹å‚æ•°é…ç½®

#### 3.3.3 åœæ­¢æ¨¡å‹
```go
func (a *App) StopModel(modelName string) error
```

#### 3.3.4 æµ‹è¯•æ¨¡å‹
```go
func (a *App) TestModel(modelName string, prompt string) (string, error)
```

**å‚æ•°è¯´æ˜**:
- `modelName`: æ¨¡å‹åç§°
- `prompt`: æµ‹è¯•æç¤ºè¯

**è¿”å›å€¼**:
- `string`: æ¨¡å‹å“åº”å†…å®¹
- `error`: é”™è¯¯ä¿¡æ¯

### 3.4 æœåŠ¡å™¨é…ç½®æ¥å£

#### 3.4.1 è·å–æœåŠ¡å™¨åˆ—è¡¨
```go
func (a *App) GetServers() ([]types.OllamaServerConfig, error)
```

#### 3.4.2 è·å–æ´»åŠ¨æœåŠ¡å™¨
```go
func (a *App) GetActiveServer() (*types.OllamaServerConfig, error)
```

#### 3.4.3 è®¾ç½®æ´»åŠ¨æœåŠ¡å™¨
```go
func (a *App) SetActiveServer(serverID string) error
```

#### 3.4.4 æµ‹è¯•æœåŠ¡å™¨è¿æ¥
```go
func (a *App) TestOllamaServer(baseURL string) (string, error)
```

### 3.5 ç³»ç»Ÿæç¤ºè¯æ¥å£

#### 3.5.1 è·å–æç¤ºè¯åˆ—è¡¨
```go
func (a *App) ListPrompts() ([]types.Prompt, error)
```

#### 3.5.2 è·å–å•ä¸ªæç¤ºè¯
```go
func (a *App) GetPrompt(id string) (types.Prompt, error)
```

## 4. Applicationï¼ˆåº”ç”¨å®ç°ï¼‰

### 4.1 é”™è¯¯å¤„ç†æœºåˆ¶

#### 4.1.1 ç»Ÿä¸€é”™è¯¯å¤„ç†
```typescript
async function handleApiCall<T>(apiCall: () => Promise<T>): Promise<T | null> {
  try {
    return await apiCall();
  } catch (error) {
    console.error('APIè°ƒç”¨å¤±è´¥:', error);
    ElMessage.error(`æ“ä½œå¤±è´¥: ${(error as Error).message}`);
    return null;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const conversations = await handleApiCall(() => ListConversations());
if (conversations) {
  // å¤„ç†æˆåŠŸç»“æœ
}
```

#### 4.1.2 ç‰¹å®šé”™è¯¯å¤„ç†
```typescript
async function sendMessageWithErrorHandling() {
  try {
    const result = await ChatMessage(selectedModel.value, messages, stream);
    // å¤„ç†æˆåŠŸç»“æœ
  } catch (error: any) {
    let errorMessage = t('chatManager.sorry');
    
    if (error && error.message) {
      errorMessage += ': ' + error.message;
    } else if (typeof error === 'string') {
      errorMessage += ': ' + error;
    }
    
    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    const lastMessageIndex = messages.value.length - 1;
    if (lastMessageIndex >= 0 && messages.value[lastMessageIndex].role === 'assistant') {
      messages.value[lastMessageIndex].content = errorMessage;
    }
  }
}
```

### 4.2 æ•°æ®è½¬æ¢å’ŒéªŒè¯

#### 4.2.1 æ¶ˆæ¯ç±»å‹è½¬æ¢
```typescript
// å‰ç«¯Messageè½¬æ¢ä¸ºåç«¯æœŸæœ›çš„æ ¼å¼
function prepareMessagesForAPI(messages: Message[]): Message[] {
  return messages.map(msg => ({
    role: msg.role,
    content: msg.content,
    timestamp: msg.timestamp || Date.now()
  }));
}
```

#### 4.2.2 å‚æ•°éªŒè¯
```typescript
function validateModelParams(params: ModelParams): boolean {
  return (
    params.temperature >= 0.1 && params.temperature <= 2.0 &&
    params.topP >= 0.1 && params.topP <= 1.0 &&
    params.topK >= 1 && params.topK <= 100 &&
    params.context >= 512 && params.context <= 4096 &&
    params.numPredict >= 128 && params.numPredict <= 2048 &&
    params.repeatPenalty >= 0.5 && params.repeatPenalty <= 2.0
  );
}
```

### 4.3 ç¼“å­˜å’Œæ€§èƒ½ä¼˜åŒ–

#### 4.3.1 æ¥å£ç¼“å­˜ç­–ç•¥
```typescript
class APICache {
  private cache = new Map<string, { data: any; timestamp: number }>();
  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é’Ÿ

  async getCachedOrFetch<T>(
    key: string,
    fetcher: () => Promise<T>
  ): Promise<T> {
    const cached = this.cache.get(key);
    const now = Date.now();
    
    if (cached && (now - cached.timestamp) < this.CACHE_DURATION) {
      return cached.data;
    }
    
    const data = await fetcher();
    this.cache.set(key, { data, timestamp: now });
    return data;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const apiCache = new APICache();
const models = await apiCache.getCachedOrFetch(
  `models-${selectedServer.value}`,
  () => ListModelsByServer(selectedServer.value)
);
```

#### 4.3.2 æ‰¹é‡æ“ä½œä¼˜åŒ–
```typescript
// æ‰¹é‡åŠ è½½åˆå§‹æ•°æ®
async function loadInitialData() {
  const [servers, prompts, conversations] = await Promise.all([
    GetServers(),
    ListPrompts(),
    ListConversations()
  ]);
  
  // æ›´æ–°çŠ¶æ€
  availableServers.value = servers;
  systemPromptList.value = prompts;
  conversations.value = conversations;
}
```

## 5. Assuranceï¼ˆè´¨é‡ä¿è¯ï¼‰

### 5.1 æ¥å£æµ‹è¯•

#### 5.1.1 å•å…ƒæµ‹è¯•ç¤ºä¾‹
```typescript
describe('ChatManager API', () => {
  test('should send message successfully', async () => {
    const mockMessages = [
      { role: 'user', content: 'Hello', timestamp: Date.now() }
    ];
    
    const result = await ChatMessage('test-model', mockMessages, false);
    expect(result).toBeDefined();
    expect(typeof result).toBe('string');
  });
  
  test('should handle API errors gracefully', async () => {
    try {
      await ChatMessage('', [], false);
    } catch (error) {
      expect(error).toBeDefined();
    }
  });
});
```

#### 5.1.2 é›†æˆæµ‹è¯•
```typescript
describe('ChatManager Integration', () => {
  test('complete chat flow', async () => {
    // 1. åŠ è½½æœåŠ¡å™¨åˆ—è¡¨
    const servers = await GetServers();
    expect(servers.length).toBeGreaterThan(0);
    
    // 2. è®¾ç½®æ´»åŠ¨æœåŠ¡å™¨
    await SetActiveServer(servers[0].id);
    
    // 3. è·å–æ¨¡å‹åˆ—è¡¨
    const models = await ListModelsByServer(servers[0].id);
    expect(models.length).toBeGreaterThan(0);
    
    // 4. å‘é€æ¶ˆæ¯
    const response = await ChatMessage(models[0].name, [
      { role: 'user', content: 'test', timestamp: Date.now() }
    ], false);
    expect(response).toBeDefined();
  });
});
```

### 5.2 æ€§èƒ½ç›‘æ§

#### 5.2.1 APIå“åº”æ—¶é—´ç›‘æ§
```typescript
class APIMonitor {
  private metrics = new Map<string, number[]>();
  
  async measureAPI<T>(name: string, apiCall: () => Promise<T>): Promise<T> {
    const startTime = performance.now();
    try {
      const result = await apiCall();
      const duration = performance.now() - startTime;
      this.recordMetric(name, duration);
      return result;
    } catch (error) {
      const duration = performance.now() - startTime;
      this.recordMetric(`${name}_error`, duration);
      throw error;
    }
  }
  
  private recordMetric(name: string, duration: number) {
    if (!this.metrics.has(name)) {
      this.metrics.set(name, []);
    }
    this.metrics.get(name)!.push(duration);
  }
  
  getAverageResponseTime(name: string): number {
    const times = this.metrics.get(name) || [];
    return times.reduce((sum, time) => sum + time, 0) / times.length;
  }
}
```

## 6. Actionï¼ˆè¡ŒåŠ¨è®¡åˆ’ï¼‰

### 6.1 å·²å®Œæˆæ¥å£
- âœ… åŸºç¡€èŠå¤©æ¥å£ï¼ˆåŒæ­¥/å¼‚æ­¥ï¼‰
- âœ… æµå¼è¾“å‡ºäº‹ä»¶å¤„ç†
- âœ… å¯¹è¯CRUDæ“ä½œ
- âœ… æ¨¡å‹ç®¡ç†æ¥å£
- âœ… æœåŠ¡å™¨é…ç½®æ¥å£
- âœ… ç³»ç»Ÿæç¤ºè¯æ¥å£

### 6.2 æ¥å£ä¼˜åŒ–è®¡åˆ’
- ğŸ”„ æ¥å£å“åº”ç¼“å­˜æœºåˆ¶
- ğŸ”„ æ‰¹é‡æ“ä½œæ¥å£
- ğŸ”„ æ¥å£ç‰ˆæœ¬ç®¡ç†
- ğŸ”„ APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ

### 6.3 æ‰©å±•æ¥å£è®¡åˆ’
- ğŸ“… æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æ¥å£
- ğŸ“… è¯­éŸ³æ¶ˆæ¯å¤„ç†æ¥å£
- ğŸ“… å¤šåª’ä½“å†…å®¹æ”¯æŒ
- ğŸ“… å®æ—¶åä½œæ¥å£