# ChatManager API接口

## 1. 对话管理接口

### 1.1 获取对话列表
`ListConversations() []Conversation`
- **功能描述**：获取所有已保存的对话列表。
- **返回值**：`Conversation` 对象数组。

### 1.2 保存对话
`SaveConversation(conversation Conversation) Conversation`
- **功能描述**：保存对话，如果对话ID已存在则更新，否则创建新对话。
- **请求参数**：`Conversation` 对象。
- **返回值**：保存后的 `Conversation` 对象。

### 1.3 获取对话
`GetConversation(id string) Conversation`
- **功能描述**：根据ID获取指定对话的完整内容。
- **请求参数**：对话ID `string`。
- **返回值**：`Conversation` 对象。

### 1.4 删除对话
`DeleteConversation(id string) error`
- **功能描述**：根据ID删除指定对话。
- **请求参数**：对话ID `string`。
- **返回值**：`error`，成功时为 `nil`。

## 2. 聊天接口

### 2.1 聊天消息
`ChatMessage(model string, messages []Message, stream bool) (string | stream, error)`
- **功能描述**：发送聊天消息并获取回复。
- **请求参数**：
  - `model`: 模型名称 `string`。
  - `messages`: 消息列表 `[]Message`。
  - `stream`: 是否使用流式传输 `bool`。
- **返回值**：
  - 阻塞模式：完整回复字符串。
  - 流式模式：通过 `chat_stream_chunk` 事件流式返回数据。
  - `error`: 错误信息。

## 3. [已重构] 提示词相关接口

- **[已重构]** `ChatManager` 不再包含独立的系统提示词管理接口。
- **[已重构]** 前端现在调用 `PromptPilot` 模块提供的 `ListPrompts()` 接口来获取可选的提示词列表。

## 4. 依赖的服务器与模型接口

`ChatManager` 依赖应用全局的接口来获取服务器和模型信息，这些接口由 `app.go` 提供。

### 4.1 获取模型列表
`ListModelsByServer(serverId string) ([]Model, error)`
- **功能描述**：根据服务器ID获取模型列表。

### 4.2 获取服务器列表
`GetServers() ([]OllamaServerConfig, error)`
- **功能描述**：获取所有已配置的服务列表。

### 4.3 获取活动服务器
`GetActiveServer() (OllamaServerConfig, error)`
- **功能描述**：获取当前激活的服务器配置。

## 5. 接口调用规范

### 5.1 错误处理规范
1. 所有接口都应有明确的 `error` 返回。
2. 错误信息应包含具体的错误原因。
3. 前端应统一处理错误信息，并通过 `ElMessage` 等方式提示用户。
4. 记录关键错误日志便于调试。

### 5.2 数据传输规范
1. 使用JSON格式进行数据传输。
2. 时间戳使用Unix毫秒时间戳格式。
3. 字符串数据应进行适当的转义处理。
4. 大数据传输应考虑分页或流式处理。

### 5.3 安全规范
1. 敏感信息（如API密钥）不应在日志中明文记录。
2. 接口调用应有适当的权限验证。
3. 数据传输应考虑加密处理。
4. 防止注入攻击和XSS攻击。

- **功能描述**：获取所有已保存的对话列表
- **请求方法**：GET
- **请求参数**：无
- **返回值**：对话列表
- **错误处理**：返回空列表并记录错误日志

### 1;2 保存对话
```
SaveConversation(conversation Conversation) Conversation
```
- **功能描述**：保存对话，如果对话ID已存在则更新，否则创建新对话
- **请求方法**：POST
- **请求参数**：对话对象
- **返回值**：保存后的对话对象
- **处理逻辑**：
  1. 验证对话对象数据完整性
  2. 生成对话ID（新对话）
  3. 设置时间戳
  4. 序列化对话对象
  5. 保存到duolasdk存储
  6. 返回保存结果

### 1.3 获取对话
```
GetConversation(id string) Conversation
```
- **功能描述**：根据ID获取指定对话
- **请求方法**：GET
- **请求参数**：对话ID
- **返回值**：对话对象
- **错误处理**：对话不存在时返回错误

### 1.4 删除对话
```
DeleteConversation(id string) error
```
- **功能描述**：根据ID删除指定对话
- **请求方法**：DELETE
- **请求参数**：对话ID
- **返回值**：错误信息（如果有的话）
- **处理逻辑**：
  1. 验证对话ID有效性
  2. 从存储中删除对话
  3. 返回操作结果

## 2. 聊天接口

### 2.1 聊天消息
```
ChatMessage(model string, messages []Message, stream bool) (string | stream, error)
```
- **功能描述**：发送聊天消息并获取回复
- **请求方法**：POST
- **请求参数**：
  - model: 模型名称
  - messages: 消息列表
  - stream: 是否使用流式传输
- **返回值**：
  - 阻塞模式：完整回复字符串
  - 流式模式：流式数据
  - error: 错误信息
- **处理逻辑**：
  1. 验证参数有效性
  2. 构造AI请求
  3. 调用AI服务
  4. 处理响应数据
  5. 返回结果

## 3. 系统提示词接口

### 3.1 获取系统提示词列表
```
KVList(key string) (string, error)
```
- **功能描述**：获取系统提示词列表
- **请求方法**：GET
- **请求参数**：键名("system_prompts")
- **返回值**：JSON序列化的提示词列表
- **错误处理**：键不存在时返回空列表

### 3.2 保存系统提示词
```
KVSet(key string, value string) error
```
- **功能描述**：保存系统提示词
- **请求方法**：POST
- **请求参数**：
  - key: 键名
  - value: 值
- **返回值**：错误信息
- **处理逻辑**：
  1. 验证键值有效性
  2. 保存到存储
  3. 返回结果

### 3.3 获取激活的系统提示词
```
KVGet(key string) (string, error)
```
- **功能描述**：获取激活的系统提示词
- **请求方法**：GET
- **请求参数**：键名("active_system_prompt")
- **返回值**：JSON序列化的提示词对象
- **错误处理**：键不存在时返回空值

### 3.4 删除系统提示词
```
KVDelete(key string) error
```
- **功能描述**：删除系统提示词
- **请求方法**：DELETE
- **请求参数**：键名
- **返回值**：错误信息
- **处理逻辑**：
  1. 验证键名有效性
  2. 从存储中删除
  3. 返回结果

## 4. 服务器与模型接口

### 4.1 获取模型列表
```
ListModelsByServer(serverId string) ([]Model, error)
```
- **功能描述**：根据服务器ID获取模型列表
- **请求方法**：GET
- **请求参数**：服务器ID
- **返回值**：模型列表
- **错误处理**：服务器不可达时返回错误

### 4.2 获取远程服务器列表
```
GetRemoteServers() ([]Server, error)
```
- **功能描述**：获取配置的远程服务器列表
- **请求方法**：GET
- **请求参数**：无
- **返回值**：服务器列表
- **处理逻辑**：
  1. 从配置中读取服务器信息
  2. 返回服务器列表

### 4.3 获取Ollama服务器配置
```
GetOllamaServerConfig() (string, error)
```
- **功能描述**：获取本地Ollama服务器配置
- **请求方法**：GET
- **请求参数**：无
- **返回值**：服务器URL
- **错误处理**：配置不存在时返回默认值

### 4.4 获取激活的服务器
```
GetActiveServer() (Server, error)
```
- **功能描述**：获取当前激活的服务器
- **请求方法**：GET
- **请求参数**：无
- **返回值**：服务器对象
- **错误处理**：无激活服务器时返回默认本地服务器

## 5. 接口调用规范

### 5.1 错误处理规范
1. 所有接口都应有明确的错误返回
2. 错误信息应包含错误码和描述
3. 前端应统一处理错误信息
4. 记录关键错误日志便于调试

### 5.2 数据传输规范
1. 使用JSON格式进行数据传输
2. 时间戳使用Unix时间戳格式
3. 字符串数据应进行适当的转义处理
4. 大数据传输应考虑分页或流式处理

### 5.3 安全规范
1. 敏感信息（如API密钥）不应在日志中明文记录
2. 接口调用应有适当的权限验证
3. 数据传输应考虑加密处理
4. 防止注入攻击和XSS攻击