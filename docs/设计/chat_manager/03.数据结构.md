# ChatManager数据结构

## 1. 前端数据结构

### 概述
为了统一前端类型定义，提高代码可维护性和健壮性，ChatManager模块及其子组件中使用的主要数据结构已进行重构。现在，这些类型主要来源于 Wails 自动生成的 `../../wailsjs/go/models.ts` 文件，或从统一抽取的 `../../classes/types.ts` 文件中导入。这消除了前端重复的接口定义，确保了前后端数据模型的一致性。

### 1.1 对话结构 (Conversation)
该结构体现在直接从 Wails 自动生成的 `../../wailsjs/go/models.ts` 中导入。
其定义与后端 Go 语言的 `main.Conversation` 结构体保持一致。
```typescript
// 示例导入方式 (在 .vue 文件中):
import { types } from "../../wailsjs/go/models";
import Conversation = types.Conversation;
```

### 1.2 消息结构 (Message)
该结构体现在直接从 Wails 自动生成的 `../../wailsjs/go/models.ts` 中导入。
其定义与后端 Go 语言的 `main.Message` 结构体保持一致。
```typescript
// 示例导入方式 (在 .vue 文件中):
import { types } from "../../wailsjs/go/models";
import Message = types.Message;
```

### 1.3 模型结构 (Model)
该结构体现在直接从 Wails 自动生成的 `../../wailsjs/go/models.ts` 中导入。
其定义与后端 Go 语言的 `main.Model` 结构体保持一致。
```typescript
// 示例导入方式 (在 .vue 文件中):
import { types } from "../../wailsjs/go/models";
import Model = types.Model;
```

### 1.4 服务器配置结构 (OllamaServerConfig)
该结构体现在直接从 Wails 自动生成的 `../../wailsjs/go/models.ts` 中导入。
其定义与后端 Go 语言的 `main.OllamaServerConfig` 结构体保持一致。
```typescript
// 示例导入方式 (在 .vue 文件中):
import { types } from "../../wailsjs/go/models";
import OllamaServerConfig = types.OllamaServerConfig;
```

### 1.5 模型参数结构 (ModelParams)
该结构体已从各组件中抽取，统一在 `../../classes/types.ts` 中定义和导出。
```typescript
// 示例导入方式 (在 .vue 文件中):
import { ModelParams } from "../../classes/types";
```

### 1.6 提示词结构 (Prompt)
该结构体现在直接从 Wails 自动生成的 `../../wailsjs/go/models.ts` 中导入。
其定义与后端 Go 语言的 `main.Prompt` 结构体保持一致。
```typescript
// 示例导入方式 (在 .vue 文件中):
import { types } from "../../wailsjs/go/models";
import Prompt = types.Prompt;
```

## 2. 后端数据结构

### 2.1 对话结构 (Conversation)
```go
type Conversation struct {
	ID          string    `json:"id"`           // 对话唯一标识符
	Title       string    `json:"title"`        // 对话标题
	Messages    []Message `json:"messages"`     // 消息列表
	ModelName   string    `json:"modelName"`    // 使用的模型名称
	SystemPrompt string   `json:"systemPrompt"` // [已重构] 应用的系统提示词 (main.Prompt 对象的 JSON 字符串)
	ModelParams string    `json:"modelParams"`  // 模型参数（JSON字符串）
	Timestamp   int64     `json:"timestamp"`    // 对话创建时间戳
}
```

### 2.2 消息结构 (Message)
```go
type Message struct {
	Role      string `json:"role"`      // 消息角色
	Content   string `json:"content"`   // 消息内容
	Timestamp int64  `json:"timestamp"` // 消息时间戳
}
```

## 3. 存储设计

### 3.1 对话存储
- 使用duolasdk的哈希存储功能。
- 存储键名：`"conversations"`
- 字段为对话ID，值为JSON序列化的对话对象。

### 3.2 [已废弃] 系统提示词存储
- **[已重构]** `ChatManager` 不再独立管理系统提示词的存储。
- **[已重构]** 所有提示词由 `PromptPilot` 模块统一存储在哈希表 `"prompts"` 中。

### 3.3 模型参数存储
- 使用duolasdk的键值存储功能。
- 存储键名：`"model_params_{model_name}"`，值为JSON序列化的模型参数。

## 4. 数据交互规范

### 4.1 对话数据流
1. 前端创建或更新对话对象。
2. 通过JSON序列化发送到后端。
3. 后端接收并验证数据。
4. 后端保存到duolasdk存储中。
5. 返回操作结果给前端。

### 4.2 消息数据处理
1. 消息在发送时添加时间戳。
2. 消息内容在传输过程中保持原样。
3. 系统消息（来自 `PromptPilot` 的提示词）在需要时动态添加到请求的最前端。
4. 所有消息按顺序存储和加载。

### 4.3 存储一致性保证
1. 对话数据在每次更新后立即持久化。
2. 使用事务机制确保数据一致性（由底层duolasdk保证）。
3. 提供数据校验机制防止损坏数据。
4. 支持数据恢复机制应对异常情况。
