# ChatManager æ•°æ®ç»“æ„è®¾è®¡

## 1. Architectureï¼ˆæ¶æ„è®¾è®¡ï¼‰

### 1.1 æ•°æ®æµæ¶æ„
ChatManager é‡‡ç”¨å•å‘æ•°æ®æµæ¶æ„ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯é¢„æµ‹æ€§ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯UI    â”‚â”€â”€â”€â–¶â”‚  Vue Store  â”‚â”€â”€â”€â–¶â”‚  åç«¯API    â”‚
â”‚  (Vueç»„ä»¶)  â”‚    â”‚ (Reactive)  â”‚    â”‚ (Go/Wails)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²                   â”‚                   â”‚
       â”‚                   â–¼                   â–¼
       â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  äº‹ä»¶ç³»ç»Ÿ   â”‚    â”‚  æ•°æ®æŒä¹…åŒ– â”‚
                    â”‚ (EventBus)  â”‚    â”‚ (SQLite)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®å±‚æ¬¡ç»“æ„
```
ChatManager æ•°æ®å±‚
â”œâ”€â”€ ä¼šè¯çŠ¶æ€ (Session State)
â”œâ”€â”€ æ¶ˆæ¯æ•°æ® (Message Data)
â”œâ”€â”€ æ¨¡å‹é…ç½® (Model Config)
â”œâ”€â”€ æœåŠ¡å™¨é…ç½® (Server Config)
â””â”€â”€ ç”¨æˆ·åå¥½ (User Preferences)
```

## 2. Analysisï¼ˆæ•°æ®åˆ†æï¼‰

### 2.1 æ•°æ®ç±»å‹åˆ†æ
- **å®æ—¶æ•°æ®**: å½“å‰ä¼šè¯æ¶ˆæ¯ã€æ¨¡å‹çŠ¶æ€ã€è¾“å…¥å†…å®¹
- **æŒä¹…åŒ–æ•°æ®**: å¯¹è¯å†å²ã€æ¨¡å‹å‚æ•°ã€ç³»ç»Ÿé…ç½®
- **ä¸´æ—¶æ•°æ®**: UIçŠ¶æ€ã€åŠ è½½çŠ¶æ€ã€é”™è¯¯ä¿¡æ¯
- **é…ç½®æ•°æ®**: æœåŠ¡å™¨åˆ—è¡¨ã€æ¨¡å‹åˆ—è¡¨ã€ç³»ç»Ÿæç¤ºè¯

### 2.2 æ•°æ®å…³ç³»åˆ†æ
```mermaid
erDiagram
    Conversation ||--o{ Message : contains
    Conversation }o--|| Model : uses
    Conversation }o--o| SystemPrompt : applies
    Server ||--o{ Model : hosts
    User ||--o{ Conversation : creates
```

## 3. Architectureï¼ˆæ•°æ®ç»“æ„å®šä¹‰ï¼‰

### 3.1 æ ¸å¿ƒæ•°æ®ç»“æ„

#### 3.1.1 æ¶ˆæ¯ç»“æ„ (Message)
```typescript
interface Message {
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: number;
}
```

**å­—æ®µè¯´æ˜**:
- `role`: æ¶ˆæ¯è§’è‰²ï¼ŒåŒºåˆ†ç”¨æˆ·ã€åŠ©æ‰‹å’Œç³»ç»Ÿæ¶ˆæ¯
- `content`: æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒMarkdownæ ¼å¼
- `timestamp`: æ¶ˆæ¯æ—¶é—´æˆ³ï¼Œç”¨äºæ’åºå’Œæ˜¾ç¤º

**ä½¿ç”¨åœºæ™¯**:
- èŠå¤©ç•Œé¢æ¶ˆæ¯å±•ç¤º
- å¯¹è¯å†å²å­˜å‚¨
- APIè¯·æ±‚æ„å»º

#### 3.1.2 å¯¹è¯ç»“æ„ (Conversation)
```typescript
interface Conversation {
  id: string;                    // å”¯ä¸€æ ‡è¯†ç¬¦
  title: string;                 // å¯¹è¯æ ‡é¢˜
  messages: Message[];           // æ¶ˆæ¯åˆ—è¡¨
  modelName: string;             // ä½¿ç”¨çš„æ¨¡å‹åç§°
  systemPrompt?: string;         // ç³»ç»Ÿæç¤ºè¯(JSONå­—ç¬¦ä¸²)
  modelParams?: string;          // æ¨¡å‹å‚æ•°(JSONå­—ç¬¦ä¸²)
  timestamp: number;             // åˆ›å»º/æ›´æ–°æ—¶é—´
}
```

**å­—æ®µè¯´æ˜**:
- `id`: UUIDæ ¼å¼çš„å”¯ä¸€æ ‡è¯†ç¬¦
- `title`: è‡ªåŠ¨ç”Ÿæˆæˆ–ç”¨æˆ·è‡ªå®šä¹‰çš„æ ‡é¢˜
- `messages`: å®Œæ•´çš„æ¶ˆæ¯å†å²è®°å½•
- `modelName`: å…³è”çš„AIæ¨¡å‹åç§°
- `systemPrompt`: åºåˆ—åŒ–çš„ç³»ç»Ÿæç¤ºè¯å¯¹è±¡
- `modelParams`: åºåˆ—åŒ–çš„æ¨¡å‹å‚æ•°é…ç½®
- `timestamp`: æ¯«ç§’çº§æ—¶é—´æˆ³

#### 3.1.3 æ¨¡å‹å‚æ•°ç»“æ„ (ModelParams)
```typescript
interface ModelParams {
  temperature: number;           // æ¸©åº¦å‚æ•° (0.1-2.0)
  topP: number;                 // Top-På‚æ•° (0.1-1.0)
  topK: number;                 // Top-Kå‚æ•° (1-100)
  context: number;              // ä¸Šä¸‹æ–‡é•¿åº¦ (512-4096)
  numPredict: number;           // é¢„æµ‹é•¿åº¦ (128-2048)
  repeatPenalty: number;        // é‡å¤æƒ©ç½š (0.5-2.0)
  outputMode: 'stream' | 'blocking'; // è¾“å‡ºæ¨¡å¼
}
```

**é»˜è®¤å€¼é…ç½®**:
```typescript
const DEFAULT_MODEL_PARAMS: ModelParams = {
  temperature: 0.8,
  topP: 0.9,
  topK: 40,
  context: 2048,
  numPredict: 512,
  repeatPenalty: 1.1,
  outputMode: 'stream'
};
```

#### 3.1.4 æ¨¡å‹ç»“æ„ (Model)
```typescript
interface Model {
  name: string;                  // æ¨¡å‹åç§°
  model: string;                 // æ¨¡å‹æ ‡è¯†ç¬¦
  size: number;                  // æ¨¡å‹å¤§å°(å­—èŠ‚)
  modified_at: string;           // ä¿®æ”¹æ—¶é—´
  digest: string;                // æ¨¡å‹æ‘˜è¦
  details?: object;              // è¯¦ç»†ä¿¡æ¯
  isRunning?: boolean;           // è¿è¡ŒçŠ¶æ€
}
```

#### 3.1.5 æœåŠ¡å™¨é…ç½®ç»“æ„ (OllamaServerConfig)
```typescript
interface OllamaServerConfig {
  id: string;                    // æœåŠ¡å™¨ID
  name: string;                  // æœåŠ¡å™¨åç§°
  baseURL: string;               // æœåŠ¡å™¨åœ°å€
  isActive: boolean;             // æ˜¯å¦ä¸ºæ´»åŠ¨æœåŠ¡å™¨
  testStatus?: string;           // è¿æ¥æµ‹è¯•çŠ¶æ€
}
```

#### 3.1.6 ç³»ç»Ÿæç¤ºè¯ç»“æ„ (Prompt)
```typescript
interface Prompt {
  id: string;                    // æç¤ºè¯ID
  name: string;                  // æç¤ºè¯åç§°
  content: string;               // æç¤ºè¯å†…å®¹
  description?: string;          // æè¿°ä¿¡æ¯
  tags?: string[];               // æ ‡ç­¾åˆ—è¡¨
  createdAt: number;             // åˆ›å»ºæ—¶é—´
  updatedAt: number;             // æ›´æ–°æ—¶é—´
}
```

### 3.2 çŠ¶æ€ç®¡ç†ç»“æ„

#### 3.2.1 èŠå¤©çŠ¶æ€ (ChatState)
```typescript
interface ChatState {
  // å½“å‰ä¼šè¯
  messages: Message[];
  activeConversationId: string;
  currentConversation: Conversation | null;
  
  // æ¨¡å‹ç›¸å…³
  selectedModel: string;
  selectedServer: string;
  modelParams: ModelParams;
  localModels: Model[];
  availableServers: OllamaServerConfig[];
  
  // UIçŠ¶æ€
  isThinking: boolean;
  inputMessage: string;
  
  // ç³»ç»Ÿæç¤ºè¯
  activeSystemPrompt: Prompt | null;
  systemPromptList: Prompt[];
  
  // å¯¹è¯å†å²
  conversations: Conversation[];
}
```

#### 3.2.2 UIçŠ¶æ€ç»“æ„ (UIState)
```typescript
interface UIState {
  // æŠ½å±‰çŠ¶æ€
  systemPromptDrawerVisible: boolean;
  conversationHistoryVisible: boolean;
  
  // åŠ è½½çŠ¶æ€
  isLoadingModels: boolean;
  isLoadingConversations: boolean;
  isLoadingPrompts: boolean;
  
  // é”™è¯¯çŠ¶æ€
  lastError: string | null;
  errorTimestamp: number | null;
}
```

### 3.3 APIæ•°æ®ç»“æ„

#### 3.3.1 èŠå¤©è¯·æ±‚ç»“æ„
```typescript
interface ChatRequest {
  model: string;
  messages: Message[];
  stream: boolean;
  options?: {
    temperature?: number;
    top_p?: number;
    top_k?: number;
    num_ctx?: number;
    num_predict?: number;
    repeat_penalty?: number;
  };
}
```

#### 3.3.2 èŠå¤©å“åº”ç»“æ„
```typescript
// æµå¼å“åº”
interface ChatStreamResponse {
  message: {
    role: string;
    content: string;
  };
  done: boolean;
  error?: string;
}

// é˜»å¡å¼å“åº”
interface ChatBlockingResponse {
  message: {
    role: string;
    content: string;
  };
  done: boolean;
  total_duration?: number;
  load_duration?: number;
  prompt_eval_count?: number;
  eval_count?: number;
}
```

## 4. Applicationï¼ˆåº”ç”¨å®ç°ï¼‰

### 4.1 æ•°æ®è½¬æ¢å‡½æ•°

#### 4.1.1 æ¶ˆæ¯ç±»å‹è½¬æ¢
```typescript
// å‰ç«¯Messageè½¬åç«¯core.Message
function ToCoreMessages(messages: Message[]): core.Message[] {
  return messages.map(msg => ({
    Role: msg.role,
    Content: msg.content
  }));
}

// åç«¯å“åº”è½¬å‰ç«¯Message
function FromChatResponse(response: ChatStreamResponse): Message {
  return {
    role: response.message.role as 'assistant',
    content: response.message.content,
    timestamp: Date.now()
  };
}
```

#### 4.1.2 å‚æ•°åºåˆ—åŒ–
```typescript
// æ¨¡å‹å‚æ•°åºåˆ—åŒ–
function serializeModelParams(params: ModelParams): string {
  return JSON.stringify(params);
}

// æ¨¡å‹å‚æ•°ååºåˆ—åŒ–
function deserializeModelParams(paramsStr: string): ModelParams {
  try {
    return JSON.parse(paramsStr);
  } catch {
    return DEFAULT_MODEL_PARAMS;
  }
}
```

### 4.2 æ•°æ®éªŒè¯

#### 4.2.1 æ¶ˆæ¯éªŒè¯
```typescript
function validateMessage(message: Message): boolean {
  return !!(
    message.role &&
    ['user', 'assistant', 'system'].includes(message.role) &&
    message.content &&
    message.content.trim().length > 0 &&
    message.timestamp &&
    message.timestamp > 0
  );
}
```

#### 4.2.2 å¯¹è¯éªŒè¯
```typescript
function validateConversation(conversation: Conversation): boolean {
  return !!(
    conversation.id &&
    conversation.title &&
    conversation.messages &&
    Array.isArray(conversation.messages) &&
    conversation.messages.every(validateMessage) &&
    conversation.modelName &&
    conversation.timestamp
  );
}
```

### 4.3 æ•°æ®æŒä¹…åŒ–

#### 4.3.1 æœ¬åœ°å­˜å‚¨ç­–ç•¥
```typescript
// å¯¹è¯è‡ªåŠ¨ä¿å­˜
async function autoSaveConversation(conversation: Conversation): Promise<void> {
  try {
    const savedConv = await SaveConversation(conversation);
    // æ›´æ–°æœ¬åœ°çŠ¶æ€
    updateLocalConversation(savedConv);
  } catch (error) {
    console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
  }
}

// æ‰¹é‡åŠ è½½å¯¹è¯
async function loadAllConversations(): Promise<Conversation[]> {
  try {
    const conversations = await ListConversations();
    return conversations.sort((a, b) => b.timestamp - a.timestamp);
  } catch (error) {
    console.error('åŠ è½½å¯¹è¯å¤±è´¥:', error);
    return [];
  }
}
```

## 5. Assuranceï¼ˆè´¨é‡ä¿è¯ï¼‰

### 5.1 æ•°æ®ä¸€è‡´æ€§ä¿è¯

#### 5.1.1 çŠ¶æ€åŒæ­¥æœºåˆ¶
```typescript
// ç¡®ä¿å‰åç«¯çŠ¶æ€ä¸€è‡´
class StateManager {
  private state: ChatState;
  
  async syncWithBackend(): Promise<void> {
    // åŒæ­¥æœåŠ¡å™¨åˆ—è¡¨
    this.state.availableServers = await GetServers();
    
    // åŒæ­¥æ´»åŠ¨æœåŠ¡å™¨
    const activeServer = await GetActiveServer();
    this.state.selectedServer = activeServer?.id || '';
    
    // åŒæ­¥æ¨¡å‹åˆ—è¡¨
    if (this.state.selectedServer) {
      this.state.localModels = await ListModelsByServer(this.state.selectedServer);
    }
  }
}
```

#### 5.1.2 æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
```typescript
function ensureDataIntegrity(conversation: Conversation): Conversation {
  // ç¡®ä¿å¿…è¦å­—æ®µå­˜åœ¨
  if (!conversation.id) {
    conversation.id = generateUUID();
  }
  
  if (!conversation.timestamp) {
    conversation.timestamp = Date.now();
  }
  
  // è¿‡æ»¤æ— æ•ˆæ¶ˆæ¯
  conversation.messages = conversation.messages.filter(validateMessage);
  
  return conversation;
}
```

### 5.2 æ€§èƒ½ä¼˜åŒ–

#### 5.2.1 æ•°æ®ç¼“å­˜ç­–ç•¥
```typescript
class DataCache {
  private conversationCache = new Map<string, Conversation>();
  private modelCache = new Map<string, Model[]>();
  
  getCachedConversation(id: string): Conversation | null {
    return this.conversationCache.get(id) || null;
  }
  
  setCachedConversation(conversation: Conversation): void {
    this.conversationCache.set(conversation.id, conversation);
  }
}
```

#### 5.2.2 å†…å­˜ç®¡ç†
```typescript
// é™åˆ¶æ¶ˆæ¯å†å²é•¿åº¦
function trimMessageHistory(messages: Message[], maxLength: number = 1000): Message[] {
  if (messages.length <= maxLength) {
    return messages;
  }
  
  // ä¿ç•™æœ€æ–°çš„æ¶ˆæ¯
  return messages.slice(-maxLength);
}
```

## 6. Actionï¼ˆè¡ŒåŠ¨è®¡åˆ’ï¼‰

### 6.1 å·²å®Œæˆæ•°æ®ç»“æ„
- âœ… æ ¸å¿ƒæ¶ˆæ¯å’Œå¯¹è¯æ•°æ®ç»“æ„
- âœ… æ¨¡å‹å‚æ•°é…ç½®ç»“æ„
- âœ… çŠ¶æ€ç®¡ç†ç»“æ„
- âœ… APIè¯·æ±‚å“åº”ç»“æ„
- âœ… æ•°æ®éªŒè¯å’Œè½¬æ¢å‡½æ•°

### 6.2 ä¼˜åŒ–è®¡åˆ’
- ğŸ”„ æ•°æ®å‹ç¼©å’Œä¼˜åŒ–å­˜å‚¨
- ğŸ”„ å¢é‡åŒæ­¥æœºåˆ¶
- ğŸ”„ ç¦»çº¿æ•°æ®æ”¯æŒ
- ğŸ”„ æ•°æ®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½

### 6.3 æ‰©å±•è®¡åˆ’
- ğŸ“… å¤šåª’ä½“æ¶ˆæ¯æ”¯æŒ
- ğŸ“… æ¶ˆæ¯åŠ å¯†å­˜å‚¨
- ğŸ“… äº‘ç«¯åŒæ­¥æ”¯æŒ
- ğŸ“… æ•°æ®åˆ†æç»Ÿè®¡ç»“æ„