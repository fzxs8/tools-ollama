# ChatManager数据结构

## 1. 前端数据结构

### 1.1 对话结构 (Conversation)
```typescript
interface Conversation {
  id: string;           // 对话唯一标识符
  title: string;        // 对话标题
  messages: Message[];  // 消息列表
  modelName: string;    // 使用的模型名称
  systemPrompt: string; // [已重构] 应用的系统提示词 (main.Prompt 对象的 JSON 字符串)
  modelParams: string;  // 模型参数（JSON字符串）
  timestamp: number;    // 对话创建时间戳
}
```

### 1.2 消息结构 (Message)
```typescript
interface Message {
  role: 'user' | 'assistant' | 'system'; // 消息角色
  content: string;                       // 消息内容
  timestamp?: number;                    // 消息时间戳
}
```

### 1.3 [已废弃] 系统提示词结构 (SystemPrompt)
该结构体已被 `PromptPilot` 模块的 `main.Prompt` 结构体取代。

### 1.4 模型结构 (Model)
```typescript
interface Model {
  name: string;       // 模型名称
  size: number;       // 模型大小
  modifiedAt: string; // 修改时间
}
```

### 1.5 服务器结构 (Server)
```typescript
interface Server {
  id: string;         // 服务器ID
  name: string;       // 服务器名称
  baseUrl: string;    // 基础URL
  apiKey: string;     // API密钥
  isActive: boolean;  // 是否激活
  testStatus: string; // 测试状态
  type: string;       // 服务器类型
}
```

### 1.6 模型参数结构 (ModelParams)
```typescript
interface ModelParams {
  temperature: number;     // 温度参数
  topP: number;            // Top P参数
  context: number;         // 上下文大小
  numPredict: number;      // 预测数量
  topK: number;            // Top K参数
  repeatPenalty: number;   // 重复惩罚
  outputMode: 'stream' | 'blocking'; // 输出模式
}
```

## 2. 后端数据结构

### 2.1 对话结构 (Conversation)
```go
type Conversation struct {
	ID          string    `json:"id"`           // 对话唯一标识符
	Title       string    `json:"title"`        // 对话标题
	Messages    []Message `json:"messages"`     // 消息列表
	ModelName   string    `json:"modelName"`    // 使用的模型名称
	SystemPrompt string   `json:"systemPrompt"` // [已重构] 应用的系统提示词 (main.Prompt 对象的 JSON 字符串)
	ModelParams string    `json:"modelParams"`  // 模型参数（JSON字符串）
	Timestamp   int64     `json:"timestamp"`    // 对话创建时间戳
}
```

### 2.2 消息结构 (Message)
```go
type Message struct {
	Role      string `json:"role"`      // 消息角色
	Content   string `json:"content"`   // 消息内容
	Timestamp int64  `json:"timestamp"` // 消息时间戳
}
```

## 3. 存储设计

### 3.1 对话存储
- 使用duolasdk的哈希存储功能。
- 存储键名：`"conversations"`
- 字段为对话ID，值为JSON序列化的对话对象。

### 3.2 [已废弃] 系统提示词存储
- **[已重构]** `ChatManager` 不再独立管理系统提示词的存储。
- **[已重构]** 所有提示词由 `PromptPilot` 模块统一存储在哈希表 `"prompts"` 中。

### 3.3 模型参数存储
- 使用duolasdk的键值存储功能。
- 存储键名：`"model_params_{model_name}"`，值为JSON序列化的模型参数。

## 4. 数据交互规范

### 4.1 对话数据流
1. 前端创建或更新对话对象。
2. 通过JSON序列化发送到后端。
3. 后端接收并验证数据。
4. 后端保存到duolasdk存储中。
5. 返回操作结果给前端。

### 4.2 消息数据处理
1. 消息在发送时添加时间戳。
2. 消息内容在传输过程中保持原样。
3. 系统消息（来自 `PromptPilot` 的提示词）在需要时动态添加到请求的最前端。
4. 所有消息按顺序存储和加载。

### 4.3 存储一致性保证
1. 对话数据在每次更新后立即持久化。
2. 使用事务机制确保数据一致性（由底层duolasdk保证）。
3. 提供数据校验机制防止损坏数据。
4. 支持数据恢复机制应对异常情况。
