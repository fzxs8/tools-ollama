# ChatManager 页面功能需求

## 1. Architecture（架构设计）

### 1.1 页面概述
ChatManager 页面是 Ollama 聊天管理工具的核心功能模块，采用 Vue 3 + TypeScript + Element Plus 技术栈构建。主要用于与AI模型进行交互式对话，支持多模型切换、对话历史管理、系统提示词应用等功能。

### 1.2 技术架构
- **前端框架**: Vue 3 Composition API + TypeScript
- **UI组件库**: Element Plus
- **状态管理**: Vue 3 Reactive API
- **后端服务**: Go + Wails v2 + duolasdk
- **数据存储**: SQLite + 内存缓存
- **国际化**: Vue I18n
- **Markdown渲染**: MarkdownIt

### 1.3 核心组件
```
ChatManager 模块
├── ChatManager.vue (主组件)
├── components/
│   ├── ChatContainer.vue (聊天容器)
│   ├── ChatInput.vue (输入组件)
│   ├── ModelSelector.vue (模型选择器)
│   └── ConversationHistory.vue (对话历史)
├── chat_manager.go (后端服务)
├── model_manager.go (模型管理)
└── types.go (数据结构)
```

## 2. Analysis（需求分析）

### 2.1 用户群体分析
- **主要用户**: AI研究人员、开发者、内容创作者、学生
- **使用场景**: 代码生成、文档编写、问题解答、创意写作、学习辅助
- **核心需求**: 流畅对话、历史管理、多模型支持、个性化配置

### 2.2 功能需求优先级矩阵
| 优先级 | 功能模块 | 业务价值 | 实现复杂度 | 状态 |
|--------|----------|----------|------------|------|
| P0 | 基础聊天功能 | 高 | 中 | ✅ 已完成 |
| P0 | 模型选择切换 | 高 | 低 | ✅ 已完成 |
| P0 | 消息发送接收 | 高 | 中 | ✅ 已优化 |
| P1 | 对话历史管理 | 高 | 中 | ✅ 已优化 |
| P1 | 流式输出支持 | 中 | 高 | ✅ 已完成 |
| P1 | 系统提示词 | 中 | 低 | ✅ 已完成 |
| P2 | Markdown渲染 | 中 | 低 | ✅ 已完成 |
| P2 | 消息操作功能 | 低 | 低 | ✅ 已完成 |

## 3. Architecture（架构设计）

### 3.1 核心功能架构

#### 3.1.1 聊天界面设计

#### 页面布局
- **响应式设计**: 支持桌面端和移动端适配
- **双栏布局**: 左侧模型选择器，右侧聊天区域
- **渐变背景**: 现代化的紫蓝渐变主题
- **毛玻璃效果**: 半透明背景和模糊效果

#### 消息展示优化
- **用户消息**: 渐变背景（紫蓝色），右对齐，白色文字
- **助手消息**: 白色背景，左对齐，深色文字
- **消息宽度**: 最大95%宽度，提供充足显示空间
- **阴影效果**: 用户消息和助手消息都有优雅的阴影

#### 3.1.2 模型管理功能

#### 服务器选择
- 支持多个Ollama服务器切换
- 自动同步活动服务器状态
- 服务器切换时自动刷新模型列表

#### 模型选择器
- 下拉菜单展示可用模型
- 显示模型运行状态
- 支持模型参数配置（温度、TopP、上下文等）
- 输出模式选择（流式/阻塞式）

#### 3.1.3 消息处理系统

#### 消息发送流程
1. 用户输入验证（非空、模型已选择）
2. 添加用户消息到消息列表
3. 应用系统提示词（如果设置）
4. 根据输出模式选择处理方式
5. 调用后端API发送消息
6. 处理响应并更新界面

#### 流式输出处理
- **实时显示**: 通过事件监听实时接收消息片段
- **流畅体验**: 自动滚动到底部，保持对话连续性
- **错误处理**: 完善的错误捕获和用户提示
- **状态管理**: 思考状态指示器和完成状态处理

#### 3.1.4 对话历史管理

#### 对话存储
- 自动保存对话到本地数据库
- 支持对话标题自动生成和手动编辑
- 按时间倒序排列对话列表
- 包含模型信息和系统提示词

#### 对话操作
- **新建对话**: 清空当前对话，开始新的会话
- **加载对话**: 从历史记录中恢复对话内容
- **编辑标题**: 支持自定义对话标题
- **删除对话**: 单次确认删除，避免误操作

#### 3.1.5 系统提示词功能

#### 提示词管理
- 集成提示词工程模块的提示词列表
- 支持选择和应用系统提示词
- 提示词在每次对话中自动添加到消息开头
- 界面显示当前应用的提示词名称

#### 3.1.6 消息操作功能

#### 消息交互
- **复制消息**: 一键复制消息内容到剪贴板
- **重新生成**: 删除助手回复并重新请求
- **消息时间**: 显示消息发送时间
- **Markdown渲染**: 支持代码块、列表、链接等格式

#### 3.1.7 用户体验优化

#### 界面交互
- **键盘快捷键**: Enter发送，Shift+Enter换行
- **加载状态**: 思考指示器和加载动画
- **错误处理**: 友好的错误提示和恢复机制
- **响应式设计**: 移动端适配和触摸优化

## 4. Application（应用实现）

### 4.1 数据结构设计

#### 消息数据结构
```typescript
interface Message {
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: number;
}
```

#### 对话数据结构
```typescript
interface Conversation {
  id: string;
  title: string;
  messages: Message[];
  modelName: string;
  systemPrompt?: string;
  modelParams?: string;
  timestamp: number;
}
```

#### 模型参数结构
```typescript
interface ModelParams {
  temperature: number;
  topP: number;
  topK: number;
  context: number;
  numPredict: number;
  repeatPenalty: number;
  outputMode: 'stream' | 'blocking';
}
```

### 4.2 交互逻辑实现

#### 页面初始化流程
1. 加载可用服务器列表
2. 获取并设置活动服务器
3. 加载服务器对应的模型列表
4. 加载系统提示词列表
5. 加载对话历史记录
6. 设置事件监听器（流式输出、错误处理）

#### 消息发送流程
1. 验证输入内容和模型选择
2. 添加用户消息到界面
3. 构建完整消息列表（包含系统提示词）
4. 根据输出模式调用相应API
5. 处理响应并更新界面
6. 自动保存对话记录

#### 对话管理流程
1. **新建对话**: 重置消息列表，清空当前对话ID
2. **加载对话**: 获取对话详情，恢复消息和模型设置
3. **保存对话**: 自动生成标题，保存到数据库
4. **删除对话**: 确认后删除，如果是当前对话则新建

## 5. Assurance（质量保证）

### 5.1 用户体验保证

#### 界面响应性
- 消息发送后立即显示在界面
- 流式输出实时更新，无明显延迟
- 加载状态清晰，用户操作反馈及时

#### 错误处理
- 网络错误、API错误的友好提示
- 自动重试机制和错误恢复
- 用户操作的撤销和重做支持

### 5.2 数据一致性保证
- 前后端状态同步
- 对话数据的完整性检查
- 模型参数的有效性验证

### 5.3 性能保证
- 大量消息的虚拟滚动优化
- 图片和文件的懒加载
- 内存使用的合理控制

## 6. Action（行动计划）

### 6.1 已完成优化
- ✅ 消息样式美化（渐变背景、阴影效果）
- ✅ 对话删除bug修复（单次确认、正确按钮文案）
- ✅ 流式输出稳定性提升
- ✅ 系统提示词集成
- ✅ Markdown渲染支持
- ✅ 响应式设计优化

### 6.2 近期计划
- 🔄 消息搜索功能
- 🔄 对话导出功能
- 🔄 语音输入支持
- 🔄 图片上传和识别

### 6.3 长期规划
- 📅 多模态对话支持
- 📅 协作对话功能
- 📅 对话分析和统计
- 📅 插件系统支持