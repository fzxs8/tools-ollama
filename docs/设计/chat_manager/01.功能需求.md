# ChatManager 聊天管理器功能需求

## 模块概述

ChatManager 是一个负责处理与大语言模型聊天交互的核心模块。它提供统一的接口来管理不同AI提供者的聊天功能，包括阻塞式和流式聊天消息传输，以及相关的配置和状态管理。该模块还负责系统提示词的管理、键值对存储操作等功能。

## 核心功能

### 1. 聊天消息管理

#### 阻塞式聊天
- 发送聊天消息并等待完整响应
- 支持系统提示词的集成
- 返回完整的聊天响应内容
- 提供详细的错误处理和日志记录机制
- 支持Unicode字符安全处理

#### 流式聊天
- 发送聊天消息并逐步接收响应
- 实时更新用户界面
- 支持自定义回调处理
- 提供错误处理和恐慌恢复机制
- 确保回调函数的安全执行

### 2. AI提供者适配

#### 多提供者支持
- 支持多种AI服务提供者（如Ollama等）
- 统一的接口适配不同提供者
- 动态切换AI提供者
- 提供类型安全的适配器模式

#### 提供者管理
- 设置和获取当前AI提供者
- 验证提供者配置
- 管理提供者状态
- 提供详细的日志记录

### 3. 系统提示词管理

#### 提示词存储
- 支持系统提示词的增删改查操作
- 提供键值对存储接口
- 支持激活状态管理
- 实现持久化存储

#### 提示词处理
- 支持系统提示词与用户消息的集成
- 提供提示词验证机制
- 支持时间戳管理

### 4. 存储管理

#### 键值对操作
- 提供KVSet方法设置键值对（持久化存储）
- 提供KVGet方法获取键值对（持久化存储）
- 提供KVList方法获取键值对列表
- 提供KVDelete方法删除键值对

#### 数据持久化
- 使用持久化存储确保数据不丢失
- 支持键值对的生命周期管理
- 提供存储操作的错误处理

### 5. 日志和错误处理

#### 日志记录
- 详细的调试和错误日志
- 关键操作日志记录
- 性能和状态日志
- 支持Unicode字符安全日志输出

#### 错误处理
- 统一的错误处理机制
- 恐慌恢复处理
- 错误信息格式化
- 回调函数安全包装

## 数据结构

### 消息结构

```go
// Message 聊天消息结构
type Message struct {
    Role    string `json:"role"`    // 消息角色 (system/user/assistant)
    Content string `json:"content"` // 消息内容
}
```

### 系统提示词结构

```go
// ChatSystemPrompt 系统提示词结构
type ChatSystemPrompt struct {
    ID        string `json:"id"`        // 提示词ID
    Title     string `json:"title"`     // 提示词标题
    Prompt    string `json:"prompt"`    // 提示词内容
    CreatedAt int64  `json:"createdAt"` // 创建时间戳
}
```

### AI提供者接口

```go
type aiProvider interface {
    Chat(model string, messages []Message) (string, error)
    ChatStream(model string, messages []Message, callback func(string)) error
}
```

### 存储接口

```go
interface {
    Set(key, value string, persistent ...bool) error
    Get(key string, persistent ...bool) (string, error)
    Delete(key string, persistent ...bool) error
}
```

## 交互逻辑

### 聊天流程

#### 阻塞式聊天流程
1. 调用Chat方法发送消息
2. 验证AI提供者配置
3. 执行消息类型转换
4. 调用AI提供者获取完整响应
5. 处理响应结果或错误
6. 返回结果给调用方

#### 流式聊天流程
1. 调用ChatStream方法发送消息
2. 验证AI提供者配置
3. 执行消息类型转换
4. AI提供者逐步返回响应内容
5. 通过安全包装的回调函数处理每个响应块
6. 处理完成或错误状态

### 提供者管理流程
1. 创建AI提供者适配器
2. 设置ChatManager的AI提供者
3. 验证提供者配置
4. 使用提供者进行聊天操作

### 系统提示词管理流程
1. 通过KV接口存储和检索提示词
2. 管理激活状态
3. 提供增删改查功能
4. 确保数据持久化

## 状态管理

### 聊天状态
- 消息发送状态
- 响应接收状态
- 错误状态
- 加载状态

### 提供者状态
- 当前提供者引用
- 提供者配置状态
- 提供者连接状态

### 存储状态
- 键值对存储状态
- 持久化状态
- 数据一致性状态

## API 接口

### 核心方法

1. **Chat**
   ```go
   func (cm *ChatManager) Chat(modelName string, messages []Message) (string, error)
   ```
   - 发送阻塞式聊天消息
   - 返回完整响应内容
   - 提供错误处理和日志记录

2. **ChatStream**
   ```go
   func (cm *ChatManager) ChatStream(modelName string, messages []Message, callback func(string)) error
   ```
   - 发送流式聊天消息
   - 通过安全包装的回调处理响应
   - 提供错误处理和日志记录

3. **SetAIProvider**
   ```go
   func (cm *ChatManager) SetAIProvider(provider aiProvider)
   ```
   - 设置AI提供者
   - 验证提供者接口

4. **存储相关方法**
   ```go
   func (cm *ChatManager) KVSet(key, value string) error
   func (cm *ChatManager) KVGet(key string) (string, error)
   func (cm *ChatManager) KVList(key string) (string, error)
   func (cm *ChatManager) KVDelete(key string) error
   ```
   - 提供完整的键值对操作接口
   - 支持持久化存储

### 系统提示词方法
```go
func (cm *ChatManager) SaveSystemPrompt(prompt ChatSystemPrompt) error
func (cm *ChatManager) ListSystemPrompts() ([]ChatSystemPrompt, error)
func (cm *ChatManager) GetActiveSystemPrompt() (*ChatSystemPrompt, error)
func (cm *ChatManager) SetActiveSystemPrompt(prompt ChatSystemPrompt) error
func (cm *ChatManager) DeleteActiveSystemPrompt() error
```
- 提供系统提示词的完整管理功能

## 错误处理

### 网络错误
- 提供者连接失败
- 请求超时
- 网络不可达
- HTTP状态码错误

### 业务错误
- 模型不存在
- 参数验证失败
- 提供者配置错误
- 消息格式错误

### 系统错误
- 内存不足
- 系统资源耗尽
- 恐慌恢复
- Unicode字符处理错误

### 存储错误
- 存储读取失败
- 存储写入失败
- 键值对格式错误

## 用户体验要求

### 性能要求
- 响应时间应在合理范围内
- 流式传输应保持流畅
- 内存使用应优化
- 支持大量消息处理

### 可靠性要求
- 提供稳定的聊天服务
- 具备错误恢复能力
- 保证数据一致性
- 防止数据丢失

### 可维护性要求
- 代码结构清晰
- 接口设计合理
- 文档齐全
- 易于扩展

### 安全性要求
- 防止回调函数恐慌影响主程序
- Unicode字符安全处理
- 输入验证和过滤
- 日志信息安全性