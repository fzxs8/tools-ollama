# ChatManager模块

## 概述
ChatManager是多莉AI助手的核心聊天管理模块，提供完整的对话管理、消息处理和AI模型交互功能。

## 主要功能
1. **对话管理**：
   - 新建对话
   - 历史对话管理
   - 对话加载和自动保存
   - 对话编辑和删除

2. **聊天消息管理**：
   - 支持阻塞式和流式聊天
   - Markdown格式消息渲染
   - 消息复制和重新生成

3. **AI模型适配**：
   - 支持多种AI服务提供者
   - 模型参数配置和管理
   - 统一接口适配不同服务

4. **系统提示词管理**：
   - 提示词的增删改查
   - 激活特定提示词
   - 提示词模板示例

## 文档列表
- [功能需求](01.功能需求.md) - 详细描述模块功能需求
- [界面设计](02.界面设计.md) - 界面布局和组件设计
- [数据结构](03.数据结构.md) - 前后端数据结构定义
- [API接口](04.API接口.md) - 接口规范和调用方式
- [待办事项](06.待办事项.md) - 功能规划和改进计划

## 技术实现
- 前端：Vue3 + TypeScript + Element Plus
- 后端：Go + Wails框架
- 存储：duolasdk存储功能
- 通信：通过Wails桥接前后端交互

## 最新更新
- 实现了完整的对话管理功能
- 完成了组件化重构，提高代码可维护性
- 优化了用户界面交互体验
- **2025-09-12 更新**：
  - **Bug 修复**：
    - 修复了前端发送消息时未携带完整对话历史，导致 AI 无法获取上下文的问题。
    - 修复了流式传输消息因事件监听器过早移除而无法正常显示的问题。
  - **前端类型重构**：
    - 统一了前端 Vue 组件中的 TypeScript 类型定义，移除了重复的本地接口。
    - 直接使用 Wails 自动生成的 `wailsjs/go/models.ts` 中的类型，并抽取通用前端扩展类型到 `src/classes/types.ts`。

## 架构设计

### 前端架构
前端采用组件化设计，主要包含以下组件：

1. **主容器组件**：ChatManager.vue
   - 负责整体状态管理
   - 协调各子组件间通信
   - 处理核心业务逻辑

2. **模型选择组件**：ModelSelector.vue
   - 提供模型和服务选择功能
   - 管理模型参数设置

3. **聊天容器组件**：ChatContainer.vue
   - 展示聊天消息历史
   - 提供消息操作功能

4. **聊天输入组件**：ChatInput.vue
   - 处理用户消息输入
   - 提供发送功能

5. **系统提示词组件**：SystemPromptDrawer.vue
   - 管理系统提示词设置

6. **对话历史组件**：ConversationHistory.vue
   - 展示和管理对话历史

### 后端架构
后端基于ChatManager结构体实现，主要功能包括：

1. **对话管理**：
   - ListConversations: 获取对话列表
   - SaveConversation: 保存对话
   - GetConversation: 获取对话
   - DeleteConversation: 删除对话

2. **聊天处理**：
   - Chat: 阻塞式聊天
   - ChatStream: 流式聊天

3. **系统提示词管理**：
   - KVGet: 获取键值
   - KVSet: 设置键值
   - KVDelete: 删除键值
   - KVList: 列出键值

## 开发规范

### 代码规范
1. 遵循Vue和TypeScript最佳实践
2. 使用Element Plus组件库
3. 保持代码风格一致性
4. 添加必要的注释说明

### 测试规范
1. 关键业务逻辑需要单元测试
2. 组件需要进行功能测试
3. 接口需要进行集成测试

### 文档规范
1. 及时更新相关文档
2. 保持文档与代码同步
3. 提供清晰的使用说明

## 部署与维护

### 部署要求
1. 需要安装Wails开发环境
2. 需要配置相应的AI服务
3. 需要duolasdk运行环境

### 维护建议
1. 定期备份对话数据
2. 监控系统性能和错误日志
3. 及时更新依赖库版本
