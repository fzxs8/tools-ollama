# ChatManager 备忘录与待办事项

## 开发重点和注意事项 (必读)

本章节记录了在开发过程中遇到的关键问题和最终解决方案，作为后续迭代的重要参考。

### 1. 流式输出实现问题

- **问题**: 前后端函数签名不匹配或Go方法未等待goroutine完成，导致流式输出中断或无响应。
- **根源**: 
    1.  直接将JS回调函数作为Go方法参数，在Wails中可能存在兼容性问题，导致后端接收到`nil`。
    2.  Go主函数在启动流式请求的goroutine后立即返回，导致执行上下文被销毁，HTTP连接中断。
- **最终解决方案**:
    1.  **放弃回调函数传参**，改为标准的**Wails Events**事件驱动机制。
    2.  后端 `ChatMessage` 方法中，通过 `runtime.EventsEmit` 发送数据块，前端使用 `runtime.EventsOn` 监听。
    3.  在后端 `ChatMessage` 方法中使用 `channel`，确保主函数会**阻塞等待**，直到流式请求的goroutine完全结束后才返回，保证了连接的稳定。

### 2. CSS布局问题

- **问题**: 聊天气泡无法自适应内容宽度，或整体无法靠右对齐。
- **根源**: 滥用或错误地嵌套Flexbox布局，`flex: 1`属性的错误使用导致元素被过度拉伸。
- **最终解决方案**:
    1.  **采用经典的布局模式**: 对父容器（`.chat-history`）应用 `display: flex; flex-direction: column;`。
    2.  对子项（`.user-message`）应用 `align-self: flex-end;` 来实现靠右对齐。
    3.  对消息气泡本身使用 `width: fit-content;` 并移除 `flex: 1`，使其宽度能包裹内容。

### 3. 前后端数据同步问题

- **问题**: 前端无法加载已配置的服务器列表。
- **根源**: 前后端定义的数据结构JSON标签不一致（例如前端使用`baseUrl`，而后端Go结构体使用了`base_url`）。
- **解决方案**: 严格保持Go结构体中的 `json:"..."` 标签与前端TypeScript接口的字段名（或其预期的JSON键名）完全一致。

## 已完成事项
- [x] 实现模型选择和参数设置功能
- [x] 实现聊天消息的发送和显示功能
- [x] 实现Markdown格式消息渲染
- [x] 实现流式和阻塞式聊天功能
- [x] 实现系统提示词管理功能
- [x] 实现对话管理功能（新建、历史、加载、自动保存）
- [x] 实现对话的编辑标题和删除功能
- [x] 实现组件化代码结构优化

## 待办事项
- [ ] 优化对话列表的排序和搜索功能
  - 支持按时间、标题等字段排序
  - 添加搜索框，支持按标题或内容搜索对话
- [ ] 添加对话导出和导入功能
  - 支持将对话导出为JSON或Markdown格式
  - 支持从文件导入对话
- [ ] 实现对话标签和分类管理
  - 支持为对话添加标签
  - 支持按标签分类查看对话
- [ ] 添加更多系统提示词示例模板
  - 提供多种场景下的提示词模板
  - 支持用户自定义模板库
- [ ] 优化移动端适配和用户体验
  - 优化小屏幕设备上的布局
  - 提供更适合触屏操作的交互方式
- [ ] 添加聊天记录搜索功能
  - 支持在当前对话中搜索消息
  - 支持跨对话搜索消息
- [ ] 实现对话分享功能
  - 支持生成对话分享链接
  - 支持导出对话为图片或PDF

## 可能的改进点
- [ ] 考虑添加对话置顶功能
  - 允许用户将重要对话置顶显示
  - 提供置顶对话的快速访问
- [ ] 考虑实现对话归档功能
  - 支持将不常用的对话归档
  - 归档的对话不显示在主列表中
- [ ] 考虑添加批量删除对话功能
  - 支持选择多个对话进行批量操作
  - 提供按条件批量删除功能
- [ ] 考虑添加对话统计和分析功能
  - 统计对话数量、消息数量等信息
  - 提供使用情况分析报告

## 技术债务
- [ ] 优化组件间通信机制
  - 考虑使用状态管理库替代props/event方式
  - 简化复杂组件间的数据传递
- [ ] 完善单元测试覆盖
  - 为关键业务逻辑添加单元测试
  - 提高代码质量与稳定性
- [ ] 优化性能与内存使用
  - 对大量对话或消息的场景进行性能优化
  - 减少不必要的重新渲染
