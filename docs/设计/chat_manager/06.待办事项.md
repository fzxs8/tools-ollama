# ChatManager 备忘录与待办事项

## 近期重构与优化总结 (2025-09-12)

本次重构旨在解决组件冗余和逻辑不清的问题，使 `ChatManager` 页面更加健壮和易于维护。

- **[前端] 统一 `ModelSelector` 组件**:
  - **问题**: `ChatManager` 页面之前使用了一个位于其私有目录下的、功能陈旧的 `ModelSelector.vue` 组件副本，导致该页面无法享受到公共组件的更新和Bug修复。
  - **解决方案**: 删除了 `ChatManager` 私有的 `ModelSelector.vue` 组件，并修改 `ChatManager.vue` 直接引用位于 `views/PromptPilot/components/` 下的**公共 `ModelSelector` 组件**。

- **[前端] 简化页面逻辑**:
  - **问题**: `ChatManager.vue` 中包含了大量关于加载服务器列表、获取模型列表的冗余逻辑。
  - **解决方案**: 在切换到公共 `ModelSelector` 组件后，删除了 `ChatManager.vue` 中所有相关的 `loadAvailableServers`、`getModels` 等函数，将这些职责完全下放给 `ModelSelector` 子组件。父组件 `ChatManager.vue` 只需通过 `v-model` 绑定 `selectedServer` 和 `selectedModel` 即可，大大简化了页面代码。

- **[前端] 统一空状态处理**:
  - **问题**: 当没有可用服务时，页面会因尝试使用空的服务器ID请求模型而报错。
  - **解决方案**: 通过使用已修复的公共 `ModelSelector` 组件，现在当没有可用服务时，页面会和 `ModelManager` 一样，收到清晰的提示信息，并阻止后续错误的API调用。

## 开发重点和注意事项 (必读)

本章节记录了在开发过程中遇到的关键问题和最终解决方案，作为后续迭代的重要参考。

### 1. 流式输出实现问题

- **问题**: 前后端函数签名不匹配或Go方法未等待goroutine完成，导致流式输出中断或无响应。
- **根源**: 
    1.  直接将JS回调函数作为Go方法参数，在Wails中可能存在兼容性问题，导致后端接收到`nil`。
    2.  Go主函数在启动流式请求的goroutine后立即返回，导致执行上下文被销毁，HTTP连接中断。
- **最终解决方案**:
    1.  **放弃回调函数传参**，改为标准的**Wails Events**事件驱动机制。
    2.  后端 `ChatMessage` 方法中，通过 `runtime.EventsEmit` 发送数据块，前端使用 `runtime.EventsOn` 监听。
    3.  在后端 `ChatMessage` 方法中使用 `channel`，确保主函数会**阻塞等待**，直到流式请求的goroutine完全结束后才返回，保证了连接的稳定。

### 2. CSS布局问题

- **问题**: 聊天气泡无法自适应内容宽度，或整体无法靠右对齐。
- **根源**: 滥用或错误地嵌套Flexbox布局，`flex: 1`属性的错误使用导致元素被过度拉伸。
- **最终解决方案**:
    1.  **采用经典的布局模式**: 对父容器（`.chat-history`）应用 `display: flex; flex-direction: column;`。
    2.  对子项（`.user-message`）应用 `align-self: flex-end;` 来实现靠右对齐。
    3.  对消息气泡本身使用 `width: fit-content;` 并移除 `flex: 1`，使其宽度能包裹内容。

### 3. 前后端数据同步问题

- **问题**: 前端无法加载已配置的服务器列表。
- **根源**: 前后端定义的数据结构JSON标签不一致（例如前端使用`baseUrl`，而后端Go结构体使用了`base_url`）。
- **解决方案**: 严格保持Go结构体中的 `json:"..."` 标签与前端TypeScript接口的字段名（或其预期的JSON键名）完全一致。

## 已完成事项
- [x] 实现模型选择和参数设置功能
- [x] 实现聊天消息的发送和显示功能
- [x] 实现Markdown格式消息渲染
- [x] 实现流式和阻塞式聊天功能
- [x] 实现系统提示词管理功能
- [x] 实现对话管理功能（新建、历史、加载、自动保存）
- [x] 实现对话的编辑标题和删除功能
- [x] 实现组件化代码结构优化

## 待办事项
- [ ] 优化对话列表的排序和搜索功能
  - 支持按时间、标题等字段排序
  - 添加搜索框，支持按标题或内容搜索对话
- [ ] 添加对话导出和导入功能
  - 支持将对话导出为JSON或Markdown格式
  - 支持从文件导入对话
- [ ] 实现对话标签和分类管理
  - 支持为对话添加标签
  - 支持按标签分类查看对话
- [ ] 添加更多系统提示词示例模板
  - 提供多种场景下的提示词模板
  - 支持用户自定义模板库
- [ ] 优化移动端适配和用户体验
  - 优化小屏幕设备上的布局
  - 提供更适合触屏操作的交互方式
- [ ] 添加聊天记录搜索功能
  - 支持在当前对话中搜索消息
  - 支持跨对话搜索消息
- [ ] 实现对话分享功能
  - 支持生成对话分享链接
  - 支持导出对话为图片或PDF