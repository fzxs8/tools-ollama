# ChatManager 备忘录与待办事项

## 开发重点和注意事项 (必读)

本章节记录了在开发过程中遇到的关键问题和最终解决方案，作为后续迭代的重要参考。

### 1. 流式输出实现问题

- **问题**: 前后端函数签名不匹配或Go方法未等待goroutine完成，导致流式输出中断或无响应。
- **根源**: 
    1.  直接将JS回调函数作为Go方法参数，在Wails中可能存在兼容性问题，导致后端接收到`nil`。
    2.  Go主函数在启动流式请求的goroutine后立即返回，导致执行上下文被销毁，HTTP连接中断。
- **最终解决方案**:
    1.  **放弃回调函数传参**，改为标准的**Wails Events**事件驱动机制。
    2.  后端 `ChatMessage` 方法中，通过 `runtime.EventsEmit` 发送数据块，前端使用 `runtime.EventsOn` 监听。
    3.  在后端 `ChatMessage` 方法中使用 `channel`，确保主函数会**阻塞等待**，直到流式请求的goroutine完全结束后才返回，保证了连接的稳定。

### 2. CSS布局问题

- **问题**: 聊天气泡无法自适应内容宽度，或整体无法靠右对齐。
- **根源**: 滥用或错误地嵌套Flexbox布局，`flex: 1`属性的错误使用导致元素被过度拉伸。
- **最终解决方案**:
    1.  **采用经典的布局模式**: 对父容器（`.chat-history`）应用 `display: flex; flex-direction: column;`。
    2.  对子项（`.user-message`）应用 `align-self: flex-end;` 来实现靠右对齐。
    3.  对消息气泡本身使用 `width: fit-content;` 并移除 `flex: 1`，使其宽度能包裹内容。

### 3. 前后端数据同步问题

- **问题**: 前端无法加载已配置的服务器列表。
- **根源**: 前后端定义的数据结构JSON标签不一致（例如前端使用`baseUrl`，而后端Go结构体使用了`base_url`）。
- **解决方案**: 严格保持Go结构体中的 `json:"..."` 标签与前端TypeScript接口的字段名（或其预期的JSON键名）完全一致。

## 待处理事项

### 功能完善
- [x] ~~实现聊天历史持久化存储~~ (已完成)
- [x] ~~增加聊天会话管理功能~~ (已完成)
- [ ] 自动生成对话标题（当前使用用户第一句话作为临时标题）。
- [ ] 在加载历史对话时，恢复当时所用的系统提示词和模型参数。
- [ ] 支持多种AI提供者（不仅仅是Ollama）。
- [ ] 实现消息编辑和删除功能。

### 界面优化
- [ ] 优化移动端适配。
- [ ] 增加暗色主题支持。
- [ ] 优化消息渲染性能（如虚拟滚动）。
- [ ] 增加消息搜索功能。

### 测试完善
- [ ] 编写前端组件单元测试。
- [ ] 编写后端接口单元测试。
- [ ] 编写集成测试用例。
