# 模型运行失败问题修复

## 问题描述
点击"运行模型"按钮时出现错误：
```
启动模型失败: undefined
```

后台日志显示：
```
Post "api/generate": unsupported protocol scheme ""
```

## 问题原因
1. **HTTP客户端未正确初始化**：`rebuildDependencies()` 函数为空，没有实现HTTP客户端的配置
2. **BaseURL缺少协议前缀**：服务器配置的BaseURL可能缺少 `http://` 或 `https://` 前缀
3. **活动服务器配置缺失**：应用启动时没有正确加载活动服务器配置

## 解决方案

### 1. 实现 rebuildDependencies 函数
在 `app.go` 中完善 `rebuildDependencies()` 函数：

```go
func (a *App) rebuildDependencies() error {
    a.logger.Debug("开始重建应用依赖")
    
    // 获取活动服务器配置
    activeServer, err := a.configMgr.GetActiveServer()
    if err != nil {
        a.logger.Warn("未找到活动服务器，使用默认配置", "error", err)
        // 如果没有活动服务器，创建一个默认的HTTP客户端
        a.httpClient.Create(&core.Config{
            BaseURL: "http://localhost:11434",
        })
        return nil
    }
    
    a.logger.Info("使用活动服务器配置初始化HTTP客户端", "serverName", activeServer.Name, "baseURL", activeServer.BaseURL)
    
    // 确保BaseURL包含协议前缀
    baseURL := activeServer.BaseURL
    if baseURL != "" && !strings.HasPrefix(baseURL, "http://") && !strings.HasPrefix(baseURL, "https://") {
        baseURL = "http://" + baseURL
        a.logger.Debug("为BaseURL添加http://前缀", "originalURL", activeServer.BaseURL, "newURL", baseURL)
    }
    
    // 重新配置HTTP客户端
    a.httpClient.Create(&core.Config{
        BaseURL: baseURL,
    })
    
    a.logger.Debug("HTTP客户端重建完成", "baseURL", baseURL)
    return nil
}
```

### 2. 添加必要的导入
在 `app.go` 中添加 `strings` 包导入：

```go
import (
    "context"
    "fmt"
    "net/http"
    "os"
    "strings"  // 新增
    "tools-ollama/types"
    // ...
)
```

## 修复效果
- HTTP客户端正确初始化，使用活动服务器的配置
- 自动为BaseURL添加协议前缀，避免"unsupported protocol scheme"错误
- 提供默认配置fallback，即使没有配置服务器也能正常工作
- 增强了日志记录，便于调试

## 测试验证
1. 确保至少配置了一个Ollama服务器
2. 设置该服务器为活动状态
3. 点击"运行模型"按钮
4. 检查后台日志确认HTTP请求正常发送

## 相关文件
- `app.go` - 主要修复文件
- `model_manager.go` - 模型管理逻辑
- `ollama_config.go` - 服务器配置管理

## 注意事项
- 确保Ollama服务器正在运行
- BaseURL格式应为 `host:port` 或 `http://host:port`
- 系统会自动为缺少协议前缀的URL添加 `http://`